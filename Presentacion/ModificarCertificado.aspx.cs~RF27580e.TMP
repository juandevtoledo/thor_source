using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Data;

public partial class Presentacion_ModificarCertificado : System.Web.UI.Page
{
    public PrecargueProduccion precargue = new PrecargueProduccion();

    //public static string poliza;
    //public static DataTable dt = new DataTable();
    //public static DataTable otrosAsegurados = new DataTable();
    //public static DataTable dtArchivo = new DataTable();
    //public static DataTable dtNovedades = new DataTable();
    //public static DataTable dtConyuge = new DataTable();
    //public static DataTable dtTemp;
    //public static DataTable dtTempOtrosAsegurados;
    //public static List<Asegurado> beneficiario = new List<Asegurado>();
    //public static List<Asegurado> beneficiarioConyuge = new List<Asegurado>();
    //public static int extraPrima = 0;
    //public static int extraPrimaConyuge = 0;
    //public static DataTable dtBeneficiario = new DataTable();
    //public static DataTable dtBeneficiarioConyuge = new DataTable();
    //public static DataTable dtEliminarPrincipal = new DataTable();
    //public static DataTable dtEliminarConyuge = new DataTable();
    //public static DataTable dtMesYAnio = new DataTable();
    //public static int cer_Id;
    //public static int primaOtroAsegurado = 0;
    //DataTable dtCertificadoFull = new DataTable();
    //DataTable dtOtroAsegurado = new DataTable();
    //DataTable dtEncabezadoCertificado = new DataTable(); //JC 22-09-2015
    //public static bool sePuedenHijosPMI = true;
    //public static string movimientoPrincipal;
    //public static string movimientoConyuge;
    //public static string movimientoOtrosAsegurados = "";
    //public static int tipoMovimientoDefinitivo = 0;
    //public static bool teniaConyuge;
    //public static bool teniaOtrosAsegurados = false;
    //public static int cer_Antiguo;
    //public static DataTable dtPeriodicidad = new DataTable();
    //public static DataTable dtArchivoPagaduria = new DataTable();
    
    protected void Page_Load(object sender, EventArgs e)
    {
        //Codigo para redireccionar al caducar la session*****************************JC
        Response.AddHeader("Refresh", Convert.ToString((Session.Timeout * 60) + 3));
        if (Session["usuario"] == null)
            Response.Redirect("~/login.aspx");
        //******************************************************************************

        AdministrarCertificados.usuarioSistema.NombreUsuario = Session["Usuario"].ToString();

        if (txtCedulaConyuge.Text != "")
        {
            btnValidarConyuge.Visible = true;
        }

        txtFechaExpedicionCertificado.Enabled = false;
        txtFechaVigenciaCertificado.Enabled = false;
        txtCertificado.Enabled = false;
        txtNombreAsesor.Enabled = false;
        txtAgencia.Enabled = false;
        txtPrima.Enabled = false;
        txtCedulaPrincipal.Enabled = false;
        txtNombrePrincipal.Enabled = false;
        txtApellidoPrincipal.Enabled = false;
        txtEdadPrincipal.Enabled = false;
        txtPagaduriaPrincipal.Enabled = false;
        txtPrimaPrincipal.Enabled = false;
        txtExtraPrimaPrincipal.Enabled = false;
        txtCedulaConyuge.Enabled = false;
        txtNombreConyuge.Enabled = false;
        txtApellidoConyuge.Enabled = false;
        txtEdadConyuge.Enabled = false;
        txtExtraPrimaConyuge.Enabled = false;
        txtPrimaConyuge.Enabled = false;
        //txtPrima.Enabled = false;
        //txtPrimaConyuge.Enabled = false;
        txtPrimaOtros.Enabled = true;
        //txtPrimaPrincipal.Enabled = false;
        txtCedulaOtro.Enabled = false;
        txtNombreOtro.Enabled = false;
        txtApellidoOtro.Enabled = false;
        txtEdadOtro.Enabled = false;
        txtFechaNacimiento.Enabled = false;
        btnAdicionarOtrosAsegurados.Enabled = false;
        grvAmparoOtro.Visible = false;
        btnGuardarCambios.Enabled = false;
        txtPrimaPrincipalExtraprima.Enabled = false;
        txtPrincipalExtraprimaConyuge.Enabled = false;
        txtPrimaPrincipalExtraprimaConyuge.Enabled = false;
        txtPrincipalExtraprima.Enabled = false;

        AdministrarCertificados.usuarioSistema.NombreUsuario = Session["Usuario"].ToString();

        //bloqueo prima
        //AdministrarCertificados.HabilitarCampoPrima(txtCedulaPrincipal.Text, txtCertificado.Text);
        txtFechaExpedicionCertificado.Enabled = false;
        txtFechaVigenciaCertificado.Enabled = false;
        txtCertificado.Enabled = false;
        txtNombreAsesor.Enabled = false;
        txtAgencia.Enabled = false;
        txtPrima.Enabled = false;
        txtCedulaPrincipal.Enabled = false;
        txtNombrePrincipal.Enabled = false;
        txtApellidoPrincipal.Enabled = false;
        txtEdadPrincipal.Enabled = false;
        txtPagaduriaPrincipal.Enabled = false;
        txtPrimaPrincipal.Enabled = false;
        txtExtraPrimaPrincipal.Enabled = false;
        txtCedulaConyuge.Enabled = false;
        txtNombreConyuge.Enabled = false;
        txtApellidoConyuge.Enabled = false;
        txtEdadConyuge.Enabled = false;
        txtPrimaConyuge.Enabled = false;
        txtExtraPrimaConyuge.Enabled = false;
        txtPrima.Enabled = false;
        //txtPrimaConyuge.Enabled = false;
        txtPrimaOtros.Enabled = false;
        // txtPrimaPrincipal.Enabled = false;
        txtCedulaOtro.Enabled = false;
        txtNombreOtro.Enabled = false;
        txtApellidoOtro.Enabled = false;
        txtEdadOtro.Enabled = false;
        txtFechaNacimiento.Enabled = false;
        btnAdicionarOtrosAsegurados.Enabled = false;
        grvAmparoOtro.Visible = false;
        txtHServicio1.Enabled = false;
        txtHServicio2.Enabled = false;
        txtHServicio3.Enabled = false;
        txtAnexoConversion.Enabled = false;

        if (!IsPostBack)
        {
            //double cer_IdAnteriorExtraPrima = 0;
            Session["cer_IdAnteriorExtraPrima"] = 0;
            double valorAseguradoPrincipalResta = 0;
            Session["valorAseguradoPrincipalResta"] = valorAseguradoPrincipalResta;
            double valorAseguradoPrincipalRestaConyuge = 0;
            Session["valorAseguradoPrincipalRestaConyuge"] = valorAseguradoPrincipalRestaConyuge;


            double dtExtraprimaPrincipalRestaurar3 = 0;
            Session["dtExtraprimaPrincipalRestaurar3"] = dtExtraprimaPrincipalRestaurar3;

            double dtExtraprimaConyugeRestaurar3 = 0;
            Session["dtExtraprimaConyugeRestaurar3"] = dtExtraprimaConyugeRestaurar3;

            string movimientoOtrosAsegurados = "";
            Session["movimientoOtrosAsegurados"] = movimientoOtrosAsegurados;

            bool teniaOtrosAsegurados = false;
            Session["teniaOtrosAsegurados"] = teniaOtrosAsegurados;

            //int tipoMovimientoDefinitivo = 0;
            //Session["tipoMovimientoDefinitivo"] = tipoMovimientoDefinitivo;

            //Borrar Hijos
            txtPrimaOtros.Text = "";
            int primaOtroAsegurado = 0;
            Session["primaOtroAsegurado"] = primaOtroAsegurado;

            btnSiguienteCertificado.Enabled = false;
            reqtxtPlanPrincipal.Enabled = false;
            txtPlanPrincipal.Visible = false;
            reqtxtPlanConyuge.Enabled = false;
            txtPlanConyuge.Visible = false;
            lblPlan.Visible = false;
            labPlan.Visible = false;
        }
      
        if (!IsPostBack)
        {
            if (ddlPoliza.Text != "")
            {
                txtDocumentoConyugue.Enabled = true;
                txtDocumentoOtros.Enabled = true;
            }
            else
            {
                txtDocumentoConyugue.Enabled = false;
                txtDocumentoOtros.Enabled = false;
            }

            DataTable dtCertificadoFull = new DataTable();
            bool sePuedenHijosPMI = true;
            Session["sePuedenHijosPMI"] = sePuedenHijosPMI;
            bool teniaConyuge = false;
            Session["teniaConyuge"] = teniaConyuge;

            DataTable dtBeneficiario = new DataTable();
            DataColumn columns = new DataColumn();
            columns.DataType = System.Type.GetType("System.String");
            columns.AllowDBNull = true;
            columns.Caption = "NumeroDocumento";
            columns.ColumnName = "NumeroDocumento";
            dtBeneficiario.Columns.Add(columns);

            columns = new DataColumn();
            columns.DataType = System.Type.GetType("System.String");
            columns.AllowDBNull = true;
            columns.Caption = "Apellidos";
            columns.ColumnName = "Apellidos";
            dtBeneficiario.Columns.Add(columns);

            columns = new DataColumn();
            columns.DataType = System.Type.GetType("System.String");
            columns.AllowDBNull = true;
            columns.Caption = "Nombres";
            columns.ColumnName = "Nombres";
            dtBeneficiario.Columns.Add(columns);

            columns = new DataColumn();
            columns.DataType = System.Type.GetType("System.String");
            columns.AllowDBNull = true;
            columns.Caption = "Edad";
            columns.ColumnName = "Edad";
            dtBeneficiario.Columns.Add(columns);

            columns = new DataColumn();
            columns.DataType = System.Type.GetType("System.String");
            columns.AllowDBNull = true;
            columns.Caption = "Porcentaje";
            columns.ColumnName = "Porcentaje";
            dtBeneficiario.Columns.Add(columns);

            columns = new DataColumn();
            columns.DataType = System.Type.GetType("System.String");
            columns.AllowDBNull = true;
            columns.Caption = "Parentesco";
            columns.ColumnName = "Parentesco";
            dtBeneficiario.Columns.Add(columns);


            //lLENAR PRIMERA FILA DE LA TABLA BENEFIACIARIOS  
            DataTable dtBeneficiarioPrueba = new DataTable();
            dtBeneficiarioPrueba = AdministrarCertificados.ConsultarBeneficiarioUnico();
            grvBeneficiarioPrincipal.DataSource = dtBeneficiarioPrueba;
            grvBeneficiarioPrincipal.DataBind();


            grvBeneficiarioPrincipal.DataSource = dtBeneficiario;
            grvBeneficiarioPrincipal.DataBind();
            grvBeneficiarioPrincipal.Enabled = true;




            // Crear Tabla de Beneficiarios
            DataTable dtBeneficiarioConyuge = new DataTable();
            dtBeneficiarioConyuge = new DataTable();
            DataColumn column = new DataColumn();
            column.DataType = System.Type.GetType("System.String");
            column.AllowDBNull = true;
            column.Caption = "NumeroDocumento";
            column.ColumnName = "NumeroDocumento";
            dtBeneficiarioConyuge.Columns.Add(column);

            column = new DataColumn();
            column.DataType = System.Type.GetType("System.String");
            column.AllowDBNull = true;
            column.Caption = "Apellidos";
            column.ColumnName = "Apellidos";
            dtBeneficiarioConyuge.Columns.Add(column);

            column = new DataColumn();
            column.DataType = System.Type.GetType("System.String");
            column.AllowDBNull = true;
            column.Caption = "Nombres";
            column.ColumnName = "Nombres";
            dtBeneficiarioConyuge.Columns.Add(column);

            column = new DataColumn();
            column.DataType = System.Type.GetType("System.String");
            column.AllowDBNull = true;
            column.Caption = "Edad";
            column.ColumnName = "Edad";
            dtBeneficiarioConyuge.Columns.Add(column);

            column = new DataColumn();
            column.DataType = System.Type.GetType("System.String");
            column.AllowDBNull = true;
            column.Caption = "Porcentaje";
            column.ColumnName = "Porcentaje";
            dtBeneficiarioConyuge.Columns.Add(column);

            column = new DataColumn();
            column.DataType = System.Type.GetType("System.String");
            column.AllowDBNull = true;
            column.Caption = "Parentesco";
            column.ColumnName = "Parentesco";
            dtBeneficiarioConyuge.Columns.Add(column);

            //lLENAR PRIMERA FILA DE LA TABLA BENEFIACIARIOS  
            DataTable dtBeneficiarioPruebaConyuge = new DataTable();
            dtBeneficiarioPruebaConyuge = AdministrarCertificados.ConsultarBeneficiarioUnico();
            grvBeneficiarioConyuge.DataSource = dtBeneficiarioPruebaConyuge;
            grvBeneficiarioConyuge.DataBind();

            grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyuge;
            grvBeneficiarioConyuge.DataBind();
            grvBeneficiarioConyuge.Enabled = true;

            Session["dtBeneficiario"] = dtBeneficiario;
            Session["dtBeneficiarioConyuge"] = dtBeneficiarioConyuge;

            DataTable otrosAsegurados = new DataTable();
            DataTable dtEliminarPrincipal = new DataTable();
            DataTable dtEliminarConyuge = new DataTable();
            DataTable dtTemp = new DataTable();
            DataTable dtExtraprimaPrincipal = new DataTable();
            DataTable dtExtraprimaConyuge = new DataTable();
            int rowExtraPrima = 0;


            if (!IsPostBack)
            {
                string poliza = Session["numeroCertificado"].ToString();
                if (poliza != null)
                {
                    txtCertificado.Text = poliza;
                }
                //dtCertificadoFull = AdministrarCertificados.consultarCertificadoFull(int.Parse(poliza));

                DataTable dt = PrecargueProduccion.ConsultarConsecutivoCert(int.Parse(Session["cer_Id"].ToString()));

                // Si permite varios vigentes
                //if (dt.Rows[0]["casesp_Id"].ToString() == "8")
                //{
                if (int.Parse(Session["pro_Id"].ToString()) == 99)
                    dtCertificadoFull = AdministrarCertificados.consultarCertificadoFullCedula(double.Parse(Session["ter_Id"].ToString()), 1);
                if (dtCertificadoFull.Rows.Count == 0)
                    dtCertificadoFull = AdministrarCertificados.consultarCertificadoFullCedula(double.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()));
                //}
            }
            int Edad = 0;

            if (!IsPostBack)
            {
                // Todos
                AdministrarCertificados.certificadoPrecargado(int.Parse(Session["cer_Id"].ToString()));
                txtAgencia.Text = AdministrarCertificados.certificadoPre.Agencia;
                txtFechaExpedicionCertificado.Text = AdministrarCertificados.certificadoPre.FechaExpedicion.ToString("yyyy-MM-dd");
                txtFechaVigenciaCertificado.Text = AdministrarCertificados.certificadoPre.Vigencia.ToString("yyyy-MM-dd");
                txtCertificado.Text = AdministrarCertificados.certificadoPre.NumeroCertificado;
                txtNombreAsesor.Text = AdministrarCertificados.certificadoPre.NombreAsesor;
                txtNombrePrincipal.Text = AdministrarCertificados.aseguradoPre.Nombres;
                txtApellidoPrincipal.Text = AdministrarCertificados.aseguradoPre.Apellidos;
                txtCedulaPrincipal.Text = AdministrarCertificados.aseguradoPre.NumeroDocumento;
                txtPagaduriaPrincipal.Text = AdministrarCertificados.certificadoPre.Pagaduria;
                txtHServicio1.Text = AdministrarCertificados.certificadoPre.HojaServicio1;
                txtHServicio2.Text = AdministrarCertificados.certificadoPre.HojaServicio2;
                txtHServicio3.Text = AdministrarCertificados.certificadoPre.HojaServicio3;
                txtAnexoConversion.Text = AdministrarCertificados.certificadoPre.AnexoConversion;

                Edad = Convert.ToInt32(Session["edad"]);
                txtEdadPrincipal.Text = Edad.ToString();


                DataTable dt = new DataTable(), dtAgencia = new DataTable(), dtPeriodoPago = new DataTable(), dtLocalidades = new DataTable(), dtOcupacionPrincipal = new DataTable(), dtconsultarParentescoBeneficiarioPrincipal = new DataTable();

                dtPeriodoPago = AdministrarCertificados.ConsultarPeriodosPago();
                ddlperiodoPagoCertificado.DataValueField = "perpago_Id";
                ddlperiodoPagoCertificado.DataTextField = "perpago_Nombre";
                ddlperiodoPagoCertificado.DataSource = dtPeriodoPago;
                ddlperiodoPagoCertificado.DataBind();
                ddlperiodoPagoCertificado.Items.Insert(0, new ListItem("", ""));

                dtLocalidades = AdministrarCertificados.ConsultarLocalidadesCertificado(int.Parse(Session["cer_Id"].ToString()));
                ddlLocalidadCertificado.DataValueField = "dep_Id";
                ddlLocalidadCertificado.DataTextField = "dep_Nombre";
                ddlLocalidadCertificado.DataSource = dtLocalidades;
                ddlLocalidadCertificado.DataBind();
                ddlLocalidadCertificado.Items.Insert(0, new ListItem("", ""));
                ddlLocalidadCertificado.Attributes.Add("onclick", "localStorage.setItem('accIndex', 0);");

                int cer_Id = int.Parse(Session["cer_id"].ToString());
                DataTable dtEncabezadoCertificado = new DataTable();
                dtEncabezadoCertificado = AdministrarCertificados.spConsultarEncabezadoCertificado(cer_Id);
                dtconsultarParentescoBeneficiarioPrincipal = AdministrarCertificados.consultarParentescoBeneficiario(int.Parse(dtEncabezadoCertificado.Rows[0]["pro_Id"].ToString()));


                dtOcupacionPrincipal = AdministrarCertificados.ConsultarOcupacionCertificado(int.Parse(txtCedulaPrincipal.Text));
                ddlOcupacionPrincipal.DataValueField = "ocu_Id";
                ddlOcupacionPrincipal.DataTextField = "ocu_Nombre";
                ddlOcupacionPrincipal.DataSource = dtOcupacionPrincipal;
                ddlOcupacionPrincipal.DataBind();

                //cer_Id = AdministrarCertificados.ConsultarIdCertificado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "VIGENTE");
                //int cer_Id = int.Parse(Session["cer_id"].ToString());


                //Migracion
                if (AdministrarCertificados.certificadoPre.Migracion == "2")
                {
                    txtPrima.Enabled = true;
                    txtCompania.Enabled = false;
                    ddlProducto.Enabled = false;
                    txtFechaExpedicionCertificado.Enabled = false;
                    txtFechaVigenciaCertificado.Enabled = false;
                    txtFechaDigitacionCertificado.Enabled = false;
                    txtCertificado.Enabled = false;
                    txtNombreAsesor.Enabled = false;
                    ddlperiodoPagoCertificado.Enabled = false;
                    ddlLocalidadCertificado.Enabled = false;
                    ddlPoliza.Enabled = false;
                    txtAgencia.Enabled = false;
                    txtmesProduccion.Enabled = false;
                    txtEstadoNegocio.Enabled = false;
                    txtDeclaracionAsegurado.Enabled = false;
                    txtDeclaracionEG.Enabled = false;
                    txtHServicio1.Enabled = false;
                    txtHServicio2.Enabled = false;
                    txtHServicio3.Enabled = false;
                    txtAnexoConversion.Enabled = false;
                    txtTipoMovimiento.Enabled = false;
                    btnCambiosPreCargue.Enabled = false;
                    btnGuardarCambios.Enabled = false;
                    ddlConvenioPrincipal.Enabled = false;
                    ddlPlanPrincipal.Enabled = false;
                    ddlPlanConyuge.Enabled = false;
                    grvAmparoPrincipal.Enabled = false;
                    grvBeneficiarioPrincipal.Enabled = false;
                    txtDocumentoConyugue.Enabled = false;
                    boton1.Enabled = false;
                    Button1.Enabled = false;
                    btnAdicionarOtrosAsegurados.Enabled = false;
                    txtTelefono2Otros.Enabled = false;
                    txtTelefono1Otros.Enabled = false;
                    txtPrimaOtros.Enabled = false;
                    txtNombreOtros.Enabled = false;
                    txtNombreOtro.Enabled = false;
                    txtNacimientoOtros.Enabled = false;
                    txtIdentificacionOtros.Enabled = false;
                    txtEdadOtros.Enabled = false;
                    txtEdadOtro.Enabled = false;
                    txtDocumentoOtros.Enabled = false;
                    txtDireccionOtros.Enabled = false;
                    txtCorreoOtros.Enabled = false;
                    txtCelularOtros.Enabled = false;
                    txtCedulaOtro.Enabled = false;
                    txtApellidoOtros.Enabled = false;
                    txtApellidoOtro.Enabled = false;
                    txtpesoPrincipal.Enabled = false;
                    txtestaturaPrincipal.Enabled = false;
                    ddlPlanPrincipal.Enabled = false;

                    if (dtCertificadoFull.Rows.Count > 0)
                    {
                        txtEstadoNegocio.Text = dtCertificadoFull.Rows[0]["cer_EstadoNegocio"].ToString();
                        txtDeclaracionAsegurado.Text = dtCertificadoFull.Rows[0]["cer_Declaracion"].ToString();
                        txtDeclaracionEG.Text = dtCertificadoFull.Rows[0]["cer_DeclaracionEnfe"].ToString();
                        DataTable dtPlan = AdministrarCertificados.ConsultarPlanPrincipal(int.Parse(dtCertificadoFull.Rows[0]["cer_Id"].ToString()));
                        ddlPlanPrincipal.DataSource = dtPlan;
                        ddlPlanPrincipal.DataTextField = "plan_ValAsegurado";
                        ddlPlanPrincipal.DataValueField = "pla_Id";
                        ddlPlanPrincipal.DataBind();
                    }
                }

                //Designación de Beneficiarios
                if (AdministrarCertificados.certificadoPre.Migracion == "3")
                {
                    txtPrima.Enabled = false;
                    txtCompania.Enabled = false;
                    ddlProducto.Enabled = false;
                    txtFechaExpedicionCertificado.Enabled = false;
                    txtFechaVigenciaCertificado.Enabled = false;
                    txtFechaDigitacionCertificado.Enabled = false;
                    txtCertificado.Enabled = false;
                    txtNombreAsesor.Enabled = false;
                    ddlperiodoPagoCertificado.Enabled = false;
                    ddlLocalidadCertificado.Enabled = false;
                    ddlPoliza.Enabled = false;
                    txtAgencia.Enabled = false;
                    txtmesProduccion.Enabled = false;
                    txtEstadoNegocio.Enabled = false;
                    txtDeclaracionAsegurado.Enabled = false;
                    txtDeclaracionEG.Enabled = false;
                    txtHServicio1.Enabled = false;
                    txtHServicio2.Enabled = false;
                    txtHServicio3.Enabled = false;
                    txtAnexoConversion.Enabled = false;
                    txtTipoMovimiento.Enabled = false;
                    btnCambiosPreCargue.Enabled = false;
                    btnGuardarCambios.Enabled = false;
                    ddlConvenioPrincipal.Enabled = false;
                    ddlPlanPrincipal.Enabled = false;
                    ddlPlanConyuge.Enabled = false;
                    grvAmparoPrincipal.Enabled = false;
                    grvBeneficiarioPrincipal.Enabled = true;
                    txtDocumentoConyugue.Enabled = false;
                    boton1.Enabled = false;
                    Button1.Enabled = false;
                    btnAdicionarOtrosAsegurados.Enabled = false;
                    txtTelefono2Otros.Enabled = false;
                    txtTelefono1Otros.Enabled = false;
                    txtPrimaOtros.Enabled = false;
                    txtNombreOtros.Enabled = false;
                    txtNombreOtro.Enabled = false;
                    txtNacimientoOtros.Enabled = false;
                    txtIdentificacionOtros.Enabled = false;
                    txtEdadOtros.Enabled = false;
                    txtEdadOtro.Enabled = false;
                    txtDocumentoOtros.Enabled = false;
                    txtDireccionOtros.Enabled = false;
                    txtCorreoOtros.Enabled = false;
                    txtCelularOtros.Enabled = false;
                    txtCedulaOtro.Enabled = false;
                    txtApellidoOtros.Enabled = false;
                    txtApellidoOtro.Enabled = false;
                    txtpesoPrincipal.Enabled = false;
                    txtestaturaPrincipal.Enabled = false;
                    ddlPlanPrincipal.Enabled = false;

                    if (dtCertificadoFull.Rows.Count > 0)
                    {
                        txtEstadoNegocio.Text = dtCertificadoFull.Rows[0]["cer_EstadoNegocio"].ToString();
                        txtDeclaracionAsegurado.Text = dtCertificadoFull.Rows[0]["cer_Declaracion"].ToString();
                        txtDeclaracionEG.Text = dtCertificadoFull.Rows[0]["cer_DeclaracionEnfe"].ToString();
                        DataTable dtPlan = AdministrarCertificados.ConsultarPlanPrincipal(int.Parse(dtCertificadoFull.Rows[0]["cer_Id"].ToString()));
                        ddlPlanPrincipal.DataSource = dtPlan;
                        ddlPlanPrincipal.DataTextField = "plan_ValAsegurado";
                        ddlPlanPrincipal.DataValueField = "pla_Id";
                        ddlPlanPrincipal.DataBind();
                    }
                }

                // Cargar todo lo relacionado con modificar
                if (dtCertificadoFull.Rows.Count > 0)
                {
                    //if (dtCertificadoFull.Rows[0]["cer_Migracion"].ToString() == "2")
                    if ((string)Session["operacionCertificado"] == "modificar" || int.Parse(Session["pro_Id"].ToString()) == 99)
                    {
                        ReqddlPlanPrincipal.Enabled = false;
                        reqddlPlanConyuge.Enabled = false;
                        reqtxtPlanConyuge.Enabled = false;
                        reqtxtPlanPrincipal.Enabled = false;
                        ddlLocalidadCertificado.SelectedValue = dtLocalidades.Rows[0]["dep_Id"].ToString();
                        DataTable dtPolizaInicio = new DataTable();
                        dtPolizaInicio = AdministrarCertificados.spConsultarPolizaPorProudcto(int.Parse(ddlLocalidadCertificado.SelectedValue.ToString()));
                        ddlPoliza.DataSource = dtPolizaInicio;
                        ddlPoliza.DataTextField = "pol_Numero";
                        ddlPoliza.DataValueField = "pol_Id";
                        ddlPoliza.SelectedValue = dtPolizaInicio.Rows[0]["pol_Id"].ToString();
                        ddlPoliza.DataBind();

                        txtFechaDigitacionCertificado.Text = DateTime.Parse(dtCertificadoFull.Rows[0]["cer_FechaRecibido"].ToString()).ToString("yyyy-MM-dd");
                        ddlperiodoPagoCertificado.SelectedIndex = ddlperiodoPagoCertificado.Items.IndexOf(ddlperiodoPagoCertificado.Items.FindByText(dtCertificadoFull.Rows[0]["perpago_Nombre"].ToString())); //jc
                        txtPrima.Text = dtCertificadoFull.Rows[0]["cer_PrimaTotal"].ToString();
                        txtPlanPrincipal.Text = dtCertificadoFull.Rows[0]["pla_Id"].ToString();
                        txtpesoPrincipal.Text = dtCertificadoFull.Rows[0]["PesoPrincipal"].ToString();
                        txtestaturaPrincipal.Text = dtCertificadoFull.Rows[0]["cer_EstaturaPrincipal"].ToString();
                        txtPeso.Text = dtCertificadoFull.Rows[0]["PesoConyuge"].ToString();
                        txtEstatura.Text = dtCertificadoFull.Rows[0]["cer_EstaturaConyuge"].ToString();
                        txtEdadPrincipal.Text = Funciones.Edad(DateTime.Parse(dtCertificadoFull.Rows[0]["ter_FechaNacimiento"].ToString())).ToString(); //Envía fecha y devuelve la edad
                        txtDeclaracionAsegurado.Text = dtCertificadoFull.Rows[0]["cer_declaracion"].ToString();
                        txtDeclaracionEG.Text = dtCertificadoFull.Rows[0]["cer_declaracionEnfe"].ToString();

                        //DataTable que trae info de tercero por ter_Id para llenar compos de conyuge
                        DataTable dtConyuge = new DataTable();
                        //bool teniaConyuge;
                        dtConyuge = AdministrarCertificados.consultarNewTerceroPorCedula(int.Parse(txtCedulaPrincipal.Text), int.Parse(AdministrarCertificados.certificadoPre.Producto));
                        if (dtConyuge.Rows.Count > 0)
                        {
                            teniaConyuge = true;
                            txtCedulaConyuge.Text = dtConyuge.Rows[0]["ter_Id"].ToString();
                            txtNombreConyuge.Text = dtConyuge.Rows[0]["ter_Nombres"].ToString();
                            txtApellidoConyuge.Text = dtConyuge.Rows[0]["ter_Apellidos"].ToString();
                            txtEdadConyuge.Text = Funciones.Edad(DateTime.Parse(dtConyuge.Rows[0]["ter_FechaNacimiento"].ToString())).ToString(); //Envía fecha y devuelve la edad
                        }
                        else
                            teniaConyuge = false;
                        Session["teniaConyuge"] = teniaConyuge;

                        txtFechaDigitacionCertificado.Text = DateTime.Parse(dtCertificadoFull.Rows[0]["cer_FechaRecibido"].ToString()).ToString("yyyy-MM-dd");
                        ddlPoliza.Text = dtCertificadoFull.Rows[0]["pol_Numero"].ToString();
                        txtPrima.Text = dtCertificadoFull.Rows[0]["cer_PrimaTotal"].ToString();
                        txtPlanPrincipal.Text = dtCertificadoFull.Rows[0]["pla_Id"].ToString();
                        txtpesoPrincipal.Text = dtCertificadoFull.Rows[0]["PesoPrincipal"].ToString();
                        txtestaturaPrincipal.Text = dtCertificadoFull.Rows[0]["cer_EstaturaPrincipal"].ToString();
                        txtPeso.Text = dtCertificadoFull.Rows[0]["PesoConyuge"].ToString();
                        txtEstatura.Text = dtCertificadoFull.Rows[0]["cer_EstaturaConyuge"].ToString();

                        cer_Id = AdministrarCertificados.ConsultarIdCertificado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "VIGENTE", "PRODUCCION NUEVA");
                        //cer_Id = int.Parse(Session["cer_id"].ToString());


                        DataTable dtConsultarHistorialExtraPrima = new DataTable();
                        dtConsultarHistorialExtraPrima = AdministrarCertificados.ConsultarHistorialExtraPrima(cer_Id, 1);
                        grvHistorialExtraPrima.DataSource = dtConsultarHistorialExtraPrima;
                        grvHistorialExtraPrima.DataBind();
                        if (dtConsultarHistorialExtraPrima.Rows.Count > 0)
                        {
                            Session["cer_IdAnteriorExtraPrima"] = cer_Id;
                        }
                        double consultarHistorialExtraPrima = 0;
                        double valorExtraPrima = 0;

                        if (dtConsultarHistorialExtraPrima.Rows.Count > 0)
                        {
                            foreach (DataRow dtConsultarHistorialExtraPrimaForeach in dtConsultarHistorialExtraPrima.Rows)
                            {
                                consultarHistorialExtraPrima += double.Parse(dtConsultarHistorialExtraPrimaForeach["Prima"].ToString());
                                valorExtraPrima += double.Parse(dtConsultarHistorialExtraPrimaForeach["Extra Prima"].ToString());
                            }
                        }

                        txtPrimaPrincipalExtraprima.Text = consultarHistorialExtraPrima.ToString();
                        txtPrincipalExtraprima.Text = valorExtraPrima.ToString();
                        txtPrimaPrincipal.Text = consultarHistorialExtraPrima.ToString();
                        Session["TotalExtraPrimaP"] = consultarHistorialExtraPrima.ToString();
                        txtExtraPrimaPrincipal.Text = txtPrincipalExtraprima.Text;

                        DataTable dtConsultarHistorialExtraPrimaConyuge = new DataTable();
                        dtConsultarHistorialExtraPrimaConyuge = AdministrarCertificados.ConsultarHistorialExtraPrima(cer_Id, 2);
                        grvHistorialExtraPrimaConyuge.DataSource = dtConsultarHistorialExtraPrimaConyuge;
                        grvHistorialExtraPrimaConyuge.DataBind();

                        if (dtConsultarHistorialExtraPrimaConyuge.Rows.Count > 0)
                        {
                            Session["cer_IdAnteriorExtraPrima"] = cer_Id;
                        }
                        double consultarHistorialExtraPrimaConyuge = 0;
                        double valorExtraPrimaConyuge = 0;

                        if (dtConsultarHistorialExtraPrimaConyuge.Rows.Count > 0)
                        {
                            foreach (DataRow dtConsultarHistorialExtraPrimaForeachConyuge in dtConsultarHistorialExtraPrimaConyuge.Rows)
                            {
                                consultarHistorialExtraPrimaConyuge += double.Parse(dtConsultarHistorialExtraPrimaForeachConyuge["Prima"].ToString());
                                valorExtraPrimaConyuge += double.Parse(dtConsultarHistorialExtraPrimaForeachConyuge["Extra Prima"].ToString());
                            }
                        }
                        txtPrimaPrincipalExtraprimaConyuge.Text = consultarHistorialExtraPrimaConyuge.ToString();
                        txtPrincipalExtraprimaConyuge.Text = valorExtraPrimaConyuge.ToString();
                        txtPrimaConyuge.Text = consultarHistorialExtraPrimaConyuge.ToString();
                        Session["TotalExtraPrimaC"] = consultarHistorialExtraPrimaConyuge.ToString();
                        txtExtraPrimaConyuge.Text = valorExtraPrimaConyuge.ToString();

                        sumarPrima();

                        dtBeneficiario = AdministrarCertificados.ConsultarBeneficiarioModificacion(cer_Id, int.Parse(txtCedulaPrincipal.Text), 1);
                        grvBeneficiarioPrincipal.DataSource = dtBeneficiario;
                        grvBeneficiarioPrincipal.DataBind();

                        int cer_Antiguo = 0;
                        if (int.Parse(Session["pro_Id"].ToString()) == 99 && dtBeneficiario.Rows.Count == 0)
                        {
                            try
                            {
                                cer_Antiguo = int.Parse(dtCertificadoFull.Rows[0]["cer_Id"].ToString());
                            }
                            catch { }

                            dtBeneficiario = AdministrarCertificados.ConsultarBeneficiarioModificacion(cer_Antiguo, int.Parse(txtCedulaPrincipal.Text), 1);
                            grvBeneficiarioPrincipal.DataSource = dtBeneficiario;
                            grvBeneficiarioPrincipal.DataBind();
                        }

                        dtEliminarPrincipal = AdministrarCertificados.consultarAmparosPorPlanModificacion(cer_Id, 1);
                        grvAmparoPrincipal.DataSource = dtEliminarPrincipal;
                        grvAmparoPrincipal.DataBind();

                         double ValorCampoPrimaTxt = 0;

                        foreach (DataRow dtValorCampoPrimaTxt in dtEliminarPrincipal.Rows)
                        {
                            if (dtValorCampoPrimaTxt["Amparo"].ToString() == "VIDA")
                            {
                                ValorCampoPrimaTxt = double.Parse(dtValorCampoPrimaTxt["Valor Asegurado"].ToString());
                                txtPlanPrincipal.Text = ValorCampoPrimaTxt.ToString();
                                ddlPlanPrincipal.SelectedItem.Text = ValorCampoPrimaTxt.ToString();
                            }
                        }
                        if (int.Parse(Session["pro_Id"].ToString()) == 99 && dtEliminarPrincipal.Rows.Count == 0)
                        {
                            dtEliminarPrincipal = AdministrarCertificados.consultarAmparosPorPlanModificacion(cer_Antiguo, 1);
                            grvAmparoPrincipal.DataSource = dtEliminarPrincipal;
                            grvAmparoPrincipal.DataBind();
                        }

                        //Variables que se utilizan para la captura del valor asegurado de vida en la seccion del Principal
                        string capturarValorAseguradoResta;
                        int celdaCapturada = 0;
                        double valorAseguradoPrincipalResta = 0;

                        Session["valorAseguradoPrincipalResta"] = valorAseguradoPrincipalResta;

                        // for que recorre el Dt que llena la grilla de los amparos del Principal 
                        for (int j = 0; j < dtEliminarPrincipal.Rows.Count; j++)
                        {
                            // se captura toda la columna que contiene los Amparos
                            capturarValorAseguradoResta = dtEliminarPrincipal.Rows[j]["Amparo"].ToString();
                            //
                            // se crea el condicional para que me diga en que momento pasa por el amparo VIDA
                            if (capturarValorAseguradoResta == "VIDA")
                            {
                                // se captura en una variable el numero de fila en la que se encuentra el Amparo VIDA
                                celdaCapturada = j;
                                //
                                // se captura el valor del valor asegurado que le corrsponde a la misma fila en la que se encuentra VIDA
                                Session["valorAseguradoPrincipalResta"] = double.Parse(dtEliminarPrincipal.Rows[celdaCapturada]["Valor Asegurado"].ToString());
                                //
                            }
                            //
                        }

                        double totales = 0;
                        foreach (GridViewRow row in grvAmparoPrincipal.Rows)
                        {
                            totales += Convert.ToDouble(row.Cells[4].Text);
                        }
                        //txtPrimaPrincipal.Text = Convert.ToString(totales);

                        if (txtCedulaConyuge.Text != "")
                        {
                            DataTable dtPlanPrin = new DataTable();
                            dtPlanPrin = AdministrarCertificados.consultarPlanPorPoliza(int.Parse(ddlPoliza.SelectedValue.ToString()), 2, int.Parse(txtEdadConyuge.Text));
                            ddlPlanConyuge.DataSource = dtPlanPrin;
                            ddlPlanConyuge.DataValueField = "plapol_Id";
                            ddlPlanConyuge.DataTextField = "plan_ValAsegurado";
                            ddlPlanConyuge.DataBind();
                            Session["plapol_IdConyuge"] = dtPlanPrin.Rows[0]["plapol_Id"].ToString();

                            if (AdministrarCertificados.certificadoPre.Migracion != "2")
                            {
                                dtPlanPrin = AdministrarCertificados.consultarPlanPorPoliza(int.Parse(ddlPoliza.SelectedValue.ToString()), 1, int.Parse(txtEdadPrincipal.Text));
                                ddlPlanPrincipal.DataSource = dtPlanPrin;
                                ddlPlanPrincipal.DataValueField = "plapol_Id";
                                ddlPlanPrincipal.DataTextField = "plan_ValAsegurado";
                                ddlPlanPrincipal.DataBind();
                            }

                            dtBeneficiarioConyuge = AdministrarCertificados.ConsultarBeneficiarioModificacion(cer_Id, int.Parse(txtCedulaConyuge.Text), 2);
                            grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyuge;
                            grvBeneficiarioConyuge.DataBind();

                            if (int.Parse(Session["pro_Id"].ToString()) == 99 && dtBeneficiarioConyuge.Rows.Count == 0)
                            {
                                dtBeneficiarioConyuge = AdministrarCertificados.ConsultarBeneficiarioModificacion(cer_Antiguo, int.Parse(txtCedulaConyuge.Text), 2);
                                grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyuge;
                                grvBeneficiarioConyuge.DataBind();
                            }

                            if (dtBeneficiarioConyuge.Rows.Count == 0)
                            {
                                dtBeneficiarioConyuge = new DataTable();
                                column = new DataColumn();
                                column.DataType = System.Type.GetType("System.String");
                                column.AllowDBNull = true;
                                column.Caption = "NumeroDocumento";
                                column.ColumnName = "NumeroDocumento";
                                dtBeneficiarioConyuge.Columns.Add(column);

                                column = new DataColumn();
                                column.DataType = System.Type.GetType("System.String");
                                column.AllowDBNull = true;
                                column.Caption = "Apellidos";
                                column.ColumnName = "Apellidos";
                                dtBeneficiarioConyuge.Columns.Add(column);

                                column = new DataColumn();
                                column.DataType = System.Type.GetType("System.String");
                                column.AllowDBNull = true;
                                column.Caption = "Nombres";
                                column.ColumnName = "Nombres";
                                dtBeneficiarioConyuge.Columns.Add(column);

                                column = new DataColumn();
                                column.DataType = System.Type.GetType("System.String");
                                column.AllowDBNull = true;
                                column.Caption = "Edad";
                                column.ColumnName = "Edad";
                                dtBeneficiarioConyuge.Columns.Add(column);

                                column = new DataColumn();
                                column.DataType = System.Type.GetType("System.String");
                                column.AllowDBNull = true;
                                column.Caption = "Porcentaje";
                                column.ColumnName = "Porcentaje";
                                dtBeneficiarioConyuge.Columns.Add(column);

                                column = new DataColumn();
                                column.DataType = System.Type.GetType("System.String");
                                column.AllowDBNull = true;
                                column.Caption = "Parentesco";
                                column.ColumnName = "Parentesco";
                                dtBeneficiarioConyuge.Columns.Add(column);

                                DataRow row1 = dtBeneficiarioConyuge.NewRow();
                                row1["NumeroDocumento"] = "";
                                row1["Apellidos"] = "";
                                row1["Nombres"] = "";
                                row1["Edad"] = "";
                                row1["Porcentaje"] = "";
                                row1["Parentesco"] = "";
                                dtBeneficiarioConyuge.Rows.Add(row1);

                                //lLENAR PRIMERA FILA DE LA TABLA BENEFIACIARIOS  
                                DataTable dtBeneficiarioPruebaConyuge2 = new DataTable();
                                dtBeneficiarioPruebaConyuge2 = AdministrarCertificados.ConsultarBeneficiarioUnico();
                                grvBeneficiarioConyuge.DataSource = dtBeneficiarioPruebaConyuge2;
                                grvBeneficiarioConyuge.DataBind();

                                grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyuge;
                                grvBeneficiarioConyuge.DataBind();
                                grvBeneficiarioConyuge.Enabled = true;
                            }
                        }

                        otrosAsegurados = AdministrarCertificados.consultarOtroAsegurado(cer_Id);
                        dtTemp = AdministrarCertificados.consultarOtroAseguradoIndex(cer_Id);
                        grvOtrosAsegurados.DataSource = otrosAsegurados;
                        grvOtrosAsegurados.DataBind();

                        if (int.Parse(Session["pro_Id"].ToString()) == 99 && otrosAsegurados.Rows.Count == 0)
                        {
                            otrosAsegurados = AdministrarCertificados.consultarOtroAsegurado(cer_Antiguo);
                            dtTemp = AdministrarCertificados.consultarOtroAseguradoIndex(cer_Antiguo);
                            grvOtrosAsegurados.DataSource = otrosAsegurados;
                            grvOtrosAsegurados.DataBind();
                        }

                        bool teniaOtrosAsegurados = true;
                        Session["teniaOtrosAsegurados"] = teniaOtrosAsegurados;

                        double valorAseguradoPrincipalRestaConyuge = 0;
                        Session["valorAseguradoPrincipalRestaConyuge"] = valorAseguradoPrincipalRestaConyuge;

                        if (txtCedulaConyuge.Text != "")
                        {
                            string capturarValorAseguradoRestaConyuge;
                            int celdaCapturadaConyuge = 0;


                            dtEliminarConyuge = AdministrarCertificados.consultarAmparosPorPlanModificacion(cer_Id, 2);
                            grvAmparoConyuge.DataSource = dtEliminarConyuge;
                            grvAmparoConyuge.DataBind();

                            double ValorCampoPrimaTxtConyuge = 0;

                            foreach (DataRow dtValorCampoPrimaTxtConyuge in dtEliminarConyuge.Rows)
                            {
                                if (dtValorCampoPrimaTxtConyuge["Amparo"].ToString() == "VIDA")
                                {
                                    ValorCampoPrimaTxtConyuge = double.Parse(dtValorCampoPrimaTxtConyuge["Valor Asegurado"].ToString());
                                    txtPlanConyuge.Text = ValorCampoPrimaTxtConyuge.ToString();
                                    ddlPlanConyuge.SelectedItem.Text = ValorCampoPrimaTxtConyuge.ToString();
                                }
                            }

                            if (int.Parse(Session["pro_Id"].ToString()) == 99 && dtEliminarConyuge.Rows.Count == 0)
                            {
                                dtEliminarConyuge = AdministrarCertificados.consultarAmparosPorPlanModificacion(cer_Antiguo, 2);
                                grvAmparoConyuge.DataSource = dtEliminarConyuge;
                                grvAmparoConyuge.DataBind();
                            }

                            for (int j = 0; j < dtEliminarConyuge.Rows.Count; j++)
                            {
                                capturarValorAseguradoRestaConyuge = dtEliminarConyuge.Rows[j]["Amparo"].ToString();
                                if (capturarValorAseguradoRestaConyuge == "VIDA")
                                {
                                    celdaCapturadaConyuge = j;
                                    Session["valorAseguradoPrincipalRestaConyuge"] = double.Parse(dtEliminarConyuge.Rows[celdaCapturadaConyuge]["Valor Asegurado"].ToString());
                                }
                            }

                            totales = 0;
                            foreach (GridViewRow row in grvAmparoConyuge.Rows)
                            {
                                totales += Convert.ToDouble(row.Cells[4].Text);
                            }
                            //txtPrimaConyuge.Text = Convert.ToString(totales);
                        }
                    }
                }

                // Carga Plan Conyuge en Migración
                //if (AdministrarCertificados.certificadoPre.Migracion == "2")
                //{
                //    DataTable dtPlanPrin = new DataTable();
                //    dtPlanPrin = AdministrarCertificados.consultarPlanPorPoliza(int.Parse(ddlPoliza.SelectedValue.ToString()), 2, int.Parse(txtEdadConyuge.Text));
                //    ddlPlanConyuge.DataSource = dtPlanPrin;
                //    ddlPlanConyuge.DataValueField = "plapol_Id";
                //    ddlPlanConyuge.DataTextField = "plan_ValAsegurado";
                //    ddlPlanConyuge.DataBind();
                //}

                Session["dtTemp"] = dtTemp;
                Session["dtBeneficiario"] = dtBeneficiario;
                Session["dtBeneficiarioConyuge"] = dtBeneficiarioConyuge;
                Session["dtEliminarPrincipal"] = dtEliminarPrincipal;
                Session["dtEliminarConyuge"] = dtEliminarConyuge;
                Session["dtExtraprimaConyuge"] = dtExtraprimaConyuge;
                Session["dtExtraprimaPrincipal"] = dtExtraprimaPrincipal;
                Session["rowExtraPrima"] = rowExtraPrima;
                Session["valorExtraPrimado"] = 0;
                Session["valorExtraPrimadoC"] = 0;
                Session["diferenciaValorAseguradoP"] = 0;
                Session["diferenciaValorAseguradoC"] = 0;

                if (AdministrarCertificados.certificadoPre.Producto == "1")
                {
                    if ((string)Session["operacionCertificado"] == "modificar")
                    {
                        reqtxtPlanPrincipal.Enabled = false;
                        reqtxtPlanConyuge.Enabled = false;
                    }
                    else
                    {
                        reqtxtPlanPrincipal.Enabled = true;
                        reqtxtPlanConyuge.Enabled = true;
                    }

                    txtPlanPrincipal.Visible = true;
                    txtPlanConyuge.Visible = true;

                    lblPlan.Visible = true;
                    labPlan.Visible = true;

                    ReqddlPlanPrincipal.Enabled = false;
                    ddlPlanPrincipal.Visible = false;

                    reqddlPlanConyuge.Enabled = false;
                    ddlPlanConyuge.Visible = false;

                    labPlan1.Visible = false;
                    lblPlan2.Visible = false;

                    reqtxtPeso.Enabled = false;
                    txtPeso.Visible = false;

                    reqtxtPesoPrincipal.Enabled = false;
                    txtpesoPrincipal.Visible = false;

                    reqtxtestaturaPrincipal.Enabled = false;
                    txtestaturaPrincipal.Visible = false;

                    reqtxtEstatura.Enabled = false;
                    txtEstatura.Visible = false;

                    lblPesoConyuge.Visible = false;
                    lblEstaturaConyuge.Visible = false;
                    labPeso.Visible = false;
                    labEstatura.Visible = false;
                }

                if (AdministrarCertificados.certificadoPre.Producto == "99" || AdministrarCertificados.certificadoPre.Producto == "4"
                                   || AdministrarCertificados.certificadoPre.Producto == "98" || AdministrarCertificados.certificadoPre.Producto == "2" ||
                                    AdministrarCertificados.certificadoPre.Producto == "21")
                {
                    if (AdministrarCertificados.certificadoPre.Producto == "21" || AdministrarCertificados.certificadoPre.Producto == "3"
                        || AdministrarCertificados.certificadoPre.Producto == "9" || AdministrarCertificados.certificadoPre.Producto == "98"
                        || AdministrarCertificados.certificadoPre.Producto == "4")
                    {
                        reqtxtPeso.Enabled = true;
                        txtPeso.Visible = true;

                        reqtxtPesoPrincipal.Enabled = true;
                        txtpesoPrincipal.Visible = true;

                        reqtxtestaturaPrincipal.Enabled = true;
                        txtestaturaPrincipal.Visible = true;

                        reqtxtEstatura.Enabled = true;
                        txtEstatura.Visible = true;

                        lblPesoConyuge.Visible = true;
                        lblEstaturaConyuge.Visible = true;
                        labPeso.Visible = true;
                        labEstatura.Visible = true;
                    }
                    else
                    {
                        reqtxtPeso.Enabled = false;
                        txtPeso.Visible = false;

                        reqtxtPesoPrincipal.Enabled = false;
                        txtpesoPrincipal.Visible = false;

                        reqtxtestaturaPrincipal.Enabled = false;
                        txtestaturaPrincipal.Visible = false;

                        reqtxtEstatura.Enabled = false;
                        txtEstatura.Visible = false;

                        lblPesoConyuge.Visible = false;
                        lblEstaturaConyuge.Visible = false;
                        labPeso.Visible = false;
                        labEstatura.Visible = false;
                    }
                }



                if (AdministrarCertificados.certificadoPre.Producto == "3")
                    if (AdministrarCertificados.certificadoPre.Producto == "3")
                    {
                        if ((string)Session["operacionCertificado"] == "modificar")
                        {
                            reqtxtPlanPrincipal.Enabled = false;
                            reqtxtPlanConyuge.Enabled = false;
                        }
                        else
                        {
                            reqtxtPlanPrincipal.Enabled = true;
                            reqtxtPlanConyuge.Enabled = true;
                        }

                        txtPlanPrincipal.Visible = true;
                        txtPlanConyuge.Visible = true;

                        lblPlan.Visible = true;
                        labPlan.Visible = true;

                        ReqddlPlanPrincipal.Enabled = false;
                        ddlPlanPrincipal.Visible = false;

                        reqddlPlanConyuge.Enabled = false;
                        ddlPlanConyuge.Visible = false;

                        labPlan1.Visible = false;
                        lblPlan2.Visible = false;

                        reqtxtPeso.Enabled = true;
                        txtPeso.Visible = true;

                        reqtxtPesoPrincipal.Enabled = true;
                        txtpesoPrincipal.Visible = true;

                        reqtxtestaturaPrincipal.Enabled = true;
                        txtestaturaPrincipal.Visible = true;

                        reqtxtEstatura.Enabled = true;
                        txtEstatura.Visible = true;

                        lblPesoConyuge.Visible = true;
                        lblEstaturaConyuge.Visible = true;
                        labPeso.Visible = true;
                        labEstatura.Visible = true;
                    }
            }

            if (!IsPostBack)
            {
                if (AdministrarCertificados.certificadoPre.Producto == "99")
                {
                    txtAnexoConversion.Visible = true;
                    txtHServicio1.Visible = true;
                    txtHServicio2.Visible = true;
                    txtHServicio3.Visible = true;
                    btnGuardarCambios.Visible = true;
                    btnCambiosPreCargue.Visible = true;
                    lblAnexoConversion.Visible = true;
                    lblHServicio1.Visible = true;
                    lblHServicio2.Visible = true;
                    lblHServicio3.Visible = true;
                }
                else
                {
                    txtAnexoConversion.Visible = false;
                    txtHServicio1.Visible = false;
                    txtHServicio2.Visible = false;
                    txtHServicio3.Visible = false;
                    btnGuardarCambios.Visible = false;
                    btnCambiosPreCargue.Visible = false;
                    lblAnexoConversion.Visible = false;
                    lblHServicio1.Visible = false;
                    lblHServicio2.Visible = false;
                    lblHServicio3.Visible = false;
                }
                if (otrosAsegurados.Rows.Count == 0)
                {
                    otrosAsegurados = new DataTable();
                    column = new DataColumn();
                    column.DataType = System.Type.GetType("System.String");
                    column.AllowDBNull = true;
                    column.Caption = "Cedula";
                    column.ColumnName = "Cedula";

                    otrosAsegurados.Columns.Add(column);

                    column = new DataColumn();
                    column.DataType = System.Type.GetType("System.String");
                    column.AllowDBNull = true;
                    column.Caption = "Nombre";
                    column.ColumnName = "Nombre";
                    otrosAsegurados.Columns.Add(column);

                    column = new DataColumn();
                    column.DataType = System.Type.GetType("System.String");
                    column.AllowDBNull = true;
                    column.Caption = "Apellidos";
                    column.ColumnName = "Apellidos";
                    otrosAsegurados.Columns.Add(column);

                    column = new DataColumn();
                    column.DataType = System.Type.GetType("System.String");
                    column.AllowDBNull = true;
                    column.Caption = "Fecha Nacimiento";
                    column.ColumnName = "Fecha Nacimiento";
                    otrosAsegurados.Columns.Add(column);

                    column = new DataColumn();
                    column.DataType = System.Type.GetType("System.String");
                    column.AllowDBNull = true;
                    column.Caption = "Parentesco";
                    column.ColumnName = "Parentesco";
                    otrosAsegurados.Columns.Add(column);

                    column = new DataColumn();
                    column.DataType = System.Type.GetType("System.String");
                    column.AllowDBNull = true;
                    column.Caption = "Plan";
                    column.ColumnName = "Plan";
                    otrosAsegurados.Columns.Add(column);

                    column = new DataColumn();
                    column.DataType = System.Type.GetType("System.String");
                    column.AllowDBNull = true;
                    column.Caption = "Prima";
                    column.ColumnName = "Prima";
                    otrosAsegurados.Columns.Add(column);
                }
            }

            Session["otrosAsegurados"] = otrosAsegurados;

            if (!IsPostBack)
            {
                if (dtCertificadoFull.Rows.Count > 0)
                {
                    if ((string)Session["operacionCertificado"] == "modificar" || int.Parse(Session["pro_Id"].ToString()) == 99)
                    {
                        grvBeneficiarioPrincipal.DataSource = dtBeneficiario;
                        grvBeneficiarioPrincipal.DataBind();

                    }
                    else
                    {
                        grvBeneficiarioPrincipal.DataSource = dtBeneficiario;
                        grvBeneficiarioPrincipal.DataBind();
                        //GridViewRow rowPrincipales = grvBeneficiarioPrincipal.Rows[0];
                        //rowPrincipales.Visible = false;
                    }
                }
                else
                {
                    //grvBeneficiarioPrincipal.DataSource = dtBeneficiario;
                    //grvBeneficiarioPrincipal.DataBind();
                    //GridViewRow rowPrincipales2 = grvBeneficiarioPrincipal.Rows[0];
                    //rowPrincipales2.Visible = false;
                    DataTable dtBeneficiarioVacio = dtBeneficiario.Clone();
                    DataRow drBeneficiarioVacio = dtBeneficiarioVacio.NewRow();
                    dtBeneficiarioVacio.Rows.Add(drBeneficiarioVacio);
                    grvBeneficiarioPrincipal.DataSource = dtBeneficiarioVacio;
                    grvBeneficiarioPrincipal.DataBind();
                    //grvBeneficiarioPrincipal.Rows[0].Visible = false;
                    grvBeneficiarioPrincipal.Rows[0].Controls.Clear();
                }
            }
            if (!IsPostBack)
            {
                if (dtCertificadoFull.Rows.Count > 0)
                {
                    if ((string)Session["operacionCertificado"] == "modificar" || int.Parse(Session["pro_Id"].ToString()) == 99)
                    {
                        grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyuge;
                        grvBeneficiarioConyuge.DataBind();
                    }
                    else
                    {
                        grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyuge;
                        grvBeneficiarioConyuge.DataBind();
                        GridViewRow rowConyuge = grvBeneficiarioConyuge.Rows[0];
                        rowConyuge.Visible = false;
                    }
                }
                else
                {
                    //grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyuge;
                    //grvBeneficiarioConyuge.DataBind();
                    //GridViewRow rowConyuges = grvBeneficiarioConyuge.Rows[0];
                    //rowConyuges.Visible = false;
                    DataTable dtBeneficiarioConyugeVacio = dtBeneficiarioConyuge.Clone();
                    DataRow drBeneficiarioConyugeVacio = dtBeneficiarioConyugeVacio.NewRow();
                    dtBeneficiarioConyugeVacio.Rows.Add(drBeneficiarioConyugeVacio);
                    grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyugeVacio;
                    grvBeneficiarioConyuge.DataBind();
                    //grvBeneficiarioConyuge.Rows[0].Visible = false;
                    grvBeneficiarioConyuge.Rows[0].Controls.Clear();
                }
                //JC 22-09-2015
                try
                {
                    int cer_Id = int.Parse(Session["cer_id"].ToString());
                    //dtEncabezadoCertificado = AdministrarCertificados.spConsultarEncabezadoCertificado(int.Parse(Session["cer_Id"].ToString()));
                    DataTable dtEncabezadoCertificado = new DataTable();
                    dtEncabezadoCertificado = AdministrarCertificados.spConsultarEncabezadoCertificado(cer_Id);
                    txtCompania.Text = dtEncabezadoCertificado.Rows[0]["com_Nombre"].ToString();
                    ddlProducto.DataTextField = "pro_Nombre"; // Cargamos lo que aparece en el ddl
                    ddlProducto.DataValueField = "pro_Id"; // Cargamos lo que vale por debajo
                    ddlProducto.DataSource = dtEncabezadoCertificado;
                    ddlProducto.DataBind();
                    if (AdministrarCertificados.certificadoPre.Migracion != "2")
                        txtEstadoNegocio.Text = dtEncabezadoCertificado.Rows[0]["cer_EstadoNegocio"].ToString();
                    //txtTipoMovimiento.Text = dtEncabezadoCertificado.Rows[0]["Principal"].ToString() + ", " + dtEncabezadoCertificado.Rows[0]["Conyuge"].ToString() + " Y " + dtEncabezadoCertificado.Rows[0]["Conyuge"].ToString();
                    txtmesProduccion.Text = dtEncabezadoCertificado.Rows[0]["MesProduccion"].ToString();
                    Session["dtEncabezadoCertificado"] = dtEncabezadoCertificado;
                }
                catch { }

                if ((string)Session["operacionCertificado"] == "modificar" || (int.Parse(Session["pro_Id"].ToString()) == 99 && dtCertificadoFull.Rows.Count > 0))
                {
                    int pagaduria = int.Parse(AdministrarCertificados.consultarConvenioPorPagaduria(txtPagaduriaPrincipal.Text, dtCertificadoFull.Rows[0]["Localidad"].ToString()).Rows[0]["paga_Id"].ToString());
                    DataTable dt = new DataTable();
                    dt = AdministrarCertificados.consultarConvenios(int.Parse(ddlProducto.SelectedValue.ToString()), int.Parse(ddlLocalidadCertificado.SelectedValue.ToString()), pagaduria);
                    ddlConvenioPrincipal.DataTextField = "con_Nombre";
                    ddlConvenioPrincipal.DataValueField = "con_Id";
                    ddlConvenioPrincipal.DataSource = dt;
                    ddlConvenioPrincipal.DataBind();
                    ddlConvenioPrincipal.Items.Insert(0, new ListItem("", ""));
                    ddlConvenioPrincipal.SelectedIndex = ddlConvenioPrincipal.Items.IndexOf(ddlConvenioPrincipal.Items.FindByValue(dtCertificadoFull.Rows[0]["cer_Convenio"].ToString()));
                }

                Session["dtCertificadoFull"] = dtCertificadoFull;

            }

            if (!IsPostBack)
            {
                DataTable dt = new DataTable();
                dt = AdministrarCertificados.consultarParentesco(int.Parse(AdministrarCertificados.certificadoPre.Producto));
                ddlParentesoOtro.DataTextField = "par_Nombre";
                ddlParentesoOtro.DataValueField = "par_Id";
                ddlParentesoOtro.DataSource = dt;
                ddlParentesoOtro.DataBind();
                ddlParentesoOtro.Items.Insert(0, new ListItem("", ""));
            }
            /*------------------------------------------------*/
            if (!IsPostBack)
            {
                DataTable dt = new DataTable();
                dt = AdministrarTercero.asegurado.sp_MostrarTipoDocumento();
                ddlTipoDocumentoTercero.DataTextField = "tipDoc_Nombre"; // Cargamos lo que aparece en el ddl
                ddlTipoDocumentoTercero.DataValueField = "tipDoc_Id"; // Cargamos lo que vale por debajo
                ddlTipoDocumentoTercero.DataSource = dt;
                ddlTipoDocumentoTercero.DataBind();
                ddlTipoDocumentoTercero.Items.Insert(0, new ListItem("", ""));
            }

            if (!IsPostBack)
            {
                DataTable dt = new DataTable();
                dt = AdministrarTercero.asegurado.sp_MostrarDepartamento();
                ddlDepartamento.DataTextField = "dep_Nombre"; // Cargamos lo que aparece en el ddl
                ddlDepartamento.DataValueField = "dep_Id"; // Cargamos lo que vale por debajo
                ddlDepartamento.DataSource = dt;
                ddlDepartamento.DataBind();
                ddlDepartamento.Items.Insert(0, new ListItem("", ""));
            }

            if (!IsPostBack)
            {
                DataTable dt = new DataTable();
                dt = AdministrarTercero.asegurado.sp_MostrarOcupacion();
                ddlOcupacionTercero.DataTextField = "ocu_Nombre"; // Cargamos lo que aparece en el ddl
                ddlOcupacionTercero.DataValueField = "ocu_Id"; // Cargamos lo que vale por debajo
                ddlOcupacionTercero.DataSource = dt;
                ddlOcupacionTercero.DataBind();
                ddlOcupacionTercero.Items.Insert(0, new ListItem("", ""));
            }

            if (!IsPostBack)
            {
                DataTable dt = new DataTable();
                dt = AdministrarTercero.asegurado.sp_ConsultarEstadoCivil();
                ddlEstadoCivilTercero.DataTextField = "estCiv_Nombre"; // Cargamos lo que aparece en el ddl
                ddlEstadoCivilTercero.DataValueField = "estCiv_Id"; // Cargamos lo que vale por debajo
                ddlEstadoCivilTercero.DataSource = dt;
                ddlEstadoCivilTercero.DataBind();
                ddlEstadoCivilTercero.Items.Insert(0, new ListItem("", ""));
            }

            /*-----------------------------------------------------*/
            if (!IsPostBack)
            {
                DataTable dt = new DataTable();
                dt = AdministrarTercero.asegurado.sp_MostrarTipoDocumento();
                ddlTipoDocumentoOtros.DataTextField = "tipDoc_Nombre"; // Cargamos lo que aparece en el ddl
                ddlTipoDocumentoOtros.DataValueField = "tipDoc_Id"; // Cargamos lo que vale por debajo
                ddlTipoDocumentoOtros.DataSource = dt;
                ddlTipoDocumentoOtros.DataBind();
                ddlTipoDocumentoOtros.Items.Insert(0, new ListItem("", ""));
            }

            if (!IsPostBack)
            {
                DataTable dt = new DataTable();
                dt = AdministrarTercero.asegurado.sp_MostrarDepartamento();
                ddlDepartamentoOtros.DataTextField = "dep_Nombre"; // Cargamos lo que aparece en el ddl
                ddlDepartamentoOtros.DataValueField = "dep_Id"; // Cargamos lo que vale por debajo
                ddlDepartamentoOtros.DataSource = dt;
                ddlDepartamentoOtros.DataBind();
                ddlDepartamentoOtros.Items.Insert(0, new ListItem("", ""));
            }

            if (!IsPostBack)
            {
                DataTable dt = new DataTable();
                dt = AdministrarTercero.asegurado.sp_MostrarOcupacion();
                ddlOcupacionOtros.DataTextField = "ocu_Nombre"; // Cargamos lo que aparece en el ddl
                ddlOcupacionOtros.DataValueField = "ocu_Id"; // Cargamos lo que vale por debajo
                ddlOcupacionOtros.DataSource = dt;
                ddlOcupacionOtros.DataBind();
                ddlOcupacionOtros.Items.Insert(0, new ListItem("", ""));
            }

            if (txtCedulaConyuge.Text == "")
            {
                ddlPlanConyuge.Enabled = false;
                grvAmparoConyuge.Visible = false;
                btnExtraPrima2.Visible = false;
                btnLimpiar.Visible = false;
            }
            else
            {
                ddlPlanConyuge.Enabled = true;
                grvAmparoConyuge.Visible = true;
                grvBeneficiarioConyuge.Visible = true;
                beneficiariosConyuge.Visible = true;
                btnExtraPrima2.Visible = true;
                btnLimpiar.Visible = true;
            }

            if (ddlPlanConyuge.SelectedValue != "")
            {
                amparosConyuge.Visible = true;
            }
            else
            {
                amparosConyuge.Visible = false;
            }

            if (ddlPlanPrincipal.SelectedValue != "")
            {
                amparosPrincipal.Visible = true;
            }
            else
            {
                amparosPrincipal.Visible = false;
            }

            if (!IsPostBack)
            {
                DataTable dt = new DataTable();
                dt = AdministrarTercero.asegurado.sp_ConsultarEstadoCivil();
                ddlEstadoCivilOtros.DataTextField = "estCiv_Nombre"; // Cargamos lo que aparece en el ddl
                ddlEstadoCivilOtros.DataValueField = "estCiv_Id"; // Cargamos lo que vale por debajo
                ddlEstadoCivilOtros.DataSource = dt;
                ddlEstadoCivilOtros.DataBind();
                ddlEstadoCivilOtros.Items.Insert(0, new ListItem("", ""));

                if (txtCedulaOtro.Text != "" && ddlPoliza.Text != "")
                {
                    ddlParentesoOtro.Enabled = true;
                }
                else
                {
                    ddlParentesoOtro.Enabled = false;
                }

                if (ddlPoliza.Text != "" && txtCedulaOtro.Text != "" && ddlParentesoOtro.Text != "")
                {
                    ddlPlanOtros.Enabled = true;
                }
                else
                {
                    ddlPlanOtros.Enabled = false;
                }

                if (ddlPoliza.Text == "")
                {
                    ddlPlanPrincipal.Enabled = false;
                }
                else
                {
                    if (AdministrarCertificados.certificadoPre.Migracion != "2" && AdministrarCertificados.certificadoPre.Migracion != "3")
                        ddlPlanPrincipal.Enabled = true;
                }

                if (ddlPoliza.Text != "" && txtCedulaConyuge.Text != "")
                {
                    ddlPlanConyuge.Enabled = true;
                }
                else
                {
                    ddlPlanConyuge.Enabled = false;
                }

                if (ddlLocalidadCertificado.Text == "")
                {
                    ddlPoliza.Enabled = false;
                }
                else
                {
                    if (AdministrarCertificados.certificadoPre.Migracion != "2" && AdministrarCertificados.certificadoPre.Migracion != "3")
                        ddlPoliza.Enabled = true;
                }

                //txtPlanPrincipal.Text = "";
                //txtPlanConyuge.Text = "";

                if (ddlPoliza.Text != "")
                {
                    txtPlanPrincipal.Enabled = true;
                }
                else
                {
                    txtPlanPrincipal.Enabled = false;
                }
                if (ddlPoliza.Text != "" && txtCedulaConyuge.Text != "")
                {
                    txtPlanConyuge.Enabled = true;
                }
                else
                {
                    txtPlanConyuge.Enabled = false;
                }
                txtFechaDigitacionCertificado.Text = DateTime.Now.ToString("dd/MM/yyyy");


                if (ddlPoliza.SelectedValue != "")
                {
                    txtDocumentoOtros.Enabled = true;
                    txtDocumentoConyugue.Enabled = true;



                    DataTable dtPoliza = new DataTable();
                    if ((string)Session["operacionCertificado"] == "modificar")
                    {
                        DataTable permaneciaAsegurado = new DataTable();
                        int permaneciaAseguradoCertificado = 0;

                        permaneciaAsegurado = AdministrarCertificados.ConsultarFechaExpedicionCertificadoAnterior(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()));
                        permaneciaAseguradoCertificado = Funciones.FechaIngresoAsegurado(DateTime.Parse(permaneciaAsegurado.Rows[0]["cer_FechaExpedicion"].ToString()), DateTime.Parse(dtCertificadoFull.Rows[0]["ter_FechaNacimiento"].ToString()));

                        dtPoliza = AdministrarCertificados.consultarPlanPorPolizaPermanencia(int.Parse(ddlPoliza.SelectedValue.ToString()), 1, permaneciaAseguradoCertificado);
                    }
                    else
                    {
                        dtPoliza = AdministrarCertificados.consultarPlanPorPoliza(int.Parse(ddlPoliza.SelectedValue.ToString()), 1, int.Parse(txtEdadPrincipal.Text));
                    }

                    if (AdministrarCertificados.certificadoPre.Migracion != "2")
                    {
                        ddlPlanPrincipal.DataSource = dtPoliza;
                        ddlPlanPrincipal.DataValueField = "plapol_Id";
                        ddlPlanPrincipal.DataTextField = "plan_ValAsegurado";
                        ddlPlanPrincipal.DataBind();
                        //ddlPlanPrincipal.Items.Insert(0, new ListItem("", ""));
                    }

                    if (dtPoliza.Rows.Count > 0)
                    {
                        Session["plapol_Id"] = dtPoliza.Rows[0]["plapol_Id"].ToString();
                        if (txtCedulaOtro.Text != "" && ddlPoliza.Text != "")
                        {
                            ddlParentesoOtro.Enabled = true;
                        }
                        else
                        {
                            ddlParentesoOtro.Enabled = false;

                        }

                        if (ddlPoliza.Text != "")
                        {
                            txtPlanPrincipal.Enabled = true;
                        }
                        else
                        {
                            txtPlanPrincipal.Enabled = false;
                        }

                        if (ddlPoliza.Text == "")
                        {
                            ddlPlanPrincipal.Enabled = false;
                        }
                        else
                        {
                            if (AdministrarCertificados.certificadoPre.Migracion != "2")
                                ddlPlanPrincipal.Enabled = true;
                        }

                        if (ddlPoliza.Text != "" && txtCedulaConyuge.Text != "")
                        {
                            ddlPlanConyuge.Enabled = true;
                        }
                        else
                        {
                            ddlPlanConyuge.Enabled = false;
                        }
                    }
                    if (ddlPlanPrincipal.Enabled == true)
                        ddlPlanPrincipal.SelectedIndex = ddlPlanPrincipal.Items.IndexOf(ddlPlanPrincipal.Items.FindByValue(dtCertificadoFull.Rows[0]["pla_Id"].ToString()));
                }

            }
        }

        if (txtCedulaConyuge.Text != "")
        {
            grvBeneficiarioConyuge.Visible = true;
            beneficiariosConyuge.Visible = true;
        }
        else
        {
            grvBeneficiarioConyuge.Visible = false;
            beneficiariosConyuge.Visible = false;
        }

        if (!IsPostBack)
        {
            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "RECUERDE VALIDAR SECUENCIALMENTE LOS FORMULARIOS" + "');", true);

        }

        if (!IsPostBack)
        {
            if ((string)Session["operacionCertificado"] == "modificar")
            {
                if (grvBeneficiarioConyuge.Rows.Count == 1)
                {
                    //grvBeneficiarioConyuge.Rows[0].Visible = true;
                }
            }
            else
            {
                DataTable dtCasesp_IdPreCargue = new DataTable();
                dtCasesp_IdPreCargue = AdministrarCertificados.ConsultarCasoEspecialPreCargue(int.Parse(txtCertificado.Text), int.Parse(ddlProducto.SelectedValue.ToString()), int.Parse(txtCedulaPrincipal.Text));
                if (int.Parse(dtCasesp_IdPreCargue.Rows[0]["casesp_Id"].ToString()) != 2)
                {
                    grvBeneficiarioPrincipal.Rows[0].Visible = false;
                }
                if (grvBeneficiarioConyuge.Rows.Count > 0)
                {
                    grvBeneficiarioConyuge.Rows[0].Visible = false;
                }
            }
        }
    }

    protected void ConsultarAmparosPlan(object sender, EventArgs e)
    {
        try
        {
            DataTable dtEliminarPrincipal = (DataTable)Session["dtEliminarPrincipal"];
            DataTable dtEncabezadoCertificado = (DataTable)Session["dtEncabezadoCertificado"];
            DataTable dtExtraprimaPrincipal = (DataTable)Session["dtExtraprimaPrincipal"];
            DataTable dtExtraprimaPrincipalRestaurar = new DataTable();
            double totalExtraPrimaP = 0;
            double diferenciaValorAsegurado = 0;
            double totalExtraPrimaP3 = 0;
            txtDocumentoConyugue.Enabled = true;
            int cer_IdNuevo = 0;
            cer_IdNuevo = AdministrarCertificados.ConsultarIdCertificado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "", "");
            Session["cerId_ValorNuevo"] = cer_IdNuevo;

            int cer_IdAnterior = 0;
            DataTable dtCer_IdExtraPrima = AdministrarCertificados.ConsultarCertificadosAnteriores(int.Parse(Session["cerId_ValorNuevo"].ToString()));
            cer_IdAnterior = int.Parse(dtCer_IdExtraPrima.Rows[0]["cer_IdAnterior"].ToString());

            //DataTable dtCer_Id = new DataTable();
            //dtCer_Id = AdministrarCertificados.sp_ConsultarIdCertificadoValorAsegurado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "VIGENTE", "PRODUCCION NUEVA");
            // Validar que el plan escogido pueda ser seleccionado por los cúmulos
            DataTable dtCumuloValor = new DataTable();
            double valorAsegurado = 0;
            dtCumuloValor = AdministrarCertificados.spConsultarCumulo(int.Parse(dtEncabezadoCertificado.Rows[0]["com_Id"].ToString()));
            valorAsegurado = AdministrarCertificados.spConsultarValoresAsegurado(int.Parse(dtEncabezadoCertificado.Rows[0]["com_Id"].ToString()), int.Parse(txtCedulaPrincipal.Text));
            DataTable dtValorVigente = new DataTable();
            dtValorVigente = AdministrarCertificados.ConsultarEstadoNegocioPorCerId(cer_IdAnterior);
            if (dtValorVigente.Rows[0]["cer_EstadoNegocio"].ToString() == "VIGENTE")
            {
                valorAsegurado = valorAsegurado - double.Parse(Session["valorAseguradoPrincipalResta"].ToString());
            }
         
            if ((valorAsegurado + double.Parse(ddlPlanPrincipal.SelectedItem.ToString())) <= double.Parse(dtCumuloValor.Rows[0]["cum_Nombre"].ToString()))
            {
                if (ddlPlanPrincipal.SelectedItem.ToString() != "")
                {
                    if ((string)Session["operacionCertificado"] == "modificar")
                    {
                        dtEliminarPrincipal = AdministrarCertificados.consultarAmparosPorPlanPermanencia(int.Parse(ddlPlanPrincipal.SelectedValue.ToString()), int.Parse(txtEdadPrincipal.Text), 0, int.Parse(Session["cer_id"].ToString()), 1);
                        //Cargar un dt con la informacion que posteriormente iria a la tabla extra prima
                        dtExtraprimaPrincipal = AdministrarCertificados.consultarAmparosPorPlanPermanencia(int.Parse(ddlPlanPrincipal.SelectedValue.ToString()), int.Parse(txtEdadPrincipal.Text), 0, int.Parse(Session["cer_id"].ToString()), 1);

                        DataTable dtConsultarValorAseguradoExtraPrima = new DataTable();
                        dtConsultarValorAseguradoExtraPrima = AdministrarCertificados.ConsultarValorAseguradoExtraPrima(cer_IdAnterior, 1);

                        double valorAseguradoExtraPrima = 0;
                        double valorAseguradoDt = 0;
                        double TasaDt = 0;
                        double primaDt = 0;

                        //Recorrer el dt con el que se lleno la tabla extra prima
                        foreach (DataRow dt in dtExtraprimaPrincipal.Rows)
                        {
                            //recorrer el dt con los valores del certificado anterior 
                            foreach (DataRow dt2 in dtConsultarValorAseguradoExtraPrima.Rows)
                            {
                                //condicional que pregunta cuando los nombres de los dos dt coinciden en el nombre
                                if (dt["Amparo"].ToString() == dt2["ampcer_Nombre"].ToString())
                                {
                                    //asigna el valor asegurado del primer dt a esta variable
                                    valorAseguradoDt = double.Parse(dt["Valor Asegurado"].ToString());
                                    //asignala tasa del primer dt a esta variable
                                    TasaDt = double.Parse(dt["Tasa"].ToString());
                                    //Asigna esta varible al valor asegurado del segundo dt
                                    valorAseguradoExtraPrima = double.Parse(dt2["ampcer_ValAsegurado"].ToString());
                                    //Resta el valor de la primera variable contra valorAseguradoExtraPrima y se la asigna a una variable
                                    diferenciaValorAsegurado = valorAseguradoDt - valorAseguradoExtraPrima;
                                    //Condicional en el que entra cuando el primer dt este pasando por la final de vida
                                    if (dt["Amparo"].ToString() == "VIDA")
                                    {
                                        // asigna un valor a una session
                                        Session["diferenciaValorAseguradoP"] = diferenciaValorAsegurado;
                                    }
                                    // asigna una variable a un campo del primer dt
                                    dt["Valor Asegurado"] = diferenciaValorAsegurado;
                                    //realiza una operacion para saber el valor de la prima
                                    primaDt = (TasaDt * diferenciaValorAsegurado) / 1000000;
                                    //asigna la vartiable de prima a un campo del dt
                                    dt["Prima"] = primaDt;
                                }
                            }
                            //Crea un dt nuevo el cual sera un clon de la tabla extra prima fila por fila 

                            dtExtraprimaPrincipalRestaurar = dtExtraprimaPrincipal.Clone();
                            foreach (DataRow row in dtExtraprimaPrincipal.Rows)
                            {
                                DataRow row2 = dtExtraprimaPrincipalRestaurar.NewRow();
                                row2.ItemArray = row.ItemArray;
                                dtExtraprimaPrincipalRestaurar.Rows.Add(row2);
                            }
                            // asigna este dt a la session 
                            Session["dtExtraprimaPrincipalRestaurar"] = dtExtraprimaPrincipalRestaurar;
                        }
                    }
                    else
                    {
                        int ocupacion = int.Parse(ddlOcupacionPrincipal.SelectedValue.ToString());
                        dtEliminarPrincipal = AdministrarCertificados.consultarAmparosPorPlan(int.Parse(ddlPlanPrincipal.SelectedValue.ToString()), int.Parse(txtEdadPrincipal.Text), 0, ocupacion);
                        dtExtraprimaPrincipal = AdministrarCertificados.consultarAmparosPorPlan(int.Parse(ddlPlanPrincipal.SelectedValue.ToString()), int.Parse(txtEdadPrincipal.Text), 0, ocupacion);
                        dtExtraprimaPrincipalRestaurar = dtExtraprimaPrincipal.Clone();
                        foreach (DataRow row in dtExtraprimaPrincipal.Rows)
                        {
                            DataRow row2 = dtExtraprimaPrincipalRestaurar.NewRow();
                            row2.ItemArray = row.ItemArray;
                            dtExtraprimaPrincipalRestaurar.Rows.Add(row2);
                        }
                        // asigna este dt a la session 
                        Session["dtExtraprimaPrincipalRestaurar"] = dtExtraprimaPrincipalRestaurar;
                        grvAmparoPrincipal.DataSource = dtEliminarPrincipal;
                        grvAmparoPrincipal.DataBind();


                    }

                    double totales = 0;
                    foreach (GridViewRow row in grvAmparoPrincipal.Rows)
                    {
                        totales += Convert.ToDouble(row.Cells[4].Text);
                    }

                    //txtPrimaPrincipal.Text = Convert.ToString(totales);

                    grvAmparoPrincipal.DataSource = dtEliminarPrincipal;
                    grvAmparoPrincipal.DataBind();

                    // Cargar tabla de amparos para ingresar la extraprima
                    grvAmparoExtraPrima.DataSource = dtExtraprimaPrincipal;
                    grvAmparoExtraPrima.DataBind();

                    // crea dt el cual contiene la informacion del historial del cliente en todos los amparos y se lo asigna a la tabla de historial
                    DataSet dsConsultarHistirialPorcentajeExtraPrimado = new DataSet();
                    dsConsultarHistirialPorcentajeExtraPrimado = AdministrarCertificados.ConsultarHistirialPorcentajeExtraPrimado(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 1);

                    DataTable dtConsultarHistirialPorcentajeExtraPrimado = new DataTable();
                    foreach (DataTable dt in dsConsultarHistirialPorcentajeExtraPrimado.Tables)
                    {
                        dtConsultarHistirialPorcentajeExtraPrimado.Merge(dt);
                    }
                    grvConsultarHistirialPorcentajeExtraPrimado.DataSource = dtConsultarHistirialPorcentajeExtraPrimado;
                    grvConsultarHistirialPorcentajeExtraPrimado.DataBind();

                    //Consulta el historial del cliente pero general
                    DataTable dtConsultarHistorialExtraPrima = new DataTable();
                    dtConsultarHistorialExtraPrima = AdministrarCertificados.ConsultarHistorialExtraPrima(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 1);
                    grvHistorialExtraPrima.DataSource = dtConsultarHistorialExtraPrima;
                    grvHistorialExtraPrima.DataBind();

                    double consultarHistorialExtraPrima = 0;
                    double valorExtraPrima = 0;

                    //Condicional en el cual entra si el cliente ya tiene un historial damparos  para asignar valores
                    if (dtConsultarHistorialExtraPrima.Rows.Count > 0)
                    {
                        // Recorre el dt para consultar los valores de prima y extra prima
                        foreach (DataRow dtConsultarHistorialExtraPrimaForeach in dtConsultarHistorialExtraPrima.Rows)
                        {
                            consultarHistorialExtraPrima += double.Parse(dtConsultarHistorialExtraPrimaForeach["Prima"].ToString());
                            valorExtraPrima += double.Parse(dtConsultarHistorialExtraPrimaForeach["Extra Prima"].ToString());
                        }
                    }

                    //recorre tabla de extra prima para la suma de primas 
                    foreach (GridViewRow row in grvAmparoExtraPrima.Rows)
                    {
                        totalExtraPrimaP += Convert.ToDouble(row.Cells[4].Text);
                    }

                    // Asignar variables con valores a los campos de prima y extra prima 
                    
                    totalExtraPrimaP3 = totalExtraPrimaP;
                    totalExtraPrimaP3 = consultarHistorialExtraPrima + totalExtraPrimaP3;
                    txtPrimaPrincipalExtraprima.Text = totalExtraPrimaP3.ToString();
                    txtPrimaPrincipal.Text = totalExtraPrimaP3.ToString();
                    txtExtraPrimaPrincipal.Text = txtPrincipalExtraprima.Text;

                    int primaPrincipal = int.Parse(Math.Round(decimal.Parse(txtPrimaPrincipal.Text)).ToString());
                    txtPrimaPrincipal.Text = primaPrincipal.ToString();
                    int PrimaPrincipalExtraprima = int.Parse(Math.Round(decimal.Parse(txtPrimaPrincipalExtraprima.Text)).ToString());
                    txtPrimaPrincipalExtraprima.Text = PrimaPrincipalExtraprima.ToString();
                    int ExtraPrimaPrincipal = int.Parse(Math.Round(decimal.Parse(txtExtraPrimaPrincipal.Text)).ToString());
                    txtExtraPrimaPrincipal.Text = ExtraPrimaPrincipal.ToString();
                }
                else
                {
                    dtEliminarPrincipal.Clear();
                    grvAmparoPrincipal.DataSource = dtEliminarPrincipal;
                    grvAmparoPrincipal.DataBind();
                }
            }
            else
            {
                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL VALOR DEL PLAN SUPERA EL ACEPTADO POR LA COMPAÑÍA PARA SUS LOS PRODUCTOS" + "');", true);
            }

            sumarPrima();
            Session["dtEliminarPrincipal"] = dtEliminarPrincipal;
            Session["dtExtraprimaPrincipal"] = dtExtraprimaPrincipal;
            Session["TotalExtraPrimaP"] = totalExtraPrimaP;
            Session["dtExtraPrimaPrincipalGuardarFinal"] = dtExtraprimaPrincipal;
        }
        catch
        {
            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "POR FAVOR Seleccione UN PLAN" + "');", true);
        }
    }

    //metodo para buscar un tercero con su cedula desde conyuge "SEBASTIAN"
    protected void ConsultarTerceroCertificado(object sender, EventArgs e)
    {

        DataTable dtEliminarConyuge = (DataTable)Session["dtEliminarConyuge"];

        int cer_IdNuevo = 0;
        cer_IdNuevo = AdministrarCertificados.ConsultarIdCertificado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "", "");
        Session["cerId_ValorNuevo"] = cer_IdNuevo;

        int cer_IdAnterior = 0;
        DataTable dtCer_IdExtraPrima = AdministrarCertificados.ConsultarCertificadosAnteriores(int.Parse(Session["cerId_ValorNuevo"].ToString()));
        cer_IdAnterior = int.Parse(dtCer_IdExtraPrima.Rows[0]["cer_IdAnterior"].ToString());

        string mensaje = AdministrarCertificados.ConsultarTerceroCertificado(int.Parse(txtDocumentoConyugue.Text));

        txtNombreConyuge.Text = AdministrarCertificados.aseguradoBusqueda.Nombres;
        txtApellidoConyuge.Text = AdministrarCertificados.aseguradoBusqueda.Apellidos;
        txtCedulaConyuge.Text = AdministrarCertificados.aseguradoBusqueda.NumeroDocumento;
        txtEdadConyuge.Text = Funciones.Edad(AdministrarCertificados.aseguradoBusqueda.FechaNacimiento).ToString();

        if (ddlPoliza.Text != "" && txtCedulaConyuge.Text != "")
        {
            txtPlanConyuge.Enabled = true;
        }
        else
        {
            txtPlanConyuge.Enabled = false;
        }

        if (ddlPlanConyuge.SelectedValue != "")
        {
            amparosConyuge.Visible = true;
        }
        else
        {
            amparosConyuge.Visible = false;
        }

        if (ddlPlanPrincipal.SelectedValue != "")
        {
            amparosPrincipal.Visible = true;
        }
        else
        {
            amparosPrincipal.Visible = false;
        }

        if (txtCedulaConyuge.Text != "")
        {
            btnSiguienteConyuge.Enabled = false;
            ddlPlanConyuge.Enabled = true;
            grvAmparoConyuge.Visible = true;
            grvBeneficiarioConyuge.Visible = true;
            beneficiariosConyuge.Visible = true;
            btnExtraPrima2.Visible = true;
            btnLimpiar.Visible = true;
            txtPeso.Enabled = true;
            txtEstatura.Enabled = true;
            btnValidarConyuge.Visible = true;

            DataTable dt = new DataTable();
            dt = AdministrarCertificados.consultarPlanPorPoliza(int.Parse(ddlPoliza.SelectedValue.ToString()), 2, int.Parse(txtEdadConyuge.Text));
            ddlPlanConyuge.DataSource = dt;
            ddlPlanConyuge.DataValueField = "plapol_Id";
            ddlPlanConyuge.DataTextField = "plan_ValAsegurado";
            ddlPlanConyuge.DataBind();
            ddlPlanConyuge.Items.Insert(0, new ListItem("", ""));
            ddlPlanConyuge.Attributes.Add("onclick", "localStorage.setItem('accIndex', 2);");
            Session["plapol_IdConyuge"] = dt.Rows[0]["plapol_Id"].ToString();

            //// Crear Tabla de Beneficiarios
            //DataTable dtBeneficiarioConyuge = new DataTable();
            //dtBeneficiarioConyuge = new DataTable();
            //DataColumn column = new DataColumn();
            //column.DataType = System.Type.GetType("System.String");
            //column.AllowDBNull = true;
            //column.Caption = "NumeroDocumento";
            //column.ColumnName = "NumeroDocumento";
            //dtBeneficiarioConyuge.Columns.Add(column);

            //column = new DataColumn();
            //column.DataType = System.Type.GetType("System.String");
            //column.AllowDBNull = true;
            //column.Caption = "Apellidos";
            //column.ColumnName = "Apellidos";
            //dtBeneficiarioConyuge.Columns.Add(column);

            //column = new DataColumn();
            //column.DataType = System.Type.GetType("System.String");
            //column.AllowDBNull = true;
            //column.Caption = "Nombres";
            //column.ColumnName = "Nombres";
            //dtBeneficiarioConyuge.Columns.Add(column);

            //column = new DataColumn();
            //column.DataType = System.Type.GetType("System.String");
            //column.AllowDBNull = true;
            //column.Caption = "Edad";
            //column.ColumnName = "Edad";
            //dtBeneficiarioConyuge.Columns.Add(column);

            //column = new DataColumn();
            //column.DataType = System.Type.GetType("System.String");
            //column.AllowDBNull = true;
            //column.Caption = "Porcentaje";
            //column.ColumnName = "Porcentaje";
            //dtBeneficiarioConyuge.Columns.Add(column);

            //column = new DataColumn();
            //column.DataType = System.Type.GetType("System.String");
            //column.AllowDBNull = true;
            //column.Caption = "Parentesco";
            //column.ColumnName = "Parentesco";
            //dtBeneficiarioConyuge.Columns.Add(column);

            //lLENAR PRIMERA FILA DE LA TABLA BENEFIACIARIOS  
            DataTable dtBeneficiarioPruebaConyuge = new DataTable();
            dtBeneficiarioPruebaConyuge = AdministrarCertificados.ConsultarBeneficiarioUnico();
            grvBeneficiarioConyuge.DataSource = dtBeneficiarioPruebaConyuge;
            grvBeneficiarioConyuge.DataBind();
            GridViewRow rowConyuge = grvBeneficiarioConyuge.Rows[0];
            rowConyuge.Visible = false;

            //grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyuge;
            //grvBeneficiarioConyuge.DataBind();
            //grvBeneficiarioConyuge.Enabled = true;
        }
        else
        {
            btnSiguienteConyuge.Enabled = true;
            ddlPlanConyuge.Enabled = false;
            grvAmparoConyuge.Visible = false;
            grvBeneficiarioConyuge.Visible = false;
            beneficiariosConyuge.Visible = false;
            btnExtraPrima2.Visible = false;
            btnLimpiar.Visible = false;
            txtPeso.Enabled = false;
            txtEstatura.Enabled = false;
            btnValidarConyuge.Visible = false;
        }

        int cer_Id = int.Parse(Session["cer_id"].ToString());

        if ((string)Session["operacionCertificado"] == "modificar")
        {
            DataTable dtBeneficiarioConyuge = (DataTable)Session["dtBeneficiarioConyuge"];
            // if ( dtBeneficiarioConyuge.Rows.Count > 0 )
            //{
            dtBeneficiarioConyuge = AdministrarCertificados.ConsultarBeneficiarioModificacion(cer_IdAnterior, int.Parse(txtCedulaConyuge.Text), 2);
            grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyuge;
            grvBeneficiarioConyuge.DataBind();
            //}

            if (ddlPlanConyuge.SelectedValue != "")
            {
                dtEliminarConyuge = AdministrarCertificados.consultarAmparosPorPlanModificacion(cer_IdAnterior, 2);
                grvAmparoConyuge.DataSource = dtEliminarConyuge;
                grvAmparoConyuge.DataBind();

                double ValorCampoPrimaTxtConyuge = 0;

                foreach (DataRow dtValorCampoPrimaTxtConyuge in dtEliminarConyuge.Rows)
                {
                    if (dtValorCampoPrimaTxtConyuge["Amparo"].ToString() == "VIDA")
                    {
                        ValorCampoPrimaTxtConyuge = double.Parse(dtValorCampoPrimaTxtConyuge["Valor Asegurado"].ToString());
                        txtPlanConyuge.Text = ValorCampoPrimaTxtConyuge.ToString();
                        ddlPlanConyuge.SelectedItem.Text = ValorCampoPrimaTxtConyuge.ToString();
                    }
                }
            }

            if (txtPlanConyuge.Text != "")
            {
                dtEliminarConyuge = AdministrarCertificados.consultarAmparosPorPlanModificacion(cer_IdAnterior, 2);
                grvAmparoConyuge.DataSource = dtEliminarConyuge;
                grvAmparoConyuge.DataBind();

                double ValorCampoPrimaTxtConyuge = 0;

                foreach (DataRow dtValorCampoPrimaTxtConyuge in dtEliminarConyuge.Rows)
                {
                    if (dtValorCampoPrimaTxtConyuge["Amparo"].ToString() == "VIDA")
                    {
                        ValorCampoPrimaTxtConyuge = double.Parse(dtValorCampoPrimaTxtConyuge["Valor Asegurado"].ToString());
                        txtPlanConyuge.Text = ValorCampoPrimaTxtConyuge.ToString();
                        ddlPlanConyuge.SelectedItem.Text = ValorCampoPrimaTxtConyuge.ToString();
                    }
                }
            }
            // Para que se vea la tabla de beneficiario en modificacion sin registros
            if (dtBeneficiarioConyuge.Rows.Count == 0)
            {
                DataTable dtBeneficiarioVacio = dtBeneficiarioConyuge.Clone();
                DataRow drBeneficiarioVacio = dtBeneficiarioVacio.NewRow();
                dtBeneficiarioVacio.Rows.Add(drBeneficiarioVacio);
                grvBeneficiarioConyuge.DataSource = dtBeneficiarioVacio;
                grvBeneficiarioConyuge.DataBind();
                grvBeneficiarioConyuge.Rows[0].Visible = false;
                grvBeneficiarioConyuge.Rows[0].Controls.Clear();

            }
            Session["dtBeneficiarioConyuge"] = dtBeneficiarioConyuge;
        }
        if (mensaje == "ESTA CEDULA NO EXISTE")
        {
            txtNombreConyuge.Text = "";
            txtApellidoConyuge.Text = "";
            txtCedulaConyuge.Text = "";
            txtEdadConyuge.Text = "";
        }
        Session["dtEliminarConyuge"] = dtEliminarConyuge;
        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + mensaje + "');", true);
    }


    //metodo para buscar un tercero con su cedula desde otros Asegurados "SEBASTIAN"
    protected void ConsultarTerceroCertificadoOtroAsegurado(object sender, EventArgs e)
    {
        btnAdicionarOtrosAsegurados.Enabled = false;
        grvOtrosAsegurados.Visible = false;
        grvAmparoOtro.Visible = false;

        string mensaje = AdministrarCertificados.ConsultarTerceroCertificado(double.Parse(txtDocumentoOtros.Text));
        txtNombreOtro.Text = AdministrarCertificados.aseguradoBusqueda.Nombres;
        txtApellidoOtro.Text = AdministrarCertificados.aseguradoBusqueda.Apellidos;
        txtCedulaOtro.Text = AdministrarCertificados.aseguradoBusqueda.NumeroDocumento;
        txtEdadOtro.Text = Funciones.Edad(AdministrarCertificados.aseguradoBusqueda.FechaNacimiento).ToString();
        txtFechaNacimiento.Text = AdministrarCertificados.aseguradoBusqueda.FechaNacimiento.ToString("yyyy-MM-dd");

        if (txtCedulaOtro.Text != "" && ddlPoliza.Text != "")
        {
            ddlParentesoOtro.Enabled = true;
        }
        else
        {
            ddlParentesoOtro.Enabled = false;
        }

        if (ddlPoliza.Text != "" && txtCedulaOtro.Text != "" && ddlParentesoOtro.Text != "")
        {
            ddlPlanOtros.Enabled = true;
        }
        else
        {
            ddlPlanOtros.Enabled = false;
        }

        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + mensaje + "');", true);
    }

    protected void ConsultarAmparosPlanConyuge(object sender, EventArgs e)
    {
        try
        {
            DataTable dtEliminarConyuge = (DataTable)Session["dtEliminarConyuge"];
            DataTable dtEncabezadoCertificado = (DataTable)Session["dtEncabezadoCertificado"];
            DataTable dtExtraprimaConyuge = (DataTable)Session["dtExtraprimaConyuge"];
            double totalExtraPrimaC = 0;
            DataTable dtCumuloValorConyuge = new DataTable();
            double valorAsegurado = 0;
            double diferenciaValorAsegurado = 0;
            double totalExtraPrimaC3 = 0;


            int cer_IdNuevo = 0;
            cer_IdNuevo = AdministrarCertificados.ConsultarIdCertificado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "", "");
            Session["cerId_ValorNuevo"] = cer_IdNuevo;

            int cer_IdAnterior = 0;
            DataTable dtCer_IdExtraPrima = AdministrarCertificados.ConsultarCertificadosAnteriores(int.Parse(Session["cerId_ValorNuevo"].ToString()));
            cer_IdAnterior = int.Parse(dtCer_IdExtraPrima.Rows[0]["cer_IdAnterior"].ToString());

            dtCumuloValorConyuge = AdministrarCertificados.spConsultarCumulo(int.Parse(dtEncabezadoCertificado.Rows[0]["com_Id"].ToString()));
            valorAsegurado = AdministrarCertificados.spConsultarValoresAsegurado(int.Parse(dtEncabezadoCertificado.Rows[0]["com_Id"].ToString()), int.Parse(txtCedulaConyuge.Text));
            DataTable dtValorVigente = new DataTable();
            dtValorVigente = AdministrarCertificados.ConsultarEstadoNegocioPorCerId(cer_IdAnterior);
            if (dtValorVigente.Rows[0]["cer_EstadoNegocio"].ToString() == "VIGENTE")
            {
                valorAsegurado = valorAsegurado - double.Parse(Session["valorAseguradoPrincipalRestaConyuge"].ToString());
            }
            if ((valorAsegurado + double.Parse(ddlPlanConyuge.SelectedItem.ToString())) <= double.Parse(dtCumuloValorConyuge.Rows[0]["cum_Nombre"].ToString()))
            {
                if (ddlPlanConyuge.SelectedItem.ToString() != "")
                {
                    int ocupacion = int.Parse(ddlOcupacionPrincipal.SelectedValue.ToString());
                    dtEliminarConyuge = AdministrarCertificados.consultarAmparosPorPlan(int.Parse(ddlPlanConyuge.SelectedValue.ToString()), int.Parse(txtEdadConyuge.Text), 0, ocupacion);
                    //Cargar un dt con la informacion que posteriormente iria a la tabla extra prima
                    dtExtraprimaConyuge = AdministrarCertificados.consultarAmparosPorPlan(int.Parse(ddlPlanConyuge.SelectedValue.ToString()), int.Parse(txtEdadConyuge.Text), 0, ocupacion);
                    grvAmparoConyuge.DataSource = dtEliminarConyuge;
                    grvAmparoConyuge.DataBind();

                    DataTable dtConsultarValorAseguradoExtraPrima = new DataTable();
                    dtConsultarValorAseguradoExtraPrima = AdministrarCertificados.ConsultarValorAseguradoExtraPrima(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 2);

                    double valorAseguradoExtraPrima = 0;
                    double valorAseguradoDt = 0;
                    double TasaDt = 0;
                    double primaDt = 0;

                    //Recorrer el dt con el que se lleno la tabla extra prima
                    foreach (DataRow dt in dtExtraprimaConyuge.Rows)
                    {
                        //recorrer el dt con los valores del certificado anterior 
                        foreach (DataRow dt2 in dtConsultarValorAseguradoExtraPrima.Rows)
                        {
                            //condicional que pregunta cuando los nombres de los dos dt coinciden en el nombre
                            if (dt["Amparo"].ToString() == dt2["ampcer_Nombre"].ToString())
                            {
                                //asigna el valor asegurado del primer dt a esta variable 
                                valorAseguradoDt = double.Parse(dt["Valor Asegurado"].ToString());
                                //asignala tasa del primer dt a esta variable
                                TasaDt = double.Parse(dt["Tasa"].ToString());
                                //Asigna esta varible al valor asegurado del segundo dt
                                valorAseguradoExtraPrima = double.Parse(dt2["ampcer_ValAsegurado"].ToString());
                                //Resta el valor de la primera variable contra valorAseguradoExtraPrima y se la asigna a una variable
                                diferenciaValorAsegurado = valorAseguradoDt - valorAseguradoExtraPrima;
                                //Condicional en el que entra cuando el primer dt este pasando por la final de vida
                                if (dt["Amparo"].ToString() == "VIDA")
                                {
                                    // asigna un valor a una session
                                    Session["diferenciaValorAseguradoC"] = diferenciaValorAsegurado;
                                }
                                // asigna una variable a un campo del primer dt
                                dt["Valor Asegurado"] = diferenciaValorAsegurado;
                                //realiza una operacion para saber el valor de la prima
                                primaDt = (TasaDt * diferenciaValorAsegurado) / 1000000;
                                //asigna la vartiable de prima a un campo del dt
                                dt["Prima"] = primaDt;
                            }
                        }
                        //Crea un dt nuevo el cual sera un clon de la tabla extra prima fila por fila 
                        DataTable dtExtraprimaConyugeRestaurar = new DataTable();
                        dtExtraprimaConyugeRestaurar = dtExtraprimaConyuge.Clone();
                        foreach (DataRow row in dtExtraprimaConyuge.Rows)
                        {
                            DataRow row2 = dtExtraprimaConyugeRestaurar.NewRow();
                            row2.ItemArray = row.ItemArray;
                            dtExtraprimaConyugeRestaurar.Rows.Add(row2);
                        }
                        // asigna este dt a la session 
                        Session["dtExtraprimaConyugeRestaurar"] = dtExtraprimaConyugeRestaurar;
                    }

                    double totales = 0;
                    foreach (GridViewRow row in grvAmparoConyuge.Rows)
                    {
                        totales += Convert.ToDouble(row.Cells[4].Text);
                    }
                    //txtPrimaConyuge.Text = Convert.ToString(totales);

                    grvAmparoConyuge.DataSource = dtEliminarConyuge;
                    grvAmparoConyuge.DataBind();
                    // Extra Prima
                    grvExtraPrimaConyuge.DataSource = dtExtraprimaConyuge;
                    grvExtraPrimaConyuge.DataBind();

                    // crea dt el cual contiene la informacion del historial del cliente en todos los amparos y se lo asigna a la tabla de historial

                    DataSet dsConsultarHistirialPorcentajeExtraPrimadoConyuge = new DataSet();
                    dsConsultarHistirialPorcentajeExtraPrimadoConyuge = AdministrarCertificados.ConsultarHistirialPorcentajeExtraPrimado(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 2);

                    DataTable dtConsultarHistirialPorcentajeExtraPrimadoConyuge = new DataTable();
                    foreach (DataTable dt in dsConsultarHistirialPorcentajeExtraPrimadoConyuge.Tables)
                    {
                        dtConsultarHistirialPorcentajeExtraPrimadoConyuge.Merge(dt);
                    }
                    grvConsultarHistirialPorcentajeExtraPrimadoConyuge.DataSource = dtConsultarHistirialPorcentajeExtraPrimadoConyuge;
                    grvConsultarHistirialPorcentajeExtraPrimadoConyuge.DataBind();

                    //Consulta el historial del cliente pero general
                    DataTable dtConsultarHistorialExtraPrimaConyuge = new DataTable();
                    dtConsultarHistorialExtraPrimaConyuge = AdministrarCertificados.ConsultarHistorialExtraPrima(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 2);
                    grvHistorialExtraPrimaConyuge.DataSource = dtConsultarHistorialExtraPrimaConyuge;
                    grvHistorialExtraPrimaConyuge.DataBind();


                    double consultarHistorialExtraPrimaConyuge = 0;
                    double valorExtraPrimaConyuge = 0;

                    //Condicional en el cual entra si el cliente ya tiene un historial damparos  para asignar valores
                    if (dtConsultarHistorialExtraPrimaConyuge.Rows.Count > 0)
                    {
                        // Recorre el dt para consultar los valores de prima y extra prima
                        foreach (DataRow dtConsultarHistorialExtraPrimaForeachConyuge in dtConsultarHistorialExtraPrimaConyuge.Rows)
                        {
                            consultarHistorialExtraPrimaConyuge += double.Parse(dtConsultarHistorialExtraPrimaForeachConyuge["Prima"].ToString());
                            valorExtraPrimaConyuge += double.Parse(dtConsultarHistorialExtraPrimaForeachConyuge["Extra Prima"].ToString());
                        }
                    }

                    //recorre tabla de extra prima para la suma de primas 
                    foreach (GridViewRow row in grvExtraPrimaConyuge.Rows)
                    {
                        totalExtraPrimaC += Convert.ToDouble(row.Cells[4].Text);
                    }

                    // Asignar variables con valores a los campos de prima y extra prima 
                    totalExtraPrimaC3 = totalExtraPrimaC;
                    totalExtraPrimaC3 = consultarHistorialExtraPrimaConyuge + totalExtraPrimaC3;
                    txtPrimaPrincipalExtraprimaConyuge.Text = totalExtraPrimaC3.ToString();
                    txtPrimaConyuge.Text = totalExtraPrimaC3.ToString();
                    txtExtraPrimaConyuge.Text = txtPrincipalExtraprimaConyuge.Text;

                    int PrimaConyuge = int.Parse(Math.Round(decimal.Parse(txtPrimaConyuge.Text)).ToString());
                    txtPrimaConyuge.Text = PrimaConyuge.ToString();
                    int PrimaPrincipalExtraprimaConyuge = int.Parse(Math.Round(decimal.Parse(txtPrimaPrincipalExtraprimaConyuge.Text)).ToString());
                    txtPrimaPrincipalExtraprimaConyuge.Text = PrimaPrincipalExtraprimaConyuge.ToString();
                    int ExtraPrimaConyuge = int.Parse(Math.Round(decimal.Parse(txtExtraPrimaConyuge.Text)).ToString());
                    txtExtraPrimaConyuge.Text = ExtraPrimaConyuge.ToString();
                }
                else
                {
                    dtEliminarConyuge.Clear();
                    grvAmparoConyuge.DataSource = dtEliminarConyuge;
                    grvAmparoConyuge.DataBind();
                }
            }
            else
            {
                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL VALOR DEL PLAN SUPERA EL ACEPTADO POR LA COMPAÑÍA PARA SUS LOS PRODUCTOS" + "');", true);
            }

            sumarPrima();
            Session["dtEliminarConyuge"] = dtEliminarConyuge;
            Session["dtExtraprimaConyuge"] = dtExtraprimaConyuge;
            Session["TotalExtraPrimaC"] = totalExtraPrimaC;
            Session["dtExtraPrimaConyugeGuardarFinal"] = dtExtraprimaConyuge;
        }
        catch
        {
            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "POR FAVOR Seleccione UN PLAN" + "');", true);
        }

    }


    //sebastian
    protected void consultarPolizaPorProducto(object sender, EventArgs e)
    {
        DataTable dtEncabezadoCertificado = (DataTable)Session["dtEncabezadoCertificado"];
        DataTable dtCertificadoFull = (DataTable)Session["dtCertificadoFull"];
        if (ddlLocalidadCertificado.SelectedItem.ToString() != "")
        {
            ddlPoliza.DataSource = AdministrarCertificados.spConsultarPolizaPorProudcto(int.Parse(ddlLocalidadCertificado.SelectedValue.ToString()));
            ddlPoliza.DataValueField = "pol_Id";
            ddlPoliza.DataTextField = "pol_numero";
            ddlPoliza.DataBind();
            ddlPoliza.Items.Insert(0, new ListItem("", ""));
            ddlPoliza.Attributes.Add("onclick", "localStorage.setItem('accIndex', 0);");

            if (ddlLocalidadCertificado.Text == "")
            {
                ddlPoliza.Enabled = false;
            }
            else
            {
                ddlPoliza.Enabled = true;
            }
            if (ddlPoliza.Text != "")
            {
                txtDocumentoConyugue.Enabled = true;
                txtDocumentoOtros.Enabled = true;
            }
            else
            {
                txtDocumentoConyugue.Enabled = false;
                txtDocumentoOtros.Enabled = false;
            }
        }

        DataTable dtEliminarConyuge = (DataTable)Session["dtEliminarConyuge"];
        amparosConyuge.Visible = false;
        dtEliminarConyuge.Clear();
        grvAmparoConyuge.DataSource = dtEliminarConyuge;
        Session["dtEliminarConyuge"] = dtEliminarConyuge;
        grvAmparoConyuge.DataBind();

        DataTable dtEliminarPrincipal = (DataTable)Session["dtEliminarPrincipal"];
        amparosPrincipal.Visible = false;
        dtEliminarPrincipal.Clear();
        grvAmparoPrincipal.DataSource = dtEliminarPrincipal;
        Session["dtEliminarPrincipal"] = dtEliminarPrincipal;
        grvAmparoPrincipal.DataBind();

        //int departamento = int.Parse(AdministrarCertificados.consultarDepartamentoPorCiudad(txtAgencia.Text).Rows[0]["dep_Id"].ToString());
        int pagaduria = int.Parse(AdministrarCertificados.consultarConvenioPorPagaduria(txtPagaduriaPrincipal.Text, dtEncabezadoCertificado.Rows[0]["Localidad"].ToString()).Rows[0]["paga_Id"].ToString());
        try
        {
            DataTable dt = new DataTable();
            dt = AdministrarCertificados.consultarConvenios(int.Parse(ddlProducto.SelectedValue.ToString()), int.Parse(ddlLocalidadCertificado.SelectedValue.ToString()), pagaduria);
            ddlConvenioPrincipal.DataTextField = "con_Nombre";
            ddlConvenioPrincipal.DataValueField = "con_Id";
            ddlConvenioPrincipal.DataSource = dt;
            ddlConvenioPrincipal.DataBind();
            ddlConvenioPrincipal.Items.Insert(0, new ListItem("", ""));
            if ((string)Session["operacionCertificado"] == "modificar")
                ddlConvenioPrincipal.SelectedIndex = ddlConvenioPrincipal.Items.IndexOf(ddlConvenioPrincipal.Items.FindByText(dtCertificadoFull.Rows[0]["con_Nombre"].ToString())); //jc
        }
        catch
        {
            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "Seleccione UNA LOCALIDAD" + "');", true);
        }
    }


    protected void consultarPlaPorParentesco(object sender, EventArgs e)
    {
        if (ddlPoliza.SelectedItem.ToString() != "" && ddlParentesoOtro.SelectedItem.ToString() != "")
        {
            DataTable planotrosAsegurados = AdministrarCertificados.consultarPlanPorPoliza(int.Parse(ddlPoliza.SelectedValue.ToString()), int.Parse(ddlParentesoOtro.SelectedValue.ToString()), int.Parse(txtEdadOtro.Text));
            ddlPlanOtros.DataSource = planotrosAsegurados;
            ddlPlanOtros.DataValueField = "plapol_Id";
            ddlPlanOtros.DataTextField = "plan_ValAsegurado";
            ddlPlanOtros.DataBind();
            ddlPoliza.Items.Insert(0, new ListItem("", ""));
            ddlPoliza.Attributes.Add("onclick", "localStorage.setItem('accIndex', 3);");

            if (ddlPoliza.Text != "" && txtCedulaOtro.Text != "" && ddlParentesoOtro.Text != "")
            {
                ddlPlanOtros.Enabled = true;
            }
            else
            {
                ddlPlanOtros.Enabled = false;
            }
        }
    }

    protected void consultarPlanPorPoliza(object sender, EventArgs e)
    {
        if (ddlPoliza.SelectedItem.ToString() != "")
        {


            DataTable dt = new DataTable();
            if ((string)Session["operacionCertificado"] == "modificar")
            {
                DataTable dtCertificadoFull = (DataTable)Session["dtCertificadoFull"];
                DataTable permaneciaAsegurado = new DataTable();
                int permaneciaAseguradoCertificado = 0;

                permaneciaAsegurado = AdministrarCertificados.ConsultarFechaExpedicionCertificadoAnterior(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()));
                permaneciaAseguradoCertificado = Funciones.FechaIngresoAsegurado(DateTime.Parse(permaneciaAsegurado.Rows[0]["cer_FechaExpedicion"].ToString()), DateTime.Parse(dtCertificadoFull.Rows[0]["ter_FechaNacimiento"].ToString()));

                dt = AdministrarCertificados.consultarPlanPorPolizaPermanencia(int.Parse(ddlPoliza.SelectedValue.ToString()), 1, permaneciaAseguradoCertificado);
            }
            else
            {
                dt = AdministrarCertificados.consultarPlanPorPoliza(int.Parse(ddlPoliza.SelectedValue.ToString()), 1, int.Parse(txtEdadPrincipal.Text));
            }
            ddlPlanPrincipal.DataSource = dt;
            ddlPlanPrincipal.DataValueField = "plapol_Id";
            ddlPlanPrincipal.DataTextField = "plan_ValAsegurado";
            ddlPlanPrincipal.DataBind();
            ddlPlanPrincipal.Items.Insert(0, new ListItem("", ""));
            ddlPlanPrincipal.Attributes.Add("onclick", "localStorage.setItem('accIndex', 1);");

            if (dt.Rows.Count > 0)
            {
                Session["plapol_Id"] = dt.Rows[0]["plapol_Id"].ToString();
                if (txtCedulaOtro.Text != "" && ddlPoliza.Text != "")
                {
                    ddlParentesoOtro.Enabled = true;
                }
                else
                {
                    ddlParentesoOtro.Enabled = false;
                }

                if (ddlPoliza.Text != "")
                {
                    txtPlanPrincipal.Enabled = true;
                }
                else
                {
                    txtPlanPrincipal.Enabled = false;
                }

                if (ddlPoliza.Text == "")
                {
                    ddlPlanPrincipal.Enabled = false;
                }
                else
                {
                    ddlPlanPrincipal.Enabled = true;
                }

                if (ddlPoliza.Text != "" && txtCedulaConyuge.Text != "")
                {
                    ddlPlanConyuge.Enabled = true;
                }
                else
                {
                    ddlPlanConyuge.Enabled = false;
                }
            }
            else
            {
                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "ESTA PERSONA NO CUMPLE LOS REQUISITOS PARA SER ASEGURADA " + "');", true);
            }
        }
    }

    protected void sumarPrima()
    {
        int primaOtroAsegurado = (int)Session["primaOtroAsegurado"];
        if (txtPrimaPrincipal.Text == "")
        {
            txtPrimaPrincipal.Text = "0";
        }

        if (txtPrimaConyuge.Text == "")
        {
            txtPrimaConyuge.Text = "0";
        }

        if (txtPrimaOtros.Text == "")
        {
            txtPrimaOtros.Text = "0";
        }
        if (txtExtraPrimaPrincipal.Text == "")
        {
            txtExtraPrimaPrincipal.Text = "0";
        }
        if (txtExtraPrimaConyuge.Text == "")
        {
            txtExtraPrimaConyuge.Text = "0";
        }
        int primaPrincipal =  int.Parse(Math.Round(decimal.Parse(txtPrimaPrincipal.Text)).ToString());
        int primaConyuge = int.Parse(Math.Round(decimal.Parse(txtPrimaConyuge.Text)).ToString());
        int primaPrincipalExtra = int.Parse(Math.Round(decimal.Parse(txtExtraPrimaPrincipal.Text)).ToString());
        int primaConyugeExtra = int.Parse(Math.Round(decimal.Parse(txtExtraPrimaConyuge.Text)).ToString());
        primaOtroAsegurado += int.Parse(txtPrimaOtros.Text);
        double primaTotal = primaPrincipal + primaConyuge + primaPrincipalExtra + primaConyugeExtra + primaOtroAsegurado;
        txtPrima.Text = primaTotal.ToString();

        Session["primaOtroAsegurado"] = primaOtroAsegurado;
    }


    protected static double CalcularValorNovedadCertificado(double primaCertificado, int periodicidad)
    {
        double valorTotal = 0;
        if (periodicidad == 10)
        {
            valorTotal = primaCertificado * 6;
        }
        if (periodicidad == 14)
        {
            valorTotal = primaCertificado * 12;
        }
        else
        {
            valorTotal = primaCertificado;
        }
        return valorTotal;
    }

    protected DataTable CalcularMesYAnio()
    {
        int mesNovedad = 0;
        int anioNovedad = 0;

        DataTable dtNovedades = (DataTable)Session["dtNovedades"];

        mesNovedad = int.Parse(dtNovedades.Rows[0]["mes"].ToString()) + 1;
        anioNovedad = int.Parse(dtNovedades.Rows[0]["anio"].ToString());

        if (mesNovedad == 13)
        {
           anioNovedad = anioNovedad + 1;
           mesNovedad = 1;
        }

        DataTable dtArchivo = (DataTable)Session["dtArchivo"];
      
        DataTable dtMesYAnioNovedades = new DataTable();
        dtMesYAnioNovedades = AdministrarNovedades.ConsultarMesYAnioNovedad(mesNovedad, anioNovedad, int.Parse(dtArchivo.Rows[0]["arcpag_Id"].ToString()));

        if(dtMesYAnioNovedades.Rows.Count > 0)
        {
           if(dtMesYAnioNovedades.Rows[0]["enviada"].ToString() == "1")
           {
               mesNovedad = mesNovedad + 1;
               if (mesNovedad == 13)
               {
                 anioNovedad = anioNovedad + 1;
                 mesNovedad = 1;
               }
            }
        }

        DataTable dtMesYAnio = new DataTable();

        DataColumn columns = new DataColumn();
        columns.DataType = System.Type.GetType("System.String");
        columns.AllowDBNull = true;
        columns.ColumnName = "mes";
        dtMesYAnio.Columns.Add(columns);

        columns = new DataColumn();
        columns.DataType = System.Type.GetType("System.String");
        columns.AllowDBNull = true;
        columns.ColumnName = "anio";
        dtMesYAnio.Columns.Add(columns);

        DataRow fecha = dtMesYAnio.NewRow();

        fecha["mes"] = mesNovedad;
        fecha["anio"] = anioNovedad;
        dtMesYAnio.Rows.Add(fecha);

        return dtMesYAnio;
    }

    protected void ActualizarCertificadoPreCargado()
    {
        int cer_IdNuevo = 0;
        cer_IdNuevo = AdministrarCertificados.ConsultarIdCertificado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "", "");

        int hojaServicio1 = 0;
        int hojaServicio2 = 0;
        int hojaServicio3 = 0;
        int anexoConversion = 0;

        if (txtHServicio1.Text != "")
        {
            hojaServicio1 = int.Parse(txtHServicio1.Text);
        }
        if (txtHServicio2.Text != "")
        {
            hojaServicio2 = int.Parse(txtHServicio2.Text);
        }
        if (txtHServicio3.Text != "")
        {
            hojaServicio3 = int.Parse(txtHServicio3.Text);
        }
        if (txtAnexoConversion.Text != "")
        {
            anexoConversion = int.Parse(txtAnexoConversion.Text);
        }

        AdministrarCertificados.ActualizarNewCertificadoPreCargado(cer_IdNuevo, hojaServicio1, hojaServicio2, hojaServicio3, anexoConversion);
    }

    protected void CalcularNovedades(DataTable dtPeriodicidad, DataTable dtArchivoPagaduria)
    {
        DataTable dtEncabezadoCertificado = (DataTable)Session["dtEncabezadoCertificado"];
        DataTable dtArchivo = (DataTable)Session["dtArchivo"];
        DataTable dtNovedades = (DataTable)Session["dtNovedades"];
        //////////////////////////////Inicia operaciones para novedades///////////////////////////////////////////// 
        DataTable dtNovedadActual = new DataTable();
        dtNovedadActual = AdministrarCertificados.ConsultarNovedadActual(int.Parse(dtNovedades.Rows[0]["tercero"].ToString()), int.Parse(dtArchivo.Rows[0]["arcpag_Id"].ToString()), 0);

        if (dtNovedadActual.Rows.Count > 0)
        {
            if (dtArchivoPagaduria.Rows[0]["arcpag_TipoReporte"].ToString() == "0")
            {
                if (dtNovedadActual.Rows[0]["TipoNovedad"].ToString() == "R")
                {
                    dtNovedadActual.Clear();
                }
            }
            if (dtArchivoPagaduria.Rows[0]["arcpag_TipoReporte"].ToString() == "1")
            {
                if (dtNovedadActual.Rows[0]["TipoNovedad"].ToString() == "R" && dtNovedadActual.Rows[1]["TipoNovedad"].ToString() != "R")
                {
                    dtNovedadActual.Rows.RemoveAt(0);
                }
                if (dtNovedadActual.Rows[0]["TipoNovedad"].ToString() == "R" && dtNovedadActual.Rows[1]["TipoNovedad"].ToString() == "R")
                {
                    dtNovedadActual.Clear();
                }
            }
        }
        int cedula = 0;
        string tipoNovedad = "";
        string tipoNovedad2 = "";
        double valor2 = 0;
        double valor = 0;
        int estado = 0;
        int pagaduria = 0;
        int convenio = 0;
        int archivo = 0;
        int enviada = 0;
        double novedadAnterior = 0;

        cedula = int.Parse(dtNovedades.Rows[0]["tercero"].ToString());
        convenio = int.Parse(dtNovedades.Rows[0]["convenio"].ToString());
        pagaduria = int.Parse(AdministrarCertificados.consultarConvenioPorPagaduria(txtPagaduriaPrincipal.Text, dtEncabezadoCertificado.Rows[0]["Localidad"].ToString()).Rows[0]["paga_Id"].ToString());
        archivo = int.Parse(dtArchivo.Rows[0]["arcpag_Id"].ToString());
        estado = 1;
        enviada = 0;

        /////////////////////////////// Variables para calcular el valor que se debe enviar a la novedad ///////////////
        double primaCertificado = 0;
        primaCertificado = int.Parse(dtNovedades.Rows[0]["prima"].ToString());

        int periodicidad = 0;
        periodicidad = int.Parse(dtPeriodicidad.Rows[0]["con_PeriodicidadPago"].ToString());

        double valorTotal = CalcularValorNovedadCertificado(primaCertificado, periodicidad);
        ///////////////////////////////FINALIZA Variables para calcular el valor que se debe enviar a la novedad ///////////////

        if (dtNovedadActual.Rows.Count == 0)
        {
            tipoNovedad = "I";
            ///////////////////////Cuando esta persona no tiene novedad anterior /////////////////////
            if (tipoNovedad == "I")
            {
                tipoNovedad = "I";

                valor = valorTotal;
            }
            /////////////////////  FINALIZA Cuando esta persona no tiene novedad anterior/////////////////////////
        }
        else
        {
            novedadAnterior = int.Parse(dtNovedadActual.Rows[0]["Valor"].ToString());
            //////////////////////// cuando es ingreso, modificacion y retiro ////////////////////////////////
            if (dtArchivoPagaduria.Rows[0]["arcpag_TipoReporte"].ToString() == "0")
            {
                //////////////////////// cuando la novedad aun no sido enviada ////////////////////////////////
                if (dtNovedadActual.Rows[0]["Enviada"].ToString() == "0")
                {
                    valor = valorTotal + novedadAnterior;
                }
                ////////////////////////FINALIZA cuando la novedad aun no sido enviada ////////////////////////////////

                //////////////////////// cuando la novedad actual ya esta enviada ////////////////////////////////

                if (dtNovedadActual.Rows[0]["Enviada"].ToString() == "1")
                {
                    tipoNovedad = "M";

                    //////////////////////// cuando el valor que se desea ingresar es solo la novedad ////////////////////////////////
                    if (dtArchivoPagaduria.Rows[0]["arcpag_Valor"].ToString() == "0")
                    {
                        valor = valorTotal;
                    }
                    ////////////////////////FINALIZA cuando el valor que se desea ingresar es solo la novedad ////////////////////////////////

                    ///////////////// cuando el valor que se desea ingresar es la vovedad anterior mas la actual ////////////////////////
                    if (dtArchivoPagaduria.Rows[0]["arcpag_Valor"].ToString() == "1")
                    {
                        valor = valorTotal - novedadAnterior;
                    }
                    /////////////FINALIZA cuando el valor que se desea ingresar es la vovedad anterior mas la actual /////////////////
                }
                ////////////////////////FINALIZA cuando la novedad actual ya esta enviada ////////////////////////////////
            }
            ////////////////////////FINALIZA cuando es ingreso, modificacion y retiro ////////////////////////////////

            //////////////////////// cuando es ingreso y retiro ////////////////////////////////
            if (dtArchivoPagaduria.Rows[0]["arcpag_TipoReporte"].ToString() == "1")
            {
                //////////////////////// cuando la novedad aun no sido enviada ////////////////////////////////
                if (dtNovedadActual.Rows[0]["Enviada"].ToString() == "0")
                {
                    valor = valorTotal + novedadAnterior;
                }
                ////////////////////////FINALIZA cuando la novedad aun no sido enviada ////////////////////////////////
                if (dtNovedadActual.Rows[0]["Enviada"].ToString() == "1")
                {
                    tipoNovedad = "I";
                    valor = valorTotal + novedadAnterior;

                    tipoNovedad2 = "R";
                    valor2 = novedadAnterior;
                }
                ////////////////////////FINALIZA cuando la novedad aun no sido enviada ////////////////////////////////
            }
            ////////////////////////FINALIZA cuando es ingreso y retiro ////////////////////////////////
        }
        //////////////////////////////Finaliza operaciones para novedades/////////////////////////////////////////////
        DataTable dtMesYAnio = CalcularMesYAnio();

        if (dtNovedadActual.Rows.Count > 0)
        {
            if (dtNovedadActual.Rows[0]["Enviada"].ToString() == "0" || (dtNovedadActual.Rows[0]["Enviada"].ToString() == "1" && dtNovedadActual.Rows[0]["Estado"].ToString() == "1"))
            {
                AdministrarNovedades.ActualizarNovedades(int.Parse(dtNovedadActual.Rows[0]["nov_Id"].ToString()), dtNovedadActual.Rows[0]["TipoNovedad"].ToString(), int.Parse(valor.ToString()), int.Parse(dtMesYAnio.Rows[0]["mes"].ToString()), int.Parse(dtMesYAnio.Rows[0]["anio"].ToString()));
            }
            else
            {
                if (dtArchivoPagaduria.Rows[0]["arcpag_TipoReporte"].ToString() == "1" && dtNovedadActual.Rows[0]["Enviada"].ToString() == "1")
                {
                    AdministrarNovedades.InsertarNovedades(int.Parse(cedula.ToString()), tipoNovedad, int.Parse(estado.ToString()), int.Parse(pagaduria.ToString()), int.Parse(convenio.ToString()), int.Parse(archivo.ToString()), int.Parse(valor.ToString()), int.Parse(enviada.ToString()), int.Parse(dtMesYAnio.Rows[0]["mes"].ToString()), int.Parse(dtMesYAnio.Rows[0]["anio"].ToString()));

                    AdministrarNovedades.InsertarNovedades(int.Parse(cedula.ToString()), tipoNovedad2, int.Parse(estado.ToString()), int.Parse(pagaduria.ToString()), int.Parse(convenio.ToString()), int.Parse(archivo.ToString()), int.Parse(valor2.ToString()), int.Parse(enviada.ToString()), int.Parse(dtMesYAnio.Rows[0]["mes"].ToString()), int.Parse(dtMesYAnio.Rows[0]["anio"].ToString()));
                }
                if (dtArchivoPagaduria.Rows[0]["arcpag_TipoReporte"].ToString() == "0")
                {
                    AdministrarNovedades.InsertarNovedades(int.Parse(cedula.ToString()), tipoNovedad, int.Parse(estado.ToString()), int.Parse(pagaduria.ToString()), int.Parse(convenio.ToString()), int.Parse(archivo.ToString()), int.Parse(valor.ToString()), int.Parse(enviada.ToString()), int.Parse(dtMesYAnio.Rows[0]["mes"].ToString()), int.Parse(dtMesYAnio.Rows[0]["anio"].ToString()));
                }
                if (dtArchivoPagaduria.Rows[0]["arcpag_TipoReporte"].ToString() == "2")
                {

                }
            }
        }
        else
        {
            AdministrarNovedades.InsertarNovedades(int.Parse(cedula.ToString()), tipoNovedad, int.Parse(estado.ToString()), int.Parse(pagaduria.ToString()), int.Parse(convenio.ToString()), int.Parse(archivo.ToString()), int.Parse(valor.ToString()), int.Parse(enviada.ToString()), int.Parse(dtMesYAnio.Rows[0]["mes"].ToString()), int.Parse(dtMesYAnio.Rows[0]["anio"].ToString()));
        }
    }

    protected void CalcularNovedadesRetiroRetiro(DataTable dtPeriodicidad, DataTable dtArchivoPagaduria)
    {
        DataTable dtEncabezadoCertificado = (DataTable)Session["dtEncabezadoCertificadoAntiguo"];
        DataTable dtArchivo = (DataTable)Session["dtArchivoAntiguo"];
        DataTable dtNovedades = (DataTable)Session["dtEncabezadoCertificadoAntiguo"];
        //////////////////////////////Inicia operaciones para novedades///////////////////////////////////////////// 
        DataTable dtNovedadActual = new DataTable();
        dtNovedadActual = AdministrarCertificados.ConsultarNovedadActual(int.Parse(dtNovedades.Rows[0]["ter_Id"].ToString()), int.Parse(dtArchivo.Rows[0]["arcpag_Id"].ToString()), 1);

        int cedula = 0;
        string tipoNovedad = "";
        string tipoNovedad2 = "";
        double valor2 = 0;
        double valor = 0;
        int estado = 0;
        int pagaduria = 0;
        int convenio = 0;
        int archivo = 0;
        int enviada = 0;
        double novedadAnterior = 0;

        cedula = int.Parse(dtNovedades.Rows[0]["ter_Id"].ToString());
        convenio = int.Parse(dtNovedades.Rows[0]["con_Id"].ToString());
        pagaduria = int.Parse(dtNovedades.Rows[0]["paga_Id"].ToString());
        archivo = int.Parse(dtArchivo.Rows[0]["arcpag_Id"].ToString());
        estado = 1;
        enviada = 0;

        /////////////////////////////// Variables para calcular el valor que se debe enviar a la novedad ///////////////
        double primaCertificado = 0;
        primaCertificado = int.Parse(dtNovedades.Rows[0]["cer_PrimaTotal"].ToString());

        int periodicidad = 0;
        periodicidad = int.Parse(dtPeriodicidad.Rows[0]["con_PeriodicidadPago"].ToString());

        double valorTotal = CalcularValorNovedadCertificado(primaCertificado, periodicidad);
        ///////////////////////////////FINALIZA Variables para calcular el valor que se debe enviar a la novedad ///////////////

        //valor = novedadAnterior - valorTotal;
        novedadAnterior = int.Parse(dtNovedadActual.Rows[0]["Valor"].ToString());
        if (novedadAnterior - valorTotal <= 0)
        {
            tipoNovedad = "R";
        }
        else
        {
            tipoNovedad = "M";
        }

        //////////////////////// cuando es ingreso, modificacion y retiro ////////////////////////////////

        if (tipoNovedad == "M")
        {
            if (dtArchivoPagaduria.Rows[0]["arcpag_TipoReporte"].ToString() == "0")
            {

                //////////////////////// cuando el valor que se desea ingresar es solo la novedad ////////////////////////////////
                if (dtArchivoPagaduria.Rows[0]["arcpag_Valor"].ToString() == "0")
                {
                    valor = novedadAnterior - valorTotal;
                }
                ////////////////////////FINALIZA cuando el valor que se desea ingresar es solo la novedad ////////////////////////////////

                ///////////////// cuando el valor que se desea ingresar es la vovedad anterior mas la actual ////////////////////////
                if (dtArchivoPagaduria.Rows[0]["arcpag_Valor"].ToString() == "1")
                {
                    valor = -valorTotal;
                }
                /////////////FINALIZA cuando el valor que se desea ingresar es la vovedad anterior mas la actual /////////////////
            }
            ////////////////////////FINALIZA cuando es ingreso, modificacion y retiro ////////////////////////////////
            //////////////////////// cuando es ingreso y retiro ////////////////////////////////
            if (dtArchivoPagaduria.Rows[0]["arcpag_TipoReporte"].ToString() == "1")
            {


                tipoNovedad = "I";
                valor = novedadAnterior - valorTotal;

                tipoNovedad2 = "R";
                valor2 = novedadAnterior;

            }
            ////////////////////////FINALIZA cuando es ingreso y retiro ////////////////////////////////
        }
        if (tipoNovedad == "R")
        {
            if (dtArchivoPagaduria.Rows[0]["arcpag_Retiros"].ToString() == "0")
            {
                valor = 0;
            }
            if (dtArchivoPagaduria.Rows[0]["arcpag_Retiros"].ToString() == "1")
            {
                valor = valorTotal;
            }
        }
        //////////////////////////////Finaliza operaciones para novedades/////////////////////////////////////////////
        DataTable dtMesYAnio = CalcularMesYAnio();


        if (dtNovedadActual.Rows[0]["Enviada"].ToString() == "0" || (dtNovedadActual.Rows[0]["Enviada"].ToString() == "1" && dtNovedadActual.Rows[0]["Estado"].ToString() == "1"))
        {
            AdministrarNovedades.ActualizarNovedades(int.Parse(dtNovedadActual.Rows[0]["nov_Id"].ToString()), tipoNovedad, int.Parse(valor.ToString()), int.Parse(dtMesYAnio.Rows[0]["mes"].ToString()), int.Parse(dtMesYAnio.Rows[0]["anio"].ToString()));
        }
        else
        {
            if (dtArchivoPagaduria.Rows[0]["arcpag_TipoReporte"].ToString() == "1" && dtNovedadActual.Rows[0]["Enviada"].ToString() == "1")
            {
                AdministrarNovedades.InsertarNovedades(int.Parse(cedula.ToString()), tipoNovedad, int.Parse(estado.ToString()), int.Parse(pagaduria.ToString()), int.Parse(convenio.ToString()), int.Parse(archivo.ToString()), int.Parse(valor.ToString()), int.Parse(enviada.ToString()), int.Parse(dtMesYAnio.Rows[0]["mes"].ToString()), int.Parse(dtMesYAnio.Rows[0]["anio"].ToString()));

                AdministrarNovedades.InsertarNovedades(int.Parse(cedula.ToString()), tipoNovedad2, int.Parse(estado.ToString()), int.Parse(pagaduria.ToString()), int.Parse(convenio.ToString()), int.Parse(archivo.ToString()), int.Parse(valor2.ToString()), int.Parse(enviada.ToString()), int.Parse(dtMesYAnio.Rows[0]["mes"].ToString()), int.Parse(dtMesYAnio.Rows[0]["anio"].ToString()));
            }
            if (dtArchivoPagaduria.Rows[0]["arcpag_TipoReporte"].ToString() == "0")
            {
                AdministrarNovedades.InsertarNovedades(int.Parse(cedula.ToString()), tipoNovedad, int.Parse(estado.ToString()), int.Parse(pagaduria.ToString()), int.Parse(convenio.ToString()), int.Parse(archivo.ToString()), int.Parse(valor.ToString()), int.Parse(enviada.ToString()), int.Parse(dtMesYAnio.Rows[0]["mes"].ToString()), int.Parse(dtMesYAnio.Rows[0]["anio"].ToString()));
            }
        }
    }

    protected void bntGuardarCertificado_Click(object sender, EventArgs e)
    {

        int cer_IdNuevo = 0;
        cer_IdNuevo = AdministrarCertificados.ConsultarIdCertificado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "", "");
        Session["cerId_ValorNuevo"] = cer_IdNuevo;

        int cer_Id = 0;
        if ((string)Session["operacionCertificado"] == "modificar")
        {
            // Se cambia para que coja el anterior guardado en pre cargue
            //cer_Id = AdministrarCertificados.ConsultarIdCertificado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "VIGENTE", "PRODUCCION NUEVA");
            DataTable dtCer_Id = AdministrarCertificados.ConsultarCertificadosAnteriores(cer_IdNuevo);
            try
            {
                cer_Id = int.Parse(dtCer_Id.Rows[0]["cer_IdAnterior"].ToString());
            }
            catch
            {
                Session["operacionCertificado"] = "ingresar";
            }
        }

        // CREAR NUEVO PRECARGUE        
        DataTable dtEncabezadoPrecargue = AdministrarCertificados.ConsultarCertificadoPrecargadoPorDigitar(int.Parse(Session["cer_Id"].ToString()));
        precargue.CrearNuevoCertificadoModificado(dtEncabezadoPrecargue.Rows[0]["cer_Certificado"].ToString(), dtEncabezadoPrecargue.Rows[0]["ter_Id"].ToString(), " ", " ", dtEncabezadoPrecargue.Rows[0]["age_Id"].ToString(), DateTime.Parse(dtEncabezadoPrecargue.Rows[0]["cer_FechaExpedicion"].ToString()), int.Parse(dtEncabezadoPrecargue.Rows[0]["ase_Id"].ToString()), dtEncabezadoPrecargue.Rows[0]["paga_Id"].ToString(), DateTime.Parse(dtEncabezadoPrecargue.Rows[0]["cer_FechaRecibido"].ToString()), dtEncabezadoPrecargue.Rows[0]["cer_PlanillaBolivar"].ToString(), dtEncabezadoPrecargue.Rows[0]["casesp_Id"].ToString(), dtEncabezadoPrecargue.Rows[0]["cer_NumeroFolios"].ToString(), dtEncabezadoPrecargue.Rows[0]["com_Id"].ToString(), dtEncabezadoPrecargue.Rows[0]["Localidad"].ToString(), dtEncabezadoPrecargue.Rows[0]["pro_Id"].ToString(), dtEncabezadoPrecargue.Rows[0]["cer_HojaServicio1"].ToString(), dtEncabezadoPrecargue.Rows[0]["cer_HojaServicio2"].ToString(), dtEncabezadoPrecargue.Rows[0]["cer_HojaServicio3"].ToString(), 0, int.Parse(dtEncabezadoPrecargue.Rows[0]["caudev_Id"].ToString()), int.Parse(dtEncabezadoPrecargue.Rows[0]["tipdev_Id"].ToString()), 0, dtEncabezadoPrecargue.Rows[0]["cer_Observaciones"].ToString(), dtEncabezadoPrecargue.Rows[0]["cer_AnexoConversion"].ToString(), DateTime.Parse(dtEncabezadoPrecargue.Rows[0]["cer_VigenciaDesde"].ToString()), int.Parse(dtEncabezadoPrecargue.Rows[0]["cer_SoporteFisico"].ToString()), int.Parse(dtEncabezadoPrecargue.Rows[0]["MesProduccion"].ToString()), int.Parse(dtEncabezadoPrecargue.Rows[0]["cer_Migracion"].ToString()), int.Parse(dtEncabezadoPrecargue.Rows[0]["cer_Consecutivo"].ToString()));

        // BORRAR TODO CERTIFICADO ANTERIOR
        AdministrarCertificados.EliminarCertificado(int.Parse(Session["cer_Id"].ToString()));


        DataTable otrosAsegurados = (DataTable)Session["otrosAsegurados"];
        DataTable dtTemp = (DataTable)Session["dtTemp"];
        DataTable dtEliminarPrincipal = (DataTable)Session["dtEliminarPrincipal"];
        DataTable dtEliminarConyuge = (DataTable)Session["dtEliminarConyuge"];
        DataTable dtExtraPrimaConyuge = (DataTable)Session["dtExtraPrimaConyugeGuardarFinal"];
        DataTable dtExtraPrimaPrincipal = (DataTable)Session["dtExtraPrimaPrincipalGuardarFinal"];
        // DataTable dtCrearExtraPrima = (DataTable)Session["dtCrearExtraPrima"];
        //string movimientoPrincipal = "NOTIENE";
        //string movimientoConyuge = "NOTIENE";
        string movimientoOtrosAsegurados = (string)Session["movimientoOtrosAsegurados"];

        // Comprobar que no tenga carta de retiro
        int estado = CanceladoPorFechaRetiro();
        string estadoCertificado = "PRODUCCION NUEVA";
        if (estado == 1)
            estadoCertificado = "CANCELADO";

        int recuperado = CertificadoRecuperado();



        ///////////////////////////////////////////////////////////////-- Novedades Sebastian //////////////////////////////////////////////////////

        DataTable dtNovedades = new DataTable();

        DataColumn columns = new DataColumn();
        columns.DataType = System.Type.GetType("System.String");
        columns.AllowDBNull = true;
        columns.ColumnName = "producto";
        dtNovedades.Columns.Add(columns);

        columns = new DataColumn();
        columns.DataType = System.Type.GetType("System.String");
        columns.AllowDBNull = true;
        columns.ColumnName = "tercero";
        dtNovedades.Columns.Add(columns);

        columns = new DataColumn();
        columns.DataType = System.Type.GetType("System.String");
        columns.AllowDBNull = true;
        columns.ColumnName = "certificado";
        dtNovedades.Columns.Add(columns);

        columns = new DataColumn();
        columns.DataType = System.Type.GetType("System.String");
        columns.AllowDBNull = true;
        columns.ColumnName = "convenio";
        dtNovedades.Columns.Add(columns);

        columns = new DataColumn();
        columns.DataType = System.Type.GetType("System.String");
        columns.AllowDBNull = true;
        columns.ColumnName = "mes";
        dtNovedades.Columns.Add(columns);

        columns = new DataColumn();
        columns.DataType = System.Type.GetType("System.String");
        columns.AllowDBNull = true;
        columns.ColumnName = "anio";
        dtNovedades.Columns.Add(columns);

        columns = new DataColumn();
        columns.DataType = System.Type.GetType("System.String");
        columns.AllowDBNull = true;
        columns.ColumnName = "prima";
        dtNovedades.Columns.Add(columns);

        DataRow producto = dtNovedades.NewRow();
        producto["producto"] = ddlProducto.SelectedValue.ToString();
        producto["tercero"] = txtCedulaPrincipal.Text;
        producto["certificado"] = int.Parse(Session["cer_Id"].ToString());
        producto["convenio"] = ddlConvenioPrincipal.SelectedValue.ToString();
        producto["mes"] = txtmesProduccion.Text;
        producto["anio"] = 2015;
        producto["prima"] = txtPrima.Text;
        dtNovedades.Rows.Add(producto);

        DataTable dtArchivo = new DataTable();
        dtArchivo = AdministrarCertificados.ConsultarIdArchivo(int.Parse(dtNovedades.Rows[0]["producto"].ToString()), int.Parse(dtNovedades.Rows[0]["convenio"].ToString()));

        DataTable dtArchivoPagaduria = new DataTable();
        dtArchivoPagaduria = AdministrarCertificados.ConsultarArchivoPagaduriaPorId(int.Parse(dtArchivo.Rows[0]["arcpag_Id"].ToString()));

        Session["dtArchivo"] = dtArchivo;

        DataTable dtPeriodicidad = new DataTable();
        dtPeriodicidad = AdministrarCertificados.ConsultarPeriodicidadPorConvenio(int.Parse(dtNovedades.Rows[0]["convenio"].ToString()));

        double primaCertificado = 0;
        primaCertificado = int.Parse(dtNovedades.Rows[0]["prima"].ToString());

        Session["dtNovedades"] = dtNovedades;

        int periodicidad = 0;
        periodicidad = int.Parse(dtPeriodicidad.Rows[0]["con_PeriodicidadPago"].ToString());

        double valorTotal = CalcularValorNovedadCertificado(primaCertificado, periodicidad);

        ///////////////////////////////////////////////////////////////-- Novedades Sebastian //////////////////////////////////////////////////////

      
        Session["cerId_ValorAnterior"] = cer_Id;
        Session["cer_Id"] = cer_Id;
        Session["cer_IdNuevo"] = cer_IdNuevo;

       if(cer_Id.ToString() == cer_IdNuevo.ToString())
       {
           Session["operacionCertificado"] = "ingresar";
           Session["cerId_ValorAnterior"] = 0;
       }


       if (txtCedulaConyuge.Text != "")
       {
           Page.Validate("grpValidacionConyuge");
       }
       if (Page.IsValid)
       {
           //VALIDACION BENEFICIARIO PRINCIPAL
           DataTable dtBeneficiario = (DataTable)Session["dtBeneficiario"];
           DataTable dtBeneficiarioConyuge = (DataTable)Session["dtBeneficiarioConyuge"];
           if ((string)Session["operacionCertificado"] == "modificar")
           {
               // CALCULO DEL MOVIMIENTO DEL PRINCIPAL
               // Movimiento Principal
               //INSERTAR CERTIFICADO
               // Consultar Amparo Basico Anterior
               int idFila = 0;
               int cont = 0;
               foreach (DataRow row in dtEliminarPrincipal.Rows)
               {
                   if (row["Amparo"].ToString() == "Amparo Básico")
                       idFila = cont;
                   cont++;
               }
               DataTable dtAmparoAnterior = new DataTable();
               dtAmparoAnterior = AdministrarCertificados.ConsultarAmparoBasicoAnterior(cer_Id, int.Parse(txtCedulaPrincipal.Text));
               // Preguntar si aumento, rebajó o siguió igual



               /* if (double.Parse(dtAmparoAnterior.Rows[0]["ampcer_ValAsegurado"].ToString()) > double.Parse(dtEliminarPrincipal.Rows[idFila]["Valor Asegurado"].ToString()))
                    movimientoPrincipal = "DISMINUYE";

                if (double.Parse(dtAmparoAnterior.Rows[0]["ampcer_ValAsegurado"].ToString()) == double.Parse(dtEliminarPrincipal.Rows[idFila]["Valor Asegurado"].ToString()))
                    movimientoPrincipal = "IGUAL";

                if (double.Parse(dtAmparoAnterior.Rows[0]["ampcer_ValAsegurado"].ToString()) < double.Parse(dtEliminarPrincipal.Rows[idFila]["Valor Asegurado"].ToString()))
                    movimientoPrincipal = "AUMENTA";       */

               int total = 0;
               foreach (DataRow row in dtBeneficiario.Rows)
               {
                   total = total + int.Parse(row["Porcentaje"].ToString());
               }

               if (total == 100)
               {
                   string idConyuge = txtCedulaConyuge.Text;
                   if (idConyuge == "")
                   {
                       idConyuge = "0";
                   }
                   //VALIDACION BENEFICIARIO CONYUGE


                   /////////////////////////////////////////////////////////////////////////////////////////
                   if (idConyuge != "0")
                   {
                       // CALCULO DEL MOVIMIENTO DEL CÓNYUGE
                       // Movimiento Cónyuge
                       //INSERTAR CÓNYUGE
                       // Consultar Amparo Basico Anterior del cónyuge
                       idFila = 0;
                       cont = 0;
                       foreach (DataRow row in dtEliminarConyuge.Rows)
                       {
                           if (row["Amparo"].ToString() == "Amparo Básico")
                               idFila = cont;
                           cont++;
                       }
                       // Preguntar si aumento, rebajó o siguió igual
                       DataTable dtAmparoAnteriorCony = new DataTable();
                       dtAmparoAnteriorCony = AdministrarCertificados.ConsultarAmparoBasicoAnterior(cer_Id, int.Parse(txtCedulaConyuge.Text));
                       //try
                       //{
                       //    if (double.Parse(dtAmparoAnteriorCony.Rows[0]["ampcer_ValAsegurado"].ToString()) > double.Parse(dtEliminarConyuge.Rows[idFila]["Valor Asegurado"].ToString()))
                       //        movimientoConyuge = "DISMINUYE";
                       //    if (double.Parse(dtAmparoAnteriorCony.Rows[0]["ampcer_ValAsegurado"].ToString()) == double.Parse(dtEliminarConyuge.Rows[idFila]["Valor Asegurado"].ToString()))
                       //        movimientoConyuge = "IGUAL";
                       //    if (double.Parse(dtAmparoAnteriorCony.Rows[0]["ampcer_ValAsegurado"].ToString()) < double.Parse(dtEliminarConyuge.Rows[idFila]["Valor Asegurado"].ToString()))
                       //        movimientoConyuge = "AUMENTA";
                       //}
                       //catch
                       //{
                       //    movimientoConyuge = "NOTIENE";
                       //}

                       // Cúmulos
                       int totalBeneficiarioConyuge = 0;
                       foreach (DataRow row in dtBeneficiarioConyuge.Rows)
                       {
                           if (row["Porcentaje"].ToString() != "")
                               totalBeneficiarioConyuge = totalBeneficiarioConyuge + int.Parse(row["Porcentaje"].ToString());
                       }

                       if (totalBeneficiarioConyuge == 100)
                       {
                           AdministrarCertificados.insertarBeneficiario(dtBeneficiario, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 1);

                           int plaPrincipal;
                           if (ddlPlanPrincipal.Text != "")
                           {
                               plaPrincipal = int.Parse(ddlPlanPrincipal.SelectedValue.ToString());
                           }
                           else
                           {
                               plaPrincipal = 0;
                           }
                           btnCertificado.Enabled = true;

                           //int tipoMovimientoDefinitivo = DeterminarTipoMovimiento(movimientoPrincipal, movimientoConyuge, movimientoOtrosAsegurados);
                           AdministrarCertificados.ActualizarNewCertificado(cer_IdNuevo, int.Parse(txtPrima.Text), AdministrarCertificados.certificadoPre.Consecutivo.ToString(), ddlConvenioPrincipal.SelectedValue.ToString(),
                          txtDeclaracionAsegurado.Text, txtDeclaracionEG.Text, estadoCertificado, txtEstatura.Text, txtestaturaPrincipal.Text, "0", int.Parse(idConyuge),
                          "0", txtPeso.Text, txtpesoPrincipal.Text, 50, 50, 50, int.Parse(ddlLocalidadCertificado.SelectedValue.ToString()), plaPrincipal, int.Parse(ddlPoliza.SelectedValue.ToString()),
                          3, recuperado, Convert.ToDateTime(txtFechaDigitacionCertificado.Text), int.Parse(ddlperiodoPagoCertificado.SelectedValue.ToString()));
                           //ActualizarCertificadoPreCargado();
                           //INSERTAR AMPAROS PRINCIPAL
                           AdministrarCertificados.insertarAmparos(dtEliminarPrincipal, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 1);

                           if (dtExtraPrimaPrincipal == null)
                           {
                               dtExtraPrimaPrincipal = dtEliminarPrincipal;

                               DataColumn columnsDigitar = new DataColumn();
                               columnsDigitar.DataType = System.Type.GetType("System.String");
                               columnsDigitar.AllowDBNull = true;
                               columnsDigitar.Caption = "Porcentaje";
                               columnsDigitar.ColumnName = "Porcentaje";
                               columnsDigitar.DefaultValue = 0;
                               dtExtraPrimaPrincipal.Columns.Add(columnsDigitar);


                           }
                           AdministrarCertificados.InsertarAmparosExtraPrima(dtExtraPrimaPrincipal, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 1);
                           //INSERTAR AMPAROS CONYUGE
                           if (idConyuge != "0")
                           {
                               AdministrarCertificados.insertarAmparos(dtEliminarConyuge, cer_IdNuevo, int.Parse(txtCedulaConyuge.Text), 2);
                               if (dtExtraPrimaConyuge == null)
                               {
                                   dtExtraPrimaConyuge = dtEliminarConyuge;

                                   DataColumn columnsDigitar = new DataColumn();
                                   columnsDigitar.DataType = System.Type.GetType("System.String");
                                   columnsDigitar.AllowDBNull = true;
                                   columnsDigitar.Caption = "Porcentaje";
                                   columnsDigitar.ColumnName = "Porcentaje";
                                   columnsDigitar.DefaultValue = 0;
                                   dtExtraPrimaConyuge.Columns.Add(columnsDigitar);
                               }
                               AdministrarCertificados.InsertarAmparosExtraPrima(dtExtraPrimaConyuge, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 2);
                           }

                           //INSERTAR OTROS ASEGURADOS
                           if (otrosAsegurados.Rows.Count > 0)
                           {
                               AdministrarCertificados.IngresarOtrosAsegurados(dtTemp, cer_IdNuevo);
                           }

                           AdministrarCertificados.insertarBeneficiario(dtBeneficiarioConyuge, cer_IdNuevo, int.Parse(txtCedulaConyuge.Text), 2);

                           /// Crear tabla para el almacenamiento de la extra prima
                           DataTable dtCrearExtraPrima = new DataTable();

                           DataColumn columnsCrearExtraPrima = new DataColumn();
                           columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                           columnsCrearExtraPrima.AllowDBNull = true;
                           columnsCrearExtraPrima.ColumnName = "cer_IdNuevo";
                           dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                           columnsCrearExtraPrima = new DataColumn();
                           columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                           columnsCrearExtraPrima.AllowDBNull = true;
                           columnsCrearExtraPrima.ColumnName = "cer_IdAntiguo";
                           dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                           columnsCrearExtraPrima = new DataColumn();
                           columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                           columnsCrearExtraPrima.AllowDBNull = true;
                           columnsCrearExtraPrima.ColumnName = "ext_ValorAseguradoP";
                           dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                           columnsCrearExtraPrima = new DataColumn();
                           columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                           columnsCrearExtraPrima.AllowDBNull = true;
                           columnsCrearExtraPrima.ColumnName = "ext_ValorAseguradoC";
                           dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                           columnsCrearExtraPrima = new DataColumn();
                           columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                           columnsCrearExtraPrima.AllowDBNull = true;
                           columnsCrearExtraPrima.ColumnName = "ext_ValorExtraPrimaP";
                           dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                           columnsCrearExtraPrima = new DataColumn();
                           columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                           columnsCrearExtraPrima.AllowDBNull = true;
                           columnsCrearExtraPrima.ColumnName = "ext_ValorExtraPrimaC";
                           dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                           columnsCrearExtraPrima = new DataColumn();
                           columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                           columnsCrearExtraPrima.AllowDBNull = true;
                           columnsCrearExtraPrima.ColumnName = "extValorPrimaP";
                           dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                           columnsCrearExtraPrima = new DataColumn();
                           columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                           columnsCrearExtraPrima.AllowDBNull = true;
                           columnsCrearExtraPrima.ColumnName = "extValorPrimaC";
                           dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                           columnsCrearExtraPrima = new DataColumn();
                           columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                           columnsCrearExtraPrima.AllowDBNull = true;
                           columnsCrearExtraPrima.ColumnName = "par_IdP";
                           dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                           columnsCrearExtraPrima = new DataColumn();
                           columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                           columnsCrearExtraPrima.AllowDBNull = true;
                           columnsCrearExtraPrima.ColumnName = "par_IdC";
                           dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                           columnsCrearExtraPrima = new DataColumn();
                           columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                           columnsCrearExtraPrima.AllowDBNull = true;
                           columnsCrearExtraPrima.ColumnName = "bandera";
                           dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                           double valorAseguradoP = 0;
                           double valorAseguradoC = 0;
                           double totalP = 0;
                           if (int.Parse(Session["valorExtraPrimado"].ToString()) != 0)
                           {
                               totalP = double.Parse(Session["valorExtraPrimado"].ToString()) - double.Parse(Session["totalExtraPrimaP"].ToString());
                           }
                           double totalC = 0;
                           if (int.Parse(Session["valorExtraPrimadoC"].ToString()) != 0)
                           {
                               totalC = double.Parse(Session["valorExtraPrimadoC"].ToString()) - double.Parse(Session["totalExtraPrimaC"].ToString());
                           }
                           DataRow ExtraPrima = dtCrearExtraPrima.NewRow();
                           ExtraPrima["cer_IdNuevo"] = cer_IdNuevo;
                           ExtraPrima["cer_IdAntiguo"] = cer_Id;
                           if (int.Parse(Session["diferenciaValorAseguradoP"].ToString()) != 0)
                           {
                               ExtraPrima["ext_ValorAseguradoP"] = Session["diferenciaValorAseguradoP"].ToString();//Diferencia
                           }
                           else
                           {

                               if (ddlPlanPrincipal.SelectedItem.ToString() != "")
                               {
                                   valorAseguradoP = double.Parse(ddlPlanPrincipal.SelectedItem.ToString());
                               }
                               else
                               {
                                   valorAseguradoP = double.Parse(txtPlanPrincipal.Text);
                               }

                               ExtraPrima["ext_ValorAseguradoP"] = valorAseguradoP;
                           }
                           if (Session["diferenciaValorAseguradoC"] != null)
                           {
                               ExtraPrima["ext_ValorAseguradoC"] = Session["diferenciaValorAseguradoC"].ToString();
                           }
                           else
                           {
                               if (ddlPlanConyuge.SelectedItem.ToString() != "")
                               {
                                   valorAseguradoC = double.Parse(ddlPlanConyuge.SelectedItem.ToString());
                               }
                               else
                               {
                                   valorAseguradoC = double.Parse(txtPlanConyuge.Text);
                               }

                               ExtraPrima["ext_ValorAseguradoC"] = valorAseguradoP;
                           }

                           ExtraPrima["extValorPrimaP"] = Session["TotalExtraPrimaP"].ToString();// valor de la prima del Grid sin ser aun extraprimado
                           ExtraPrima["extValorPrimaC"] = Session["TotalExtraPrimaC"].ToString();
                           ExtraPrima["ext_ValorExtraPrimaP"] = totalP;// Variables antes y despues de editar
                           ExtraPrima["ext_ValorExtraPrimaC"] = totalC;
                           ExtraPrima["par_IdP"] = 1;
                           ExtraPrima["par_IdC"] = 2;
                           ExtraPrima["bandera"] = 1;
                           dtCrearExtraPrima.Rows.Add(ExtraPrima);

                           Session["dtCrearExtraPrima"] = dtCrearExtraPrima;

                           AdministrarCertificados.ConsultaYAlmacenarExtraPrima(dtCrearExtraPrima);
                           //AdministrarCertificados.CrearExtraPrima(int.Parse(dtCrearExtraPrima.Rows[0]["cer_IdNuevo"].ToString()),
                           //int.Parse(dtCrearExtraPrima.Rows[0]["cer_IdAntiguo"].ToString()), double.Parse(dtCrearExtraPrima.Rows[0]["ext_ValorAseguradoP"].ToString()),
                           //double.Parse(dtCrearExtraPrima.Rows[0]["ext_ValorExtraPrimaP"].ToString()), double.Parse(dtCrearExtraPrima.Rows[0]["extValorPrimaP"].ToString()),
                           //int.Parse(dtCrearExtraPrima.Rows[0]["par_IdP"].ToString()));

                           //AdministrarCertificados.CrearExtraPrima(int.Parse(dtCrearExtraPrima.Rows[0]["cer_IdNuevo"].ToString()),
                           //int.Parse(dtCrearExtraPrima.Rows[0]["cer_IdAntiguo"].ToString()), double.Parse(dtCrearExtraPrima.Rows[0]["ext_ValorAseguradoC"].ToString()),
                           //double.Parse(dtCrearExtraPrima.Rows[0]["ext_ValorExtraPrimaC"].ToString()), double.Parse(dtCrearExtraPrima.Rows[0]["extValorPrimaC"].ToString()),
                           //int.Parse(dtCrearExtraPrima.Rows[0]["par_IdC"].ToString()));
                        }
                        else
                        {
                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL PORCENTAJE DE LOS BENEFICIARIOS DE EL ASEGURADO CONYUGE NO SUMAN EL 100%" + "');", true);
                            btnCertificado.Enabled = true;
                        }
                   }
                   /////////////////////////////////////////////////////////////////////////////////////////
                   else
                   {
                       AdministrarCertificados.insertarBeneficiario(dtBeneficiario, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 1);

                       //INSERTAR CERTIFICADO
                       btnCertificado.Enabled = true;

                       int plaPrincipal;
                       if (ddlPlanPrincipal.Text != "")
                       {
                           plaPrincipal = int.Parse(ddlPlanPrincipal.SelectedValue.ToString());
                       }
                       else
                       {
                           plaPrincipal = 0;
                       }
                       //int tipoMovimientoDefinitivo = DeterminarTipoMovimiento(movimientoPrincipal, movimientoConyuge, movimientoOtrosAsegurados);
                       AdministrarCertificados.ActualizarNewCertificado(cer_IdNuevo, int.Parse(txtPrima.Text), AdministrarCertificados.certificadoPre.Consecutivo.ToString(), ddlConvenioPrincipal.SelectedValue.ToString(),
                       txtDeclaracionAsegurado.Text, txtDeclaracionEG.Text, estadoCertificado, txtEstatura.Text, txtestaturaPrincipal.Text, "0", int.Parse(idConyuge),
                       "0", txtPeso.Text, txtpesoPrincipal.Text, 50, 50, 50, int.Parse(ddlLocalidadCertificado.SelectedValue.ToString()), plaPrincipal, int.Parse(ddlPoliza.SelectedValue.ToString()),
                       3, recuperado, Convert.ToDateTime(txtFechaDigitacionCertificado.Text), int.Parse(ddlperiodoPagoCertificado.SelectedValue.ToString()));
                       //ActualizarCertificadoPreCargado();
                       //INSERTAR AMPAROS PRINCIPAL
                       AdministrarCertificados.insertarAmparos(dtEliminarPrincipal, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 1);
                       if (dtExtraPrimaPrincipal == null)
                       {
                           dtExtraPrimaPrincipal = dtEliminarPrincipal;

                           DataColumn columnsDigitar = new DataColumn();
                           columnsDigitar.DataType = System.Type.GetType("System.String");
                           columnsDigitar.AllowDBNull = true;
                           columnsDigitar.Caption = "Porcentaje";
                           columnsDigitar.ColumnName = "Porcentaje";
                           columnsDigitar.DefaultValue = 0;
                           dtExtraPrimaPrincipal.Columns.Add(columnsDigitar);

                       }
                       AdministrarCertificados.InsertarAmparosExtraPrima(dtExtraPrimaPrincipal, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 1);
                       //INSERTAR OTROS ASEGURADOS
                       if (otrosAsegurados.Rows.Count > 0)
                       {
                           AdministrarCertificados.IngresarOtrosAsegurados(dtTemp, cer_IdNuevo);
                       }
                       DataTable dtCrearExtraPrima = new DataTable();

                       DataColumn columnsCrearExtraPrima = new DataColumn();
                       columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                       columnsCrearExtraPrima.AllowDBNull = true;
                       columnsCrearExtraPrima.ColumnName = "cer_IdNuevo";
                       dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                       columnsCrearExtraPrima = new DataColumn();
                       columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                       columnsCrearExtraPrima.AllowDBNull = true;
                       columnsCrearExtraPrima.ColumnName = "cer_IdAntiguo";
                       dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                       columnsCrearExtraPrima = new DataColumn();
                       columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                       columnsCrearExtraPrima.AllowDBNull = true;
                       columnsCrearExtraPrima.ColumnName = "ext_ValorAseguradoP";
                       dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                       columnsCrearExtraPrima = new DataColumn();
                       columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                       columnsCrearExtraPrima.AllowDBNull = true;
                       columnsCrearExtraPrima.ColumnName = "ext_ValorExtraPrimaP";
                       dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);


                       columnsCrearExtraPrima = new DataColumn();
                       columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                       columnsCrearExtraPrima.AllowDBNull = true;
                       columnsCrearExtraPrima.ColumnName = "extValorPrimaP";
                       dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);


                       columnsCrearExtraPrima = new DataColumn();
                       columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                       columnsCrearExtraPrima.AllowDBNull = true;
                       columnsCrearExtraPrima.ColumnName = "par_IdP";
                       dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                       columnsCrearExtraPrima = new DataColumn();
                       columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                       columnsCrearExtraPrima.AllowDBNull = true;
                       columnsCrearExtraPrima.ColumnName = "bandera";
                       dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                       double valorAseguradoP = 0;
                       double totalP = 0;

                       if (int.Parse(Session["valorExtraPrimado"].ToString()) != 0)
                       {
                           totalP = double.Parse(Session["valorExtraPrimado"].ToString()) - double.Parse(Session["totalExtraPrimaP"].ToString());
                       }
                       DataRow ExtraPrima = dtCrearExtraPrima.NewRow();
                       ExtraPrima["cer_IdNuevo"] = cer_IdNuevo;
                       ExtraPrima["cer_IdAntiguo"] = cer_Id;
                       if (int.Parse(Session["diferenciaValorAseguradoP"].ToString()) != 0)
                       {
                           ExtraPrima["ext_ValorAseguradoP"] = Session["diferenciaValorAseguradoP"].ToString();//Diferencia
                       }
                       else
                       {
                           if (ddlPlanPrincipal.SelectedItem.ToString() != "")
                           {
                               valorAseguradoP = double.Parse(ddlPlanPrincipal.SelectedItem.ToString());
                           }
                           else
                           {
                               valorAseguradoP = double.Parse(txtPlanPrincipal.Text);
                           }

                           ExtraPrima["ext_ValorAseguradoP"] = valorAseguradoP;
                       }
                       ExtraPrima["extValorPrimaP"] = Session["TotalExtraPrimaP"].ToString();
                       ExtraPrima["ext_ValorExtraPrimaP"] = totalP;
                       ExtraPrima["par_IdP"] = 1;
                       ExtraPrima["bandera"] = 0;
                       dtCrearExtraPrima.Rows.Add(ExtraPrima);

                       Session["dtCrearExtraPrima"] = dtCrearExtraPrima;

                       AdministrarCertificados.ConsultaYAlmacenarExtraPrima(dtCrearExtraPrima);
                       //AdministrarCertificados.CrearExtraPrima(int.Parse(dtCrearExtraPrima.Rows[0]["cer_IdNuevo"].ToString()),
                       //int.Parse(dtCrearExtraPrima.Rows[0]["cer_IdAntiguo"].ToString()), double.Parse(dtCrearExtraPrima.Rows[0]["ext_ValorAseguradoP"].ToString()),
                       //double.Parse(dtCrearExtraPrima.Rows[0]["ext_ValorExtraPrimaP"].ToString()), double.Parse(dtCrearExtraPrima.Rows[0]["extValorPrimaP"].ToString()),
                       //int.Parse(dtCrearExtraPrima.Rows[0]["par_IdP"].ToString()));
                    }

                   AdministrarCertificados.ActualizarCertificadoAnterior(cer_Id);
                   if ((string)Session["operacionCertificado"] == "modificar")
                   {
                       Session["cer_Id"] = cer_IdNuevo;

                       CalcularNovedades(dtPeriodicidad, dtArchivoPagaduria);
                       DataTable dtEncabezadoCertificadoNuevo = new DataTable();
                       DataTable dtEncabezadoCertificadoAntiguo = new DataTable();
                       dtEncabezadoCertificadoNuevo = AdministrarCertificados.spConsultarEncabezadoCertificado(int.Parse(Session["cer_IdNuevo"].ToString()));
                       dtEncabezadoCertificadoAntiguo = AdministrarCertificados.spConsultarEncabezadoCertificado(int.Parse(Session["cerId_ValorAnterior"].ToString()));
                       Session["dtEncabezadoCertificadoAntiguo"] = dtEncabezadoCertificadoAntiguo;
                       if (dtEncabezadoCertificadoAntiguo.Rows.Count > 0)
                       {
                           if (int.Parse(dtEncabezadoCertificadoNuevo.Rows[0]["Paga_Id"].ToString()) != int.Parse(dtEncabezadoCertificadoAntiguo.Rows[0]["Paga_Id"].ToString()))
                           {
                               DataTable dtArchivoAntiguo = new DataTable();
                               dtArchivoAntiguo = AdministrarCertificados.ConsultarIdArchivo(int.Parse(dtEncabezadoCertificadoAntiguo.Rows[0]["pro_Id"].ToString()), int.Parse(dtEncabezadoCertificadoAntiguo.Rows[0]["con_Id"].ToString()));

                               DataTable dtArchivoPagaduriaAntiguo = new DataTable();
                               dtArchivoPagaduriaAntiguo = AdministrarCertificados.ConsultarArchivoPagaduriaPorId(int.Parse(dtArchivoAntiguo.Rows[0]["arcpag_Id"].ToString()));

                               Session["dtArchivoAntiguo"] = dtArchivoAntiguo;

                               DataTable dtPeriodicidadAntiguo = new DataTable();
                               dtPeriodicidadAntiguo = AdministrarCertificados.ConsultarPeriodicidadPorConvenio(int.Parse(dtEncabezadoCertificadoAntiguo.Rows[0]["con_Id"].ToString()));

                               CalcularNovedadesRetiroRetiro(dtPeriodicidadAntiguo, dtArchivoPagaduriaAntiguo);
                           }
                       }
                       List<int> listaTipoMovimiento = new List<int>();
                       List<int> listaPlapolId = AdministrarCertificados.ConsultarPlapolIdCertificado(int.Parse(Session["cerId_ValorAnterior"].ToString()), int.Parse(Session["cerId_ValorNuevo"].ToString()));
                       if (listaPlapolId[0] != 0 && listaPlapolId[1] != 0)
                       {
                           listaTipoMovimiento = AdministrarCertificados.CalcularTipoMovimiento(int.Parse(Session["cerId_ValorAnterior"].ToString()), int.Parse(Session["cerId_ValorNuevo"].ToString()), listaPlapolId[0], listaPlapolId[1]);

                       }
                       else
                       {
                           if (listaPlapolId[0] == 0 && listaPlapolId[1] != 0)
                           {
                               listaTipoMovimiento = AdministrarCertificados.CalcularTipoMovimiento(int.Parse(Session["cerId_ValorAnterior"].ToString()), int.Parse(Session["cerId_ValorNuevo"].ToString()), 0, listaPlapolId[1]);
                           }

                           if (listaPlapolId[0] != 0 && listaPlapolId[1] == 0)
                           {
                               listaTipoMovimiento = AdministrarCertificados.CalcularTipoMovimiento(int.Parse(Session["cerId_ValorAnterior"].ToString()), int.Parse(Session["cerId_ValorNuevo"].ToString()), listaPlapolId[0], 0);
                           }

                           if (listaPlapolId[0] == 0 && listaPlapolId[1] == 0)
                           {
                               listaTipoMovimiento = AdministrarCertificados.CalcularTipoMovimiento(int.Parse(Session["cerId_ValorAnterior"].ToString()), int.Parse(Session["cerId_ValorNuevo"].ToString()), 0, 0);
                           }
                       }

                       // Si es reexpedición se debe actualizar la fecha de vigencia
                       DateTime fechaVigencia = new DateTime();
                       DataTable dtEncabezadoCertificado = (DataTable)Session["dtEncabezadoCertificado"];
                       if (listaTipoMovimiento[3] == 0)
                       {
                           fechaVigencia = AdministrarCertificados.CalcularFechaVigencia(txtmesProduccion.Text, dtEncabezadoCertificado.Rows[0]["cer_AnoProduccion"].ToString());
                           AdministrarCertificados.ActualizarFechaVigencia(int.Parse(Session["cerId_ValorNuevo"].ToString()), fechaVigencia);
                       }

                       AdministrarCertificados.ActualizarTipoMovimientoCertificado(int.Parse(Session["cerId_ValorNuevo"].ToString()), listaTipoMovimiento[0], listaTipoMovimiento[1], listaTipoMovimiento[2]);


                       Response.Redirect("ResumenCertificado.aspx");
                    }
                }
                else
                {
                    btnCertificado.Enabled = true;
                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL PORCENTAJE DE LOS BENEFICIARIOS DE EL ASEGURADO PRINCIPAL NO SUMAN EL 100%" + "');", true);
                }
            }

            // Si es un ingreso nuevo
           else
           {
               //VALIDACION BENEFICIARIO PRINCIPAL
               int total = 0;
               foreach (DataRow row in dtBeneficiario.Rows)
               {
                   total = total + int.Parse(row["Porcentaje"].ToString());
               }

                if (total == 100)
                {
                    string idConyuge = txtCedulaConyuge.Text;
                    if (idConyuge == "")
                    {
                        idConyuge = "0";
                    }

                    //VALIDACION BENEFICIARIO CONYUGE
                    if (idConyuge != "0")
                    {
                        int totalBeneficiarioConyuge = 0;
                        //foreach (Asegurado row in beneficiarioConyuge)
                        foreach (DataRow row in dtBeneficiarioConyuge.Rows)
                        {
                            if (row["Porcentaje"].ToString() != "")
                                totalBeneficiarioConyuge = totalBeneficiarioConyuge + int.Parse(row["Porcentaje"].ToString());
                        }

                        if (totalBeneficiarioConyuge == 100)
                        {
                            AdministrarCertificados.insertarBeneficiario(dtBeneficiario, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 1);

                            //INSERTAR CERTIFICADO
                            int plaPrincipal;
                            if (ddlPlanPrincipal.Text != "")
                            {
                                plaPrincipal = int.Parse(ddlPlanPrincipal.SelectedValue.ToString());
                            }
                            else
                            {
                                plaPrincipal = 0;
                            }
                            btnCertificado.Enabled = true;
                            //int tipoMovimientoDefinitivo = DeterminarTipoMovimiento(movimientoPrincipal, movimientoConyuge, movimientoOtrosAsegurados);
                            AdministrarCertificados.ActualizarNewCertificado(cer_IdNuevo, int.Parse(txtPrima.Text), AdministrarCertificados.certificadoPre.Consecutivo.ToString(), ddlConvenioPrincipal.SelectedValue.ToString(),
                           txtDeclaracionAsegurado.Text, txtDeclaracionEG.Text, estadoCertificado, txtEstatura.Text, txtestaturaPrincipal.Text, "0", int.Parse(idConyuge),
                           "0", txtPeso.Text, txtpesoPrincipal.Text, 50, 50, 50, int.Parse(ddlLocalidadCertificado.SelectedValue.ToString()), plaPrincipal, int.Parse(ddlPoliza.SelectedValue.ToString()),
                           3, recuperado, Convert.ToDateTime(txtFechaDigitacionCertificado.Text), int.Parse(ddlperiodoPagoCertificado.SelectedValue.ToString()));
                            //ActualizarCertificadoPreCargado();
                            //INSERTAR AMPAROS PRINCIPAL
                            AdministrarCertificados.insertarAmparos(dtEliminarPrincipal, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 1);
                            if (dtExtraPrimaPrincipal == null)
                            {
                                dtExtraPrimaPrincipal = dtEliminarPrincipal;

                                DataColumn columnsDigitar = new DataColumn();
                                columnsDigitar.DataType = System.Type.GetType("System.String");
                                columnsDigitar.AllowDBNull = true;
                                columnsDigitar.Caption = "Porcentaje";
                                columnsDigitar.ColumnName = "Porcentaje";
                                columnsDigitar.DefaultValue = 0;
                                dtExtraPrimaPrincipal.Columns.Add(columnsDigitar);
                            }
                            AdministrarCertificados.InsertarAmparosExtraPrima(dtExtraPrimaPrincipal, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 1);
                            //INSERTAR AMPAROS CONYUGE
                            if (idConyuge != "0")
                            {
                                AdministrarCertificados.insertarAmparos(dtEliminarConyuge, cer_IdNuevo, int.Parse(txtCedulaConyuge.Text), 2);
                                if (dtExtraPrimaConyuge == null)
                                {
                                    dtExtraPrimaConyuge = dtEliminarConyuge;

                                    DataColumn columnsDigitar = new DataColumn();
                                    columnsDigitar.DataType = System.Type.GetType("System.String");
                                    columnsDigitar.AllowDBNull = true;
                                    columnsDigitar.Caption = "Porcentaje";
                                    columnsDigitar.ColumnName = "Porcentaje";
                                    columnsDigitar.DefaultValue = 0;
                                    dtExtraPrimaConyuge.Columns.Add(columnsDigitar);
                                }
                                AdministrarCertificados.InsertarAmparosExtraPrima(dtExtraPrimaConyuge, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 2);
                            }
                            //INSERTAR OTROS ASEGURADOS
                            if (otrosAsegurados.Rows.Count > 0)
                            {
                                AdministrarCertificados.IngresarOtrosAsegurados(dtTemp, cer_IdNuevo);
                            }


                            AdministrarCertificados.insertarBeneficiario(dtBeneficiarioConyuge, cer_IdNuevo, int.Parse(txtCedulaConyuge.Text), 2);

                            /// Crear tabla para el almacenamiento de la extra prima
                            DataTable dtCrearExtraPrima = new DataTable();

                            DataColumn columnsCrearExtraPrima = new DataColumn();
                            columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                            columnsCrearExtraPrima.AllowDBNull = true;
                            columnsCrearExtraPrima.ColumnName = "cer_IdNuevo";
                            dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                            columnsCrearExtraPrima = new DataColumn();
                            columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                            columnsCrearExtraPrima.AllowDBNull = true;
                            columnsCrearExtraPrima.ColumnName = "cer_IdAntiguo";
                            dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                            columnsCrearExtraPrima = new DataColumn();
                            columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                            columnsCrearExtraPrima.AllowDBNull = true;
                            columnsCrearExtraPrima.ColumnName = "ext_ValorAseguradoP";
                            dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                            columnsCrearExtraPrima = new DataColumn();
                            columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                            columnsCrearExtraPrima.AllowDBNull = true;
                            columnsCrearExtraPrima.ColumnName = "ext_ValorAseguradoC";
                            dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                            columnsCrearExtraPrima = new DataColumn();
                            columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                            columnsCrearExtraPrima.AllowDBNull = true;
                            columnsCrearExtraPrima.ColumnName = "ext_ValorExtraPrimaP";
                            dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                            columnsCrearExtraPrima = new DataColumn();
                            columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                            columnsCrearExtraPrima.AllowDBNull = true;
                            columnsCrearExtraPrima.ColumnName = "ext_ValorExtraPrimaC";
                            dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                            columnsCrearExtraPrima = new DataColumn();
                            columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                            columnsCrearExtraPrima.AllowDBNull = true;
                            columnsCrearExtraPrima.ColumnName = "extValorPrimaP";
                            dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                            columnsCrearExtraPrima = new DataColumn();
                            columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                            columnsCrearExtraPrima.AllowDBNull = true;
                            columnsCrearExtraPrima.ColumnName = "extValorPrimaC";
                            dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                            columnsCrearExtraPrima = new DataColumn();
                            columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                            columnsCrearExtraPrima.AllowDBNull = true;
                            columnsCrearExtraPrima.ColumnName = "par_IdP";
                            dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                            columnsCrearExtraPrima = new DataColumn();
                            columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                            columnsCrearExtraPrima.AllowDBNull = true;
                            columnsCrearExtraPrima.ColumnName = "par_IdC";
                            dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                            columnsCrearExtraPrima = new DataColumn();
                            columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                            columnsCrearExtraPrima.AllowDBNull = true;
                            columnsCrearExtraPrima.ColumnName = "bandera";
                            dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                            //double totalesP = 0;
                            double valorAseguradoP = 0;
                            double valorAseguradoC = 0;
                            double totalP = 0;

                            if (int.Parse(Session["valorExtraPrimado"].ToString()) != 0)
                            {
                                totalP = double.Parse(Session["valorExtraPrimado"].ToString()) - double.Parse(Session["totalExtraPrimaP"].ToString());
                            }
                            double totalC = 0;

                            if (int.Parse(Session["valorExtraPrimadoC"].ToString()) != 0)
                            {
                                totalC = double.Parse(Session["valorExtraPrimadoC"].ToString()) - double.Parse(Session["totalExtraPrimaC"].ToString());
                            }
                            DataRow ExtraPrima = dtCrearExtraPrima.NewRow();
                            ExtraPrima["cer_IdNuevo"] = cer_IdNuevo;
                            ExtraPrima["cer_IdAntiguo"] = cer_IdNuevo;
                            if (int.Parse(Session["diferenciaValorAseguradoP"].ToString()) != 0)
                            {
                                ExtraPrima["ext_ValorAseguradoP"] = Session["diferenciaValorAseguradoP"].ToString();//Diferencia
                            }
                            else
                            {
                                if (ddlPlanPrincipal.SelectedItem.ToString() != "")
                                {
                                    valorAseguradoP = double.Parse(ddlPlanPrincipal.SelectedItem.ToString());
                                }
                                else
                                {
                                    valorAseguradoP = double.Parse(txtPlanPrincipal.Text);
                                }

                                ExtraPrima["ext_ValorAseguradoP"] = valorAseguradoP;
                            }
                            if (int.Parse(Session["diferenciaValorAseguradoC"].ToString()) != 0)
                            {
                                ExtraPrima["ext_ValorAseguradoC"] = Session["diferenciaValorAseguradoC"].ToString();
                            }
                            else
                            {
                                if (ddlPlanConyuge.SelectedItem.ToString() != "")
                                {
                                    valorAseguradoC = double.Parse(ddlPlanConyuge.SelectedItem.ToString());
                                }
                                else
                                {
                                    valorAseguradoC = double.Parse(txtPlanConyuge.Text);
                                }
                                ExtraPrima["ext_ValorAseguradoC"] = valorAseguradoC;
                            }
                            ExtraPrima["extValorPrimaP"] = Session["TotalExtraPrimaP"].ToString();
                            ExtraPrima["extValorPrimaC"] = Session["TotalExtraPrimaC"].ToString();
                            ExtraPrima["ext_ValorExtraPrimaP"] = totalP;
                            ExtraPrima["ext_ValorExtraPrimaC"] = totalC;
                            ExtraPrima["par_IdP"] = 1;
                            ExtraPrima["par_IdC"] = 2;
                            ExtraPrima["bandera"] = 1;
                            dtCrearExtraPrima.Rows.Add(ExtraPrima);

                            Session["dtCrearExtraPrima"] = dtCrearExtraPrima;

                            AdministrarCertificados.ConsultaYAlmacenarExtraPrima(dtCrearExtraPrima);
                            //AdministrarCertificados.CrearExtraPrima(int.Parse(dtCrearExtraPrima.Rows[0]["cer_IdNuevo"].ToString()),
                            //int.Parse(dtCrearExtraPrima.Rows[0]["cer_IdAntiguo"].ToString()), double.Parse(dtCrearExtraPrima.Rows[0]["ext_ValorAseguradoP"].ToString()),
                            //double.Parse(dtCrearExtraPrima.Rows[0]["ext_ValorExtraPrimaP"].ToString()), double.Parse(dtCrearExtraPrima.Rows[0]["extValorPrimaP"].ToString()),
                            //int.Parse(dtCrearExtraPrima.Rows[0]["par_IdP"].ToString()));

                            //AdministrarCertificados.CrearExtraPrima(int.Parse(dtCrearExtraPrima.Rows[0]["cer_IdNuevo"].ToString()),
                            //int.Parse(dtCrearExtraPrima.Rows[0]["cer_IdAntiguo"].ToString()), double.Parse(dtCrearExtraPrima.Rows[0]["ext_ValorAseguradoC"].ToString()),
                            //double.Parse(dtCrearExtraPrima.Rows[0]["ext_ValorExtraPrimaC"].ToString()), double.Parse(dtCrearExtraPrima.Rows[0]["extValorPrimaC"].ToString()),
                            //int.Parse(dtCrearExtraPrima.Rows[0]["par_IdC"].ToString()));

                        }
                        else
                        {
                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL PORCENTAJE DE LOS BENEFICIARIOS DE EL ASEGURADO CONYUGE NO SUMAN EL 100%" + "');", true);
                        }
                    }
                    else
                    {

                        AdministrarCertificados.insertarBeneficiario(dtBeneficiario, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 1);
                        //INSERTAR CERTIFICADO

                        int plaPrincipal;
                        if (ddlPlanPrincipal.Text != "")
                        {
                            plaPrincipal = int.Parse(ddlPlanPrincipal.SelectedValue.ToString());
                        }
                        else
                        {
                            plaPrincipal = 0;
                        }
                        btnCertificado.Enabled = true;
                        //int tipoMovimientoDefinitivo = DeterminarTipoMovimiento(movimientoPrincipal, movimientoConyuge, movimientoOtrosAsegurados);
                        // Como es nuevo ingreso y no tiene cónyuge el movimiento es "Ingresa Principal"
                        AdministrarCertificados.ActualizarNewCertificado(cer_IdNuevo, int.Parse(txtPrima.Text), AdministrarCertificados.certificadoPre.Consecutivo.ToString(), ddlConvenioPrincipal.SelectedValue.ToString(),
                       txtDeclaracionAsegurado.Text, txtDeclaracionEG.Text, estadoCertificado, txtEstatura.Text, txtestaturaPrincipal.Text, "0", int.Parse(idConyuge),
                       "0", txtPeso.Text, txtpesoPrincipal.Text, 50, 50, 50, int.Parse(ddlLocalidadCertificado.SelectedValue.ToString()), plaPrincipal, int.Parse(ddlPoliza.SelectedValue.ToString()),
                       3, recuperado, Convert.ToDateTime(txtFechaDigitacionCertificado.Text), int.Parse(ddlperiodoPagoCertificado.SelectedValue.ToString()));
                        //ActualizarCertificadoPreCargado();
                        //INSERTAR AMPAROS PRINCIPAL
                        AdministrarCertificados.insertarAmparos(dtEliminarPrincipal, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 1);

                        if (dtExtraPrimaPrincipal == null)
                        {
                            dtExtraPrimaPrincipal = dtEliminarPrincipal;

                            DataColumn columnsDigitar = new DataColumn();
                            columnsDigitar.DataType = System.Type.GetType("System.String");
                            columnsDigitar.AllowDBNull = true;
                            columnsDigitar.Caption = "Porcentaje";
                            columnsDigitar.ColumnName = "Porcentaje";
                            columnsDigitar.DefaultValue = 0;
                            dtExtraPrimaPrincipal.Columns.Add(columnsDigitar);
                        }
                        AdministrarCertificados.InsertarAmparosExtraPrima(dtExtraPrimaPrincipal, cer_IdNuevo, int.Parse(txtCedulaPrincipal.Text), 1);
                        //INSERTAR OTROS ASEGURADOS
                        if (otrosAsegurados.Rows.Count > 0)
                        {
                            AdministrarCertificados.IngresarOtrosAsegurados(dtTemp, cer_IdNuevo);
                        }
                        DataTable dtCrearExtraPrima = new DataTable();

                        DataColumn columnsCrearExtraPrima = new DataColumn();
                        columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                        columnsCrearExtraPrima.AllowDBNull = true;
                        columnsCrearExtraPrima.ColumnName = "cer_IdNuevo";
                        dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                        columnsCrearExtraPrima = new DataColumn();
                        columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                        columnsCrearExtraPrima.AllowDBNull = true;
                        columnsCrearExtraPrima.ColumnName = "cer_IdAntiguo";
                        dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                        columnsCrearExtraPrima = new DataColumn();
                        columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                        columnsCrearExtraPrima.AllowDBNull = true;
                        columnsCrearExtraPrima.ColumnName = "ext_ValorAseguradoP";
                        dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                        columnsCrearExtraPrima = new DataColumn();
                        columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                        columnsCrearExtraPrima.AllowDBNull = true;
                        columnsCrearExtraPrima.ColumnName = "ext_ValorExtraPrimaP";
                        dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);


                        columnsCrearExtraPrima = new DataColumn();
                        columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                        columnsCrearExtraPrima.AllowDBNull = true;
                        columnsCrearExtraPrima.ColumnName = "extValorPrimaP";
                        dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);


                        columnsCrearExtraPrima = new DataColumn();
                        columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                        columnsCrearExtraPrima.AllowDBNull = true;
                        columnsCrearExtraPrima.ColumnName = "par_IdP";
                        dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);

                        columnsCrearExtraPrima = new DataColumn();
                        columnsCrearExtraPrima.DataType = System.Type.GetType("System.String");
                        columnsCrearExtraPrima.AllowDBNull = true;
                        columnsCrearExtraPrima.ColumnName = "bandera";
                        dtCrearExtraPrima.Columns.Add(columnsCrearExtraPrima);



                        double valorAseguradoP = 0;
                        double totalP = 0;

                        if (int.Parse(Session["valorExtraPrimado"].ToString()) != 0)
                        {
                            totalP = double.Parse(Session["valorExtraPrimado"].ToString()) - double.Parse(Session["totalExtraPrimaP"].ToString());
                        }

                        DataRow ExtraPrima = dtCrearExtraPrima.NewRow();
                        ExtraPrima["cer_IdNuevo"] = cer_IdNuevo;
                        ExtraPrima["cer_IdAntiguo"] = cer_IdNuevo;
                        if (int.Parse(Session["diferenciaValorAseguradoP"].ToString()) != 0)
                        {
                            ExtraPrima["ext_ValorAseguradoP"] = Session["diferenciaValorAseguradoP"].ToString();//Diferencia
                        }
                        else
                        {
                            if (ddlPlanPrincipal.SelectedItem.ToString() != "")
                            {
                                valorAseguradoP = double.Parse(ddlPlanPrincipal.SelectedItem.ToString());
                            }
                            else
                            {
                                valorAseguradoP = double.Parse(txtPlanPrincipal.Text);
                            }

                            ExtraPrima["ext_ValorAseguradoP"] = valorAseguradoP;
                        }
                        ExtraPrima["extValorPrimaP"] = Session["TotalExtraPrimaP"].ToString();
                        ExtraPrima["ext_ValorExtraPrimaP"] = totalP;
                        ExtraPrima["par_IdP"] = 1;
                        ExtraPrima["bandera"] = 0;
                        dtCrearExtraPrima.Rows.Add(ExtraPrima);

                        Session["dtCrearExtraPrima"] = dtCrearExtraPrima;

                        AdministrarCertificados.ConsultaYAlmacenarExtraPrima(dtCrearExtraPrima);
                        //AdministrarCertificados.CrearExtraPrima(int.Parse(dtCrearExtraPrima.Rows[0]["cer_IdNuevo"].ToString()),
                        //int.Parse(dtCrearExtraPrima.Rows[0]["cer_IdAntiguo"].ToString()), double.Parse(dtCrearExtraPrima.Rows[0]["ext_ValorAseguradoP"].ToString()),
                        //double.Parse(dtCrearExtraPrima.Rows[0]["ext_ValorExtraPrimaP"].ToString()), double.Parse(dtCrearExtraPrima.Rows[0]["extValorPrimaP"].ToString()),
                        //int.Parse(dtCrearExtraPrima.Rows[0]["par_IdP"].ToString()));
                    }
                    Session["cer_Id"] = cer_IdNuevo;
                    CalcularNovedades(dtPeriodicidad, dtArchivoPagaduria);

                    // Se crea el dt para almacenar en el la informacion del certificado nuevo
                    DataTable dtEncabezadoCertificadoNuevo = new DataTable();
                    // Se crea el dt para almacenar en el la informacion del certificado Antiguo
                    DataTable dtEncabezadoCertificadoAntiguo = new DataTable();

                    // Se Alacena la informacion que debe ir en el dtEncabezadoCertificadoNuevo
                    dtEncabezadoCertificadoNuevo = AdministrarCertificados.spConsultarEncabezadoCertificado(int.Parse(Session["cer_IdNuevo"].ToString()));

                    // Se Alacena la informacion que debe ir en el dtEncabezadoCertificadoAntiguo
                    dtEncabezadoCertificadoAntiguo = AdministrarCertificados.spConsultarEncabezadoCertificado(int.Parse(Session["cerId_ValorAnterior"].ToString()));
                    //Session para almacenar el dtEncabezadoCertificadoAntiguo
                    Session["dtEncabezadoCertificadoAntiguo"] = dtEncabezadoCertificadoAntiguo;

                    if (dtEncabezadoCertificadoAntiguo.Rows.Count > 0)
                    {
                        //Consdicional para identificar si la pagaduria anterior y la nueva no son iguales.
                        if (int.Parse(dtEncabezadoCertificadoNuevo.Rows[0]["Paga_Id"].ToString()) != int.Parse(dtEncabezadoCertificadoAntiguo.Rows[0]["Paga_Id"].ToString()))
                        {

                            // se consulta el archivo dependiendo del producto y el convenio
                            DataTable dtArchivoAntiguo = new DataTable();
                            dtArchivoAntiguo = AdministrarCertificados.ConsultarIdArchivo(int.Parse(dtEncabezadoCertificadoAntiguo.Rows[0]["pro_Id"].ToString()), int.Parse(dtEncabezadoCertificadoAntiguo.Rows[0]["con_Id"].ToString()));


                            // Consultar la estructura del archivo con el id capturado anteriormente
                            DataTable dtArchivoPagaduriaAntiguo = new DataTable();
                            dtArchivoPagaduriaAntiguo = AdministrarCertificados.ConsultarArchivoPagaduriaPorId(int.Parse(dtArchivoAntiguo.Rows[0]["arcpag_Id"].ToString()));

                            Session["dtArchivoAntiguo"] = dtArchivoAntiguo;

                            // se consulta la periodicidad de pago dependiendo del convenio
                            DataTable dtPeriodicidadAntiguo = new DataTable();
                            dtPeriodicidadAntiguo = AdministrarCertificados.ConsultarPeriodicidadPorConvenio(int.Parse(dtEncabezadoCertificadoAntiguo.Rows[0]["con_Id"].ToString()));


                            // se crea la funcion para calculas las novedades cuando la anterior y la nueva no son las mismas 
                            CalcularNovedadesRetiroRetiro(dtPeriodicidadAntiguo, dtArchivoPagaduriaAntiguo);
                        }
                    }

                    List<int> listaTipoMovimiento = new List<int>();
                    List<int> listaPlapolId = AdministrarCertificados.ConsultarPlapolIdCertificado(int.Parse(Session["cerId_ValorAnterior"].ToString()), int.Parse(Session["cerId_ValorNuevo"].ToString()));
                    if (listaPlapolId[0] != 0 && listaPlapolId[1] != 0)
                    {
                        listaTipoMovimiento = AdministrarCertificados.CalcularTipoMovimiento(int.Parse(Session["cerId_ValorAnterior"].ToString()), int.Parse(Session["cerId_ValorNuevo"].ToString()), listaPlapolId[0], listaPlapolId[1]);

                    }
                    else
                    {
                        if (listaPlapolId[0] == 0 && listaPlapolId[1] != 0)
                        {
                            listaTipoMovimiento = AdministrarCertificados.CalcularTipoMovimiento(int.Parse(Session["cerId_ValorAnterior"].ToString()), int.Parse(Session["cerId_ValorNuevo"].ToString()), 0, listaPlapolId[1]);
                        }

                        if (listaPlapolId[0] != 0 && listaPlapolId[1] == 0)
                        {
                            listaTipoMovimiento = AdministrarCertificados.CalcularTipoMovimiento(int.Parse(Session["cerId_ValorAnterior"].ToString()), int.Parse(Session["cerId_ValorNuevo"].ToString()), listaPlapolId[0], 0);
                        }

                        if (listaPlapolId[0] == 0 && listaPlapolId[1] == 0)
                        {
                            listaTipoMovimiento = AdministrarCertificados.CalcularTipoMovimiento(int.Parse(Session["cerId_ValorAnterior"].ToString()), int.Parse(Session["cerId_ValorNuevo"].ToString()), 0, 0);
                        }
                    }


                    // Si es reexpedición se debe actualizar la fecha de vigencia
                    DateTime fechaVigencia = new DateTime();
                    DataTable dtEncabezadoCertificado = (DataTable)Session["dtEncabezadoCertificado"];
                    if (listaTipoMovimiento[3] == 0)
                    {
                        fechaVigencia = AdministrarCertificados.CalcularFechaVigencia(txtmesProduccion.Text, dtEncabezadoCertificado.Rows[0]["cer_AnoProduccion"].ToString());
                        AdministrarCertificados.ActualizarFechaVigencia(int.Parse(Session["cerId_ValorNuevo"].ToString()), fechaVigencia);
                    }

                    AdministrarCertificados.ActualizarTipoMovimientoCertificado(int.Parse(Session["cerId_ValorNuevo"].ToString()), listaTipoMovimiento[0], listaTipoMovimiento[1], listaTipoMovimiento[2]);
                    Response.Redirect("ResumenCertificado.aspx");
                    Session["dtBeneficiario"] = dtBeneficiario;
                    Session["dtBeneficiarioConyuge"] = dtBeneficiarioConyuge;
                }
                else
                {
                    btnCertificado.Enabled = true;
                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL PORCENTAJE DE LOS BENEFICIARIOS DE EL ASEGURADO PRINCIPAL NO SUMAN EL 100%" + "');", true);
                }
            }
        }
    }


    //sebastian
    protected void grvBeneficiarioPrincipal_RowCommand(object sender, GridViewCommandEventArgs e)
    {
        if (e.CommandName.Equals("addNew"))
        {
            if (((TextBox)grvBeneficiarioPrincipal.FooterRow.FindControl("txtNewNombre")).Text != "")
            {
                TextBox txtNewNombre = (TextBox)grvBeneficiarioPrincipal.FooterRow.FindControl("txtNewNombre");
                TextBox txtNewApellido = (TextBox)grvBeneficiarioPrincipal.FooterRow.FindControl("txtNewApellido");
                TextBox txtNewCedula = (TextBox)grvBeneficiarioPrincipal.FooterRow.FindControl("txtNewCedula");
                TextBox txtNewEdad = (TextBox)grvBeneficiarioPrincipal.FooterRow.FindControl("txtNewEdad");
                TextBox txtNewPorcentaje = (TextBox)grvBeneficiarioPrincipal.FooterRow.FindControl("txtNewPorcentaje");
                DropDownList txtNewParentesco = (DropDownList)grvBeneficiarioPrincipal.FooterRow.FindControl("txtNewParentesco");

                Asegurado p = new Asegurado();
                p.Nombres = txtNewNombre.Text;
                p.Apellidos = txtNewApellido.Text;
                p.NumeroDocumento = txtNewCedula.Text;
                p.Edad = int.Parse(txtNewEdad.Text);
                p.Porcentaje = int.Parse(txtNewPorcentaje.Text);
                p.Parentesco = txtNewParentesco.SelectedItem.ToString();

                DataTable dtBeneficiario = (DataTable)Session["dtBeneficiario"];
                DataRow row = dtBeneficiario.NewRow();
                row["NumeroDocumento"] = p.NumeroDocumento;
                row["Apellidos"] = p.Apellidos;
                row["Nombres"] = p.Nombres;
                row["Edad"] = p.Edad;
                row["Porcentaje"] = p.Porcentaje;
                row["Parentesco"] = p.Parentesco;
                dtBeneficiario.Rows.Add(row);

                grvBeneficiarioPrincipal.DataSource = dtBeneficiario;
                grvBeneficiarioPrincipal.DataBind();

                if (dtBeneficiario.Rows.Count == 0)
                {
                    grvBeneficiarioPrincipal.FooterRow.Visible = true;
                }
                Session["dtBeneficiario"] = dtBeneficiario;

                //grvBeneficiarioPrincipal.Rows[0].Visible = false;

            }
        }
    }

    //sebastian
    protected void grvBeneficiarioPrincipal_RowDeleting1(object sender, GridViewDeleteEventArgs e)
    {
        DataTable dtBeneficiario = (DataTable)Session["dtBeneficiario"];
        dtBeneficiario.Rows.RemoveAt(e.RowIndex);
        grvBeneficiarioPrincipal.DataSource = dtBeneficiario;
        grvBeneficiarioPrincipal.DataBind();
        grvBeneficiarioPrincipal.Attributes.Add("onclick", "localStorage.setItem('accIndex', 1);");
        if (dtBeneficiario.Rows.Count == 0)
        {
            DataTable dtBeneficiarioVacio = dtBeneficiario.Clone();
            DataRow drBeneficiarioVacio = dtBeneficiarioVacio.NewRow();
            dtBeneficiarioVacio.Rows.Add(drBeneficiarioVacio);
            grvBeneficiarioPrincipal.DataSource = dtBeneficiarioVacio;
            grvBeneficiarioPrincipal.DataBind();
            grvBeneficiarioPrincipal.Rows[0].Visible = false;
            grvBeneficiarioPrincipal.Rows[0].Controls.Clear();
        }

        //grvBeneficiarioPrincipal.Rows[0].Visible = false;
        Session["dtBeneficiario"] = dtBeneficiario;
    }
    /*-------------------------------------------------Tabla beneficiario conyuge---------------------------------------------------*/


    protected void grvBeneficiarioConyuge_RowCommand(object sender, GridViewCommandEventArgs e)
    {
        if (e.CommandName.Equals("addNew"))
        {
            TextBox txtNewNombre = (TextBox)grvBeneficiarioConyuge.FooterRow.FindControl("txtNewNombre");
            TextBox txtNewApellido = (TextBox)grvBeneficiarioConyuge.FooterRow.FindControl("txtNewApellido");
            TextBox txtNewCedula = (TextBox)grvBeneficiarioConyuge.FooterRow.FindControl("txtNewCedula");
            TextBox txtNewEdad = (TextBox)grvBeneficiarioConyuge.FooterRow.FindControl("txtNewEdad");
            TextBox txtNewPorcentaje = (TextBox)grvBeneficiarioConyuge.FooterRow.FindControl("txtNewPorcentaje");
            DropDownList ddlNewParentesco = (DropDownList)grvBeneficiarioConyuge.FooterRow.FindControl("ddlNewParentesco");

            Asegurado p = new Asegurado();
            p.Nombres = txtNewNombre.Text;
            p.Apellidos = txtNewApellido.Text;
            p.NumeroDocumento = txtNewCedula.Text;
            p.Edad = int.Parse(txtNewEdad.Text);
            p.Porcentaje = int.Parse(txtNewPorcentaje.Text);
            p.Parentesco = ddlNewParentesco.SelectedItem.ToString();

            DataTable dtBeneficiarioConyuge = (DataTable)Session["dtBeneficiarioConyuge"];
            DataRow row = dtBeneficiarioConyuge.NewRow();
            row["NumeroDocumento"] = p.NumeroDocumento;
            row["Apellidos"] = p.Apellidos;
            row["Nombres"] = p.Nombres;
            row["Edad"] = p.Edad;
            row["Porcentaje"] = p.Porcentaje;
            row["Parentesco"] = p.Parentesco;
            dtBeneficiarioConyuge.Rows.Add(row);

            grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyuge;
            grvBeneficiarioConyuge.DataBind();

            if (dtBeneficiarioConyuge.Rows.Count == 0)
            {
                grvBeneficiarioConyuge.FooterRow.Visible = true;
            }
            Session["dtBeneficiarioConyuge"] = dtBeneficiarioConyuge;
            if ((string)Session["operacionCertificado"] == "modificar")
            {

                //grvBeneficiarioConyuge.Rows[0].Visible = false;
            }

        }
    }
    protected void grvBeneficiarioConyuge_RowDeleting(object sender, GridViewDeleteEventArgs e)
    {
        DataTable dtBeneficiarioConyuge = (DataTable)Session["dtBeneficiarioConyuge"];
        dtBeneficiarioConyuge.Rows.RemoveAt(e.RowIndex);
        grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyuge;
        grvBeneficiarioConyuge.DataBind();
        grvBeneficiarioConyuge.Attributes.Add("onclick", "localStorage.setItem('accIndex', 2);");
        if (dtBeneficiarioConyuge.Rows.Count == 0)
        {
            DataTable dtBeneficiarioConyugeVacio = dtBeneficiarioConyuge.Clone();
            DataRow drBeneficiarioConyugeVacio = dtBeneficiarioConyugeVacio.NewRow();
            dtBeneficiarioConyugeVacio.Rows.Add(drBeneficiarioConyugeVacio);
            grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyugeVacio;
            grvBeneficiarioConyuge.DataBind();
            grvBeneficiarioConyuge.Rows[0].Visible = false;
            grvBeneficiarioConyuge.Rows[0].Controls.Clear();
        }

        if ((string)Session["operacionCertificado"] == "modificar")
        {
            //  grvBeneficiarioConyuge.Rows[0].Visible = false;
        }
        Session["dtBeneficiarioConyuge"] = dtBeneficiarioConyuge;
    }

   

    protected void grvAmparoConyuge_RowDeleting(object sender, GridViewDeleteEventArgs e)
    {
        double totalExtraPrimaC3 = 0;
        double valorExtraPrimado = 0;
        double totalC = 0;
        double totalExtraPrimaC = 0;
        DataTable dtEliminarConyuge = (DataTable)Session["dtEliminarConyuge"];
        dtEliminarConyuge.Rows.RemoveAt(e.RowIndex);
        grvAmparoConyuge.DataSource = dtEliminarConyuge;
        grvAmparoConyuge.DataBind();

        double totales = 0;
        // recorre la columna de primas en amparos y los suma
        foreach (GridViewRow row in grvAmparoConyuge.Rows)
        {
            totales += Convert.ToDouble(row.Cells[4].Text);
        }
        //dtExtraprimaConyugeRestaurar
        //en esta session viene la tabla de extra primas
        DataTable dtExtraprimaConyugeRestaurar2 = new DataTable();
        dtExtraprimaConyugeRestaurar2 = (DataTable)Session["dtExtraPrimaConyugeGuardarFinal"];

        if (dtExtraprimaConyugeRestaurar2 != null)
        {
            // se elimina el amparo en extraprima automaticamente cuando ya se elimino en amparos
            dtExtraprimaConyugeRestaurar2.Rows.RemoveAt(e.RowIndex);
            grvExtraPrimaConyuge.DataSource = dtExtraprimaConyugeRestaurar2;
            grvExtraPrimaConyuge.DataBind();
        }

        //historial de ceritificados antetiones generales
        DataTable dtConsultarHistorialExtraPrimaConyuge = new DataTable();
        dtConsultarHistorialExtraPrimaConyuge = AdministrarCertificados.ConsultarHistorialExtraPrima(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 2);
        grvHistorialExtraPrimaConyuge.DataSource = dtConsultarHistorialExtraPrimaConyuge;
        grvHistorialExtraPrimaConyuge.DataBind();

        double consultarHistorialExtraPrimaConyuge = 0;
        double valorExtraPrimaConyuge = 0;

        //Condicional en el cual entra si el cliente ya tiene un historial damparos  para asignar valores
        if (dtConsultarHistorialExtraPrimaConyuge.Rows.Count > 0)
        {
            // Recorre el dt para consultar los valores de prima y extra prima
            foreach (DataRow dtConsultarHistorialExtraPrimaForeachConyuge in dtConsultarHistorialExtraPrimaConyuge.Rows)
            {
                consultarHistorialExtraPrimaConyuge += double.Parse(dtConsultarHistorialExtraPrimaForeachConyuge["Prima"].ToString());
                valorExtraPrimaConyuge += double.Parse(dtConsultarHistorialExtraPrimaForeachConyuge["Extra Prima"].ToString());
            }
        }

        if (dtExtraprimaConyugeRestaurar2 != null)
        {

            //recorre tabla de extra prima para la suma de primas
            foreach (DataRow dt in dtExtraprimaConyugeRestaurar2.Rows)
            {
                valorExtraPrimado += Convert.ToDouble(dt[3].ToString());
            }
            //recorre tabla de extra prima para la suma de primas 
            foreach (GridViewRow row in grvExtraPrimaConyuge.Rows)
            {
                totalExtraPrimaC += Convert.ToDouble(row.Cells[4].Text);
            }
            if (valorExtraPrimado != 0)
            {
                totalC = valorExtraPrimado;
            }

            // Asignar variables con valores a los campos de prima y extra prima
            totalExtraPrimaC3 = totalC;
            totalExtraPrimaC3 = consultarHistorialExtraPrimaConyuge + totalC;
            txtPrimaPrincipalExtraprimaConyuge.Text = totalExtraPrimaC3.ToString();

            int PrimaPrincipalExtraprimaConyuge = int.Parse(Math.Round(decimal.Parse(txtPrimaPrincipalExtraprimaConyuge.Text)).ToString());
            txtPrimaPrincipalExtraprimaConyuge.Text = PrimaPrincipalExtraprimaConyuge.ToString();
           
        }
        txtPrimaConyuge.Text = txtPrimaPrincipalExtraprimaConyuge.Text;
        Session["dtEliminarConyuge"] = dtEliminarConyuge;
        Session["dtExtraPrimaConyugeGuardarFinal"] = dtExtraprimaConyugeRestaurar2;
        Session["TotalExtraPrimaC"] = totalExtraPrimaC;
    }

    protected void grvAmparoPrincipal_RowDeleting(object sender, GridViewDeleteEventArgs e)
    {
        DataTable dtEncabezadoCertificado = (DataTable)Session["dtEncabezadoCertificado"];
        DataTable dtEliminarPrincipal = (DataTable)Session["dtEliminarPrincipal"];
        bool sePuedenHijosPMI = (bool)Session["sePuedenHijosPMI"];
        double valorExtraPrimado = 0;
        double totalP = 0;
        double totalP3 = 0;
        double totalExtraPrimaP = 0;
        // Para Plan Maestro Integral se debe verificar que el asegurado principal tenga todos los amparos para poder asegurar hijos
        if (int.Parse(dtEncabezadoCertificado.Rows[0]["com_Id"].ToString()) == 1 && dtEncabezadoCertificado.Rows[0]["pro_Nombre"].ToString() == "EDUCADORES")
        {
            if (sePuedenHijosPMI == true)
            {
                DataTable dtParentesco, dtParentescoEspejo = new DataTable();
                dtParentesco = AdministrarCertificados.consultarParentesco(int.Parse(AdministrarCertificados.certificadoPre.Producto));
                dtParentesco.Rows.RemoveAt(0);
                dtParentesco.Rows.RemoveAt(0);
                ddlParentesoOtro.DataTextField = "par_Nombre";
                ddlParentesoOtro.DataValueField = "par_Id";
                ddlParentesoOtro.DataSource = dtParentesco;
                ddlParentesoOtro.DataBind();
                ddlParentesoOtro.Items.Insert(0, new ListItem("", ""));
            }
            sePuedenHijosPMI = false;

        }
        //en esta session viene la tabla de extra primas
        DataTable dtExtraprimaPrincipalRestaurar2 = new DataTable();
        dtExtraprimaPrincipalRestaurar2 = (DataTable)Session["dtExtraPrimaPrincipalGuardarFinal"];

        if (dtExtraprimaPrincipalRestaurar2 != null)
        {
            // se elimina el amparo en extraprima automaticamente cuando ya se elimino en amparos
            dtExtraprimaPrincipalRestaurar2.Rows.RemoveAt(e.RowIndex);
            grvAmparoExtraPrima.DataSource = dtExtraprimaPrincipalRestaurar2;
            grvAmparoExtraPrima.DataBind();
        }
        //historial de ceritificados antetiones generales
        DataTable dtConsultarHistorialExtraPrima = new DataTable();
        dtConsultarHistorialExtraPrima = AdministrarCertificados.ConsultarHistorialExtraPrima(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 1);
        grvHistorialExtraPrima.DataSource = dtConsultarHistorialExtraPrima;
        grvHistorialExtraPrima.DataBind();

        if (int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()) == 0)
        {
            txtDocumentoConyugue.Enabled = false;
            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "RECUERDE QUE NO PODRA INGRESAR CONYUGE SI EL PRICIPAL NO POSEE TODOS LOS AMPAROS" + "');", true);
        }

        double consultarHistorialExtraPrima = 0;
        double valorExtraPrima = 0;

        //Condicional en el cual entra si el cliente ya tiene un historial damparos  para asignar valores
        if (dtConsultarHistorialExtraPrima.Rows.Count > 0)
        {
            // Recorre el dt para consultar los valores de prima y extra prima
            foreach (DataRow dtConsultarHistorialExtraPrimaForeach in dtConsultarHistorialExtraPrima.Rows)
            {
                consultarHistorialExtraPrima += double.Parse(dtConsultarHistorialExtraPrimaForeach["Prima"].ToString());
                valorExtraPrima += double.Parse(dtConsultarHistorialExtraPrimaForeach["Extra Prima"].ToString());
            }
        }

        if (dtExtraprimaPrincipalRestaurar2 != null)
        {
            //recorre tabla de extra prima para la suma de primas
            foreach (DataRow dt in dtExtraprimaPrincipalRestaurar2.Rows)
            {
                valorExtraPrimado += double.Parse(dt[3].ToString());
            }

            //recorre tabla de extra prima para la suma de primas 
            foreach (GridViewRow row in grvAmparoExtraPrima.Rows)
            {
                totalExtraPrimaP += Convert.ToDouble(row.Cells[4].Text);
            }

            if (valorExtraPrimado != 0)
            {
                totalP = valorExtraPrimado;
            }

            // Asignar variables con valores a los campos de prima y extra prima
            totalP3 = totalP;
            totalP3 = consultarHistorialExtraPrima + totalP3;
            txtPrimaPrincipalExtraprima.Text = totalP3.ToString();

            int PrimaPrincipalExtraprima = int.Parse(Math.Round(decimal.Parse(txtPrimaPrincipalExtraprima.Text)).ToString());
            txtPrimaPrincipalExtraprima.Text = PrimaPrincipalExtraprima.ToString();
        }
        txtPrimaPrincipal.Text = txtPrimaPrincipalExtraprima.Text;

        //sumar primas
        sumarPrima();

        //dtExtraprimaPrincipalRestaurar2.Rows.RemoveAt(e.RowIndex);
        //grvAmparoExtraPrima.DataSource = dtExtraprimaPrincipalRestaurar2;
        //grvAmparoExtraPrima.DataBind();

        dtEliminarPrincipal.Rows.RemoveAt(e.RowIndex);
        grvAmparoPrincipal.DataSource = dtEliminarPrincipal;
        grvAmparoPrincipal.DataBind();

        double totales = 0;
        foreach (GridViewRow row in grvAmparoPrincipal.Rows)
        {
            totales += Convert.ToDouble(row.Cells[4].Text);
        }

        Session["TotalExtraPrimaP"] = totalExtraPrimaP;
        Session["dtEliminarPrincipal"] = dtEliminarPrincipal;
        Session["dtExtraPrimaPrincipalGuardarFinal"] = dtExtraprimaPrincipalRestaurar2;
    }
    protected void limpiarConyuge_Click(object sender, EventArgs e)
    {

        int primaGeneral = 0;

        primaGeneral = int.Parse(txtPrima.Text) - int.Parse(txtPrimaConyuge.Text);
        txtPrima.Text = primaGeneral.ToString();

        txtCedulaConyuge.Text = "";
        txtNombreConyuge.Text = "";
        txtApellidoConyuge.Text = "";
        txtEdadConyuge.Text = "";
        txtPrimaConyuge.Text = "";
        txtDocumentoConyugue.Text = "";

        ddlPlanConyuge.Items.Insert(0, new ListItem("", ""));
        ddlPlanConyuge.SelectedIndex = ddlPlanConyuge.Items.IndexOf(ddlPlanConyuge.Items.FindByText(" "));
        ddlPlanConyuge.Enabled = false;

        DataTable dtEliminarConyuge = (DataTable)Session["dtEliminarConyuge"];
        amparosConyuge.Visible = false;
        dtEliminarConyuge.Clear();
        grvAmparoConyuge.DataSource = dtEliminarConyuge;
        grvAmparoConyuge.DataBind();
        Session["dtEliminarConyuge"] = dtEliminarConyuge;

        DataTable dtBeneficiarioConyuge = (DataTable)Session["dtBeneficiarioConyuge"];
        beneficiariosConyuge.Visible = false;
        dtBeneficiarioConyuge.Clear();
        grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyuge;
        grvBeneficiarioConyuge.DataBind();
        Session["dtBeneficiarioConyuge"] = dtBeneficiarioConyuge;

        txtPlanConyuge.Text = "";
        txtEstatura.Text = "";
        txtPeso.Text = "";
        txtPlanConyuge.Enabled = false;

        btnExtraPrima2.Visible = false;
        btnLimpiar.Visible = false;
        btnSiguienteConyuge.Enabled = true;

    }

    protected void btnAdicionarOtrosAsegurados_Click(object sender, EventArgs e)
    {
        DataTable otrosAsegurados = (DataTable)Session["otrosAsegurados"];
        DataTable dtTemp = (DataTable)Session["dtTemp"];
        string movimientoOtrosAsegurados = (string)Session["movimientoOtrosAsegurados"];

        movimientoOtrosAsegurados = "MODIFICA";

        grvOtrosAsegurados.Visible = true;
        btnAdicionarOtrosAsegurados.Enabled = false;


        ConsultarAmparosPlanOtros(sender, e);

        double totales = 0;
        foreach (GridViewRow row1 in grvAmparoOtro.Rows)
        {
            totales += Convert.ToDouble(row1.Cells[3].Text);
        }

        if (dtTemp.Rows.Count == 0)
            dtTemp = otrosAsegurados.Clone();

        DataRow row = otrosAsegurados.NewRow();
        DataRow rowTemp = dtTemp.NewRow();
        row["Cedula"] = txtDocumentoOtros.Text;
        row["Nombre"] = txtNombreOtro.Text;
        row["Apellidos"] = txtApellidoOtro.Text;
        row["Fecha Nacimiento"] = txtFechaNacimiento.Text;
        row["Parentesco"] = ddlParentesoOtro.SelectedItem.ToString();
        row["Plan"] = ddlPlanOtros.SelectedItem.ToString();
        row["Prima"] = totales.ToString();

        rowTemp["Cedula"] = txtDocumentoOtros.Text;
        rowTemp["Nombre"] = txtNombreOtro.Text;
        rowTemp["Apellidos"] = txtApellidoOtro.Text;
        rowTemp["Fecha Nacimiento"] = txtFechaNacimiento.Text;
        rowTemp["Parentesco"] = ddlParentesoOtro.SelectedValue.ToString();
        rowTemp["Plan"] = ddlPlanOtros.SelectedValue.ToString();
        rowTemp["Prima"] = totales.ToString();

        otrosAsegurados.Rows.Add(row);
        dtTemp.Rows.Add(rowTemp);
        grvOtrosAsegurados.DataSource = otrosAsegurados;
        grvOtrosAsegurados.DataBind();

        if (txtPrimaOtros.Text != "")
            totales += int.Parse(txtPrimaOtros.Text);
        txtPrimaOtros.Text = totales.ToString();

        sumarPrima();

        //Viviana
        //int sumaPrimasOtros = 0;
        //sumaPrimasOtros += int.Parse(txtPrimaOtros.Text);
        //Viviana


        txtDocumentoOtros.Text = "";
        txtCedulaOtro.Text = "";
        txtNombreOtro.Text = "";
        txtApellidoOtro.Text = "";
        txtEdadOtro.Text = "";
        txtFechaNacimiento.Text = "";
        grvAmparoOtro.Visible = false;
        btnAdicionarOtrosAsegurados.Enabled = false;

        Session["otrosAsegurados"] = otrosAsegurados;
        Session["dtTemp"] = dtTemp;
        Session["movimientoOtrosAsegurados"] = movimientoOtrosAsegurados;

        txtPrimaOtros.Enabled = true;
    }

    protected void grvOtrosAsegurados_RowDeleting(object sender, GridViewDeleteEventArgs e)
    {
        string movimientoOtrosAsegurados = (string)Session["movimientoOtrosAsegurados"];
        DataTable dtTemp = (DataTable)Session["dtTemp"];
        DataTable otrosAsegurados = (DataTable)Session["otrosAsegurados"];
        movimientoOtrosAsegurados = "MODIFICA";

        dtTemp.Rows.RemoveAt(e.RowIndex);
        otrosAsegurados.Rows.RemoveAt(e.RowIndex);
        grvOtrosAsegurados.DataSource = otrosAsegurados;
        grvOtrosAsegurados.DataBind();

        //double primaOtro = double.Parse(txtPrimaOtros.Text);
        //primaOtro -= double.Parse(e.Values[6].ToString());
        //txtPrimaOtros.Text = primaOtro.ToString();

        Session["otrosAsegurados"] = otrosAsegurados;
        Session["dtTemp"] = dtTemp;
        Session["movimientoOtrosAsegurados"] = movimientoOtrosAsegurados;
    }
    /*---------------------------------------------------------------*/
    protected void botonRegistrarTercero_Click(object sender, EventArgs e)
    {
        AdministrarTercero.InsertarTercero(txtIdentificacion.Text, ddlTipoDocumentoTercero.SelectedValue, txtNombre.Text, txtApellido.Text, DateTime.Parse(txtNacimiento.Text), txtCorreo.Text, ddlGeneroTercero.SelectedValue, ddlDepartamento.SelectedValue, ddlCiudad.SelectedValue, txtCelular.Text, txtTelefono1.Text, txtDireccion.Text, txtTelefono2.Text, ddlOcupacionTercero.SelectedValue, ddlEstadoCivilTercero.SelectedValue);
        limpiar();
    }

    //JC 
    protected void ddlDepartamento_SelectedIndexChanged(object sender, EventArgs e)
    {
        AdministrarTercero.ConsultarCiudad(ddlDepartamento.SelectedValue);

        DataTable dt = new DataTable();
        dt = AdministrarTercero.asegurado.sp_ConsultarCiudad();
        ddlCiudad.DataTextField = "ciu_Nombre"; // Cargamos lo que aparece en el ddl
        ddlCiudad.DataValueField = "ciu_Id"; // Cargamos lo que vale por debajo
        ddlCiudad.DataSource = dt;
        ddlCiudad.DataBind();
    }

    //Metodo limpiar. JC
    private void limpiar()
    {
        txtIdentificacion.Text = "";
        //ddlTipoDocumentoTercero.Text = "";
        txtNombre.Text = "";
        txtApellido.Text = "";
        txtNacimiento.Text = "";
        txtEdad.Text = "";
        txtCorreo.Text = "";
        ddlGeneroTercero.Text = "";
        //ddlDepartamento.Text = "";
        //ddlCiudad.Text = "";
        txtCelular.Text = "";
        txtTelefono1.Text = "";
        txtDireccion.Text = "";
        txtTelefono2.Text = "";
    }

    //Método que obtiene variable de sesión /Juan Camilo /27_07_2015
    protected void PasarCertificado_Click(object sender, EventArgs e)
    {
        if ((string)Session["operacionCertificado"] == "modificar")
        {
            Response.Redirect("ModificarCertificado.aspx");
        }
        else
        {
            Response.Redirect("DigitarCertificado.aspx");
        }
    }

    /*-----------------------------------------------------------------*/

    protected void botonRegistrarTerceroOtros_Click(object sender, EventArgs e)
    {
        AdministrarTercero.InsertarTercero(txtIdentificacionOtros.Text, ddlTipoDocumentoOtros.SelectedValue, txtNombreOtros.Text, txtApellidoOtros.Text, DateTime.Parse(txtNacimientoOtros.Text), txtCorreoOtros.Text, ddlGeneroTerceroOtros.SelectedValue, ddlDepartamentoOtros.SelectedValue, ddlCiudadOtros.SelectedValue, txtCelularOtros.Text, txtTelefono1Otros.Text, txtDireccionOtros.Text, txtTelefono2Otros.Text, ddlOcupacionOtros.SelectedValue, ddlEstadoCivilOtros.SelectedValue);
        limpiarOtros();
    }

    //JC 
    protected void ddlDepartamentoOtros_SelectedIndexChanged(object sender, EventArgs e)
    {
        AdministrarTercero.ConsultarCiudad(ddlDepartamentoOtros.SelectedValue);

        DataTable dt = new DataTable();
        dt = AdministrarTercero.asegurado.sp_ConsultarCiudad();
        ddlCiudadOtros.DataTextField = "ciu_Nombre"; // Cargamos lo que aparece en el ddl
        ddlCiudadOtros.DataValueField = "ciu_Id"; // Cargamos lo que vale por debajo
        ddlCiudadOtros.DataSource = dt;
        ddlCiudadOtros.DataBind();
    }

    //Metodo limpiar. JC
    private void limpiarOtros()
    {
        txtIdentificacionOtros.Text = "";
        //ddlTipoDocumentoTercero.Text = "";
        txtNombreOtros.Text = "";
        txtApellidoOtros.Text = "";
        txtNacimientoOtros.Text = "";
        txtEdadOtros.Text = "";
        txtCorreoOtros.Text = "";
        ddlGeneroTerceroOtros.Text = "";
        //ddlDepartamento.Text = "";
        //ddlCiudad.Text = "";
        txtCelularOtros.Text = "";
        txtTelefono1Otros.Text = "";
        txtDireccionOtros.Text = "";
        txtTelefono2Otros.Text = "";
    }

    protected void ConsultarAmparosPlanOtros(object sender, EventArgs e)
    {
        DataTable dt = new DataTable();
        if ((string)Session["operacionCertificado"] == "modificar")
        {
            int ocupacion = int.Parse(ddlOcupacionPrincipal.SelectedValue.ToString());
            dt = AdministrarCertificados.consultarAmparosPorPlan(int.Parse(ddlPlanOtros.SelectedValue.ToString()), int.Parse(txtEdadOtro.Text), 0, ocupacion);
            grvAmparoOtro.DataSource = dt;
            grvAmparoOtro.DataBind();
            if (dt.Rows.Count > 0)
            {
                btnAdicionarOtrosAsegurados.Enabled = true;
                grvAmparoOtro.Visible = true;
            }
            else
            {
                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "ESTE PLAN NO TIENE AMPAROS" + "');", true);
            }
        }
        else
        {
            if (ddlPlanOtros.Text != "" && txtCedulaOtro.Text != "")
            {
                grvAmparoOtro.Visible = true;
                int ocupacion = int.Parse(ddlOcupacionPrincipal.SelectedValue.ToString());
                dt = AdministrarCertificados.consultarAmparosPorPlan(int.Parse(ddlPlanOtros.SelectedValue.ToString()), int.Parse(txtEdadOtro.Text), 0, ocupacion);
                grvAmparoOtro.DataSource = dt;
                grvAmparoOtro.DataBind();
                if (dt.Rows.Count > 0)
                {
                    btnAdicionarOtrosAsegurados.Enabled = true;
                }
                else
                {
                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "ESTE PLAN NO TIENE AMPAROS" + "');", true);
                }
            }
        }

        grvAmparoOtro.DataSource = dt;
        grvAmparoOtro.DataBind();
    }

    protected void grvAmparoExtraPrima_RowEditing(object sender, GridViewEditEventArgs e)
    {

        DataTable dtExtraprimaPrincipal = (DataTable)Session["dtExtraprimaPrincipal"];

        if (int.Parse(Session["dtExtraprimaPrincipalRestaurar3"].ToString()) != 0)
        {
            //DataTable dtExtraprimaPrincipalRestaurar2 = new DataTable();
            dtExtraprimaPrincipal = (DataTable)Session["dtExtraprimaPrincipalRestaurar2"];
            grvAmparoExtraPrima.DataSource = dtExtraprimaPrincipal;
            grvAmparoExtraPrima.DataBind();
            //Session["dtExtraprimaPrincipalRestaurar2"] = dtExtraprimaPrincipalRestaurar2;

        }

        grvAmparoExtraPrima.EditIndex = e.NewEditIndex;
        grvAmparoExtraPrima.DataSource = dtExtraprimaPrincipal;
        grvAmparoExtraPrima.DataBind();

        Session["dtExtraprimaPrincipal"] = dtExtraprimaPrincipal;
        Session["dtExtraPrimaPrincipalGuardarFinal"] = dtExtraprimaPrincipal;
        //}


    }

    protected void grvAmparoExtraPrima_RowCancelingEdit(object sender, GridViewCancelEditEventArgs e)
    {

        DataTable dtExtraprimaPrincipal = (DataTable)Session["dtExtraprimaPrincipal"];

        if (int.Parse(Session["dtExtraprimaPrincipalRestaurar3"].ToString()) != 0)
        {
            Session["dtExtraprimaPrincipalRestaurar3"] = 0;
            //DataTable dtExtraprimaPrincipalRestaurar2 = new DataTable();
            dtExtraprimaPrincipal = (DataTable)Session["dtExtraprimaPrincipalRestaurar2"];
            grvAmparoExtraPrima.DataSource = dtExtraprimaPrincipal;
            grvAmparoExtraPrima.DataBind();
            //Session["dtExtraprimaPrincipalRestaurar2"] = dtExtraprimaPrincipalRestaurar2;
        }

        grvAmparoExtraPrima.EditIndex = -1;
        grvAmparoExtraPrima.DataSource = dtExtraprimaPrincipal;
        grvAmparoExtraPrima.DataBind();

        Session["dtExtraprimaPrincipal"] = dtExtraprimaPrincipal;
        Session["dtExtraPrimaPrincipalGuardarFinal"] = dtExtraprimaPrincipal;
    }



    protected void grvAmparoExtraPrima_RowUpdating(object sender, GridViewUpdateEventArgs e)
    {
        DataTable dtEliminarPrincipal = (DataTable)Session["dtEliminarPrincipal"];
        DataTable dtExtraprimaPrincipal = (DataTable)Session["dtExtraprimaPrincipal"];
        int rowExtraPrima = int.Parse(Session["rowExtraPrima"].ToString());
        Session["dtExtraprimaPrincipalRestaurar3"] = 0;
        double valorExtraPrimado = 0;
        double totalExtraPrimaP = 0;
        double totalP = 0;
        double totalP3 = 0;

        int cer_IdNuevo = 0;
        cer_IdNuevo = AdministrarCertificados.ConsultarIdCertificado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "", "");
        Session["cerId_ValorNuevo"] = cer_IdNuevo;

        int cer_IdAnterior = 0;
        DataTable dtCer_IdExtraPrima = AdministrarCertificados.ConsultarCertificadosAnteriores(int.Parse(Session["cerId_ValorNuevo"].ToString()));
        cer_IdAnterior = int.Parse(dtCer_IdExtraPrima.Rows[0]["cer_IdAnterior"].ToString());


        int count = 0;
        int valor = 0;
        int tasaAmparoPrincipal = 0;
        double valorAsegurado = 0;

        // foreach que recorre la tabla extra primas
        foreach (GridViewRow row in grvAmparoExtraPrima.Rows)
        {
            //pregunta si la columna de tasa es diferente de vacio
            if (row.Cells[3].Text == "")
            {
                //pregunta si el campo en el que sew ingresa el porcentaje ya es diferente de vacio
                if (int.Parse(((TextBox)row.Cells[3].Controls[0]).Text) != 0)
                {
                    //Valor es la variable que contiene el porcentaje ingresado
                    valor = int.Parse(((TextBox)row.Cells[5].Controls[0]).Text);
                    //Asigna a una variable el valor asegurado
                    valorAsegurado = double.Parse(((TextBox)row.Cells[2].Controls[0]).Text);
                    //contador
                    rowExtraPrima = count;
                }
            }
            count++;
        }
        // pregunta cual es la tabla del amparo
        tasaAmparoPrincipal = int.Parse(dtEliminarPrincipal.Rows[rowExtraPrima]["Tasa"].ToString());
        //asigna a una variable tasa una operacion
        double tasa = (tasaAmparoPrincipal * valor) / 100;
        //asigna a una variable tasa una operacion
        double valorAmparoExtraPrima = (tasa * valorAsegurado) / 1000000;
        //asiga un campo de el dt que carga la extra prima a una operacion 
        dtExtraprimaPrincipal.Rows[rowExtraPrima]["Prima"] = double.Parse(dtExtraprimaPrincipal.Rows[rowExtraPrima]["Prima"].ToString()) + valorAmparoExtraPrima;
        // variable con operacion para saber cuan es la tasa final
        double valortasaEsperada = (tasaAmparoPrincipal * valor) / 100;
        //asigna campo de el dt a una operacion
        dtExtraprimaPrincipal.Rows[rowExtraPrima]["Tasa"] = valortasaEsperada + tasaAmparoPrincipal;
        //plasma en la columna porcentaje el porcentaje ingresado por el usuario
        dtExtraprimaPrincipal.Rows[rowExtraPrima]["Porcentaje"] = valor;
        grvAmparoExtraPrima.EditIndex = -1;
        grvAmparoExtraPrima.DataSource = dtExtraprimaPrincipal;
        grvAmparoExtraPrima.DataBind();

        //Consulta el historial del cliente pero general
        DataTable dtConsultarHistorialExtraPrima = new DataTable();
        dtConsultarHistorialExtraPrima = AdministrarCertificados.ConsultarHistorialExtraPrima(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 1);
        grvHistorialExtraPrima.DataSource = dtConsultarHistorialExtraPrima;
        grvHistorialExtraPrima.DataBind();

        double consultarHistorialExtraPrima = 0;
        double valorExtraPrima = 0;

        //Condicional en el cual entra si el cliente ya tiene un historial damparos  para asignar valores
        if (dtConsultarHistorialExtraPrima.Rows.Count > 0)
        {
            // Recorre el dt para consultar los valores de prima y extra prima
            foreach (DataRow dtConsultarHistorialExtraPrimaForeach in dtConsultarHistorialExtraPrima.Rows)
            {
                consultarHistorialExtraPrima += double.Parse(dtConsultarHistorialExtraPrimaForeach["Prima"].ToString());
                valorExtraPrima += double.Parse(dtConsultarHistorialExtraPrimaForeach["Extra Prima"].ToString());
            }
        }

        //recorre tabla de extra prima para la suma de primas
        foreach (DataRow dt in dtExtraprimaPrincipal.Rows)
        {
            valorExtraPrimado += double.Parse(dt[3].ToString());
        }

        totalExtraPrimaP = double.Parse(Session["TotalExtraPrimaP"].ToString());
        if (valorExtraPrimado != 0)
        {
            totalP = valorExtraPrimado - totalExtraPrimaP;
        }
        // Asignar variables con valores a los campos de prima y extra prima
        totalP3 = totalP;
        totalP3 = valorExtraPrima + totalP3;
        txtPrincipalExtraprima.Text = totalP3.ToString();
        txtExtraPrimaPrincipal.Text = txtPrincipalExtraprima.Text;

        sumarPrima();
        Session["valorExtraPrimado"] = valorExtraPrimado;
        Session["rowExtraPrima"] = rowExtraPrima;
        Session["dtEliminarPrincipal"] = dtEliminarPrincipal;
        Session["dtExtraprimaPrincipal"] = dtExtraprimaPrincipal;
        Session["dtExtraPrimaPrincipalGuardarFinal"] = dtExtraprimaPrincipal;

    }

    protected void grvExtraPrimaConyuge_RowUpdating(object sender, GridViewUpdateEventArgs e)
    {

        DataTable dtEliminarConyuge = (DataTable)Session["dtEliminarConyuge"];
        DataTable dtExtraprimaConyuge = (DataTable)Session["dtExtraprimaConyuge"];
        Session["dtExtraprimaConyugeRestaurar3"] = 0;
        double valorExtraPrimadoC = 0;
        double totalExtraPrimaC = 0;
        double totalC = 0;
        double totalC3 = 0;

        int cer_IdNuevo = 0;
        cer_IdNuevo = AdministrarCertificados.ConsultarIdCertificado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "", "");
        Session["cerId_ValorNuevo"] = cer_IdNuevo;

        int cer_IdAnterior = 0;
        DataTable dtCer_IdExtraPrima = AdministrarCertificados.ConsultarCertificadosAnteriores(int.Parse(Session["cerId_ValorNuevo"].ToString()));
        cer_IdAnterior = int.Parse(dtCer_IdExtraPrima.Rows[0]["cer_IdAnterior"].ToString());

        int count = 0;
        int valor = 0;
        int tasaAmparoPrincipal = 0;
        double valorAsegurado = 0;
        int rowExtraPrima = 0;
        // foreach que recorre la tabla extra primas
        foreach (GridViewRow row in grvExtraPrimaConyuge.Rows)
        {
            //pregunta si la columna de tasa es diferente de vacio
            if (row.Cells[3].Text == "")
            {
                //pregunta si el campo en el que sew ingresa el porcentaje ya es diferente de vacio
                if (int.Parse(((TextBox)row.Cells[5].Controls[0]).Text) != 0)
                {
                    //Valor es la variable que contiene el porcentaje ingresado
                    valor = int.Parse(((TextBox)row.Cells[5].Controls[0]).Text);
                    //Asigna a una variable el valor asegurado
                    valorAsegurado = double.Parse(((TextBox)row.Cells[2].Controls[0]).Text);
                    //contador
                    rowExtraPrima = count;
                }
            }
            count++;
        }
        // pregunta cual es la tabla del amparo
        tasaAmparoPrincipal = int.Parse(dtEliminarConyuge.Rows[rowExtraPrima]["Tasa"].ToString());
        //asigna a una variable tasa una operacion
        double tasa = (tasaAmparoPrincipal * valor) / 100;
        //asigna a una variable tasa una operacion
        double valorAmparoExtraPrima = (tasa * valorAsegurado) / 1000000;
        //asiga un campo de el dt que carga la extra prima a una operacion 
        dtExtraprimaConyuge.Rows[rowExtraPrima]["Prima"] = double.Parse(dtExtraprimaConyuge.Rows[rowExtraPrima]["Prima"].ToString()) + valorAmparoExtraPrima;
        // variable con operacion para saber cuan es la tasa final
        double valortasaEsperada = (tasaAmparoPrincipal * valor) / 100;
        //asigna campo de el dt a una operacion
        dtExtraprimaConyuge.Rows[rowExtraPrima]["Tasa"] = valortasaEsperada + tasaAmparoPrincipal;
        //plasma en la columna porcentaje el porcentaje ingresado por el usuario
        dtExtraprimaConyuge.Rows[rowExtraPrima]["Porcentaje"] = valor;
        grvExtraPrimaConyuge.EditIndex = -1;
        grvExtraPrimaConyuge.DataSource = dtExtraprimaConyuge;
        grvExtraPrimaConyuge.DataBind();

        //Consulta el historial del cliente pero general
        DataTable dtConsultarHistorialExtraPrimaConyuge = new DataTable();
        dtConsultarHistorialExtraPrimaConyuge = AdministrarCertificados.ConsultarHistorialExtraPrima(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 2);
        grvHistorialExtraPrimaConyuge.DataSource = dtConsultarHistorialExtraPrimaConyuge;
        grvHistorialExtraPrimaConyuge.DataBind();

        double consultarHistorialExtraPrimaConyuge = 0;
        double valorExtraPrimaConyuge = 0;
        //Condicional en el cual entra si el cliente ya tiene un historial damparos  para asignar valores
        if (dtConsultarHistorialExtraPrimaConyuge.Rows.Count > 0)
        {
            // Recorre el dt para consultar los valores de prima y extra prima
            foreach (DataRow dtConsultarHistorialExtraPrimaForeachConyuge in dtConsultarHistorialExtraPrimaConyuge.Rows)
            {
                consultarHistorialExtraPrimaConyuge += double.Parse(dtConsultarHistorialExtraPrimaForeachConyuge["Prima"].ToString());
                valorExtraPrimaConyuge += double.Parse(dtConsultarHistorialExtraPrimaForeachConyuge["Extra Prima"].ToString());
            }
        }

        //recorre tabla de extra prima para la suma de primas
        foreach (DataRow dt in dtExtraprimaConyuge.Rows)
        {
            valorExtraPrimadoC += double.Parse(dt[3].ToString());
        }

        totalExtraPrimaC = double.Parse(Session["TotalExtraPrimaC"].ToString());
        if (valorExtraPrimadoC != 0)
        {
            totalC = valorExtraPrimadoC - totalExtraPrimaC;
        }
        // Asignar variables con valores a los campos de prima y extra prima
        totalC3 = totalC;
        totalC3 = valorExtraPrimaConyuge + totalC3;
        txtPrincipalExtraprimaConyuge.Text = totalC3.ToString();
        txtExtraPrimaConyuge.Text = txtPrincipalExtraprimaConyuge.Text;

        sumarPrima();

        Session["valorExtraPrimadoC"] = valorExtraPrimadoC;
        Session["dtEliminarConyuge"] = dtEliminarConyuge;
        Session["dtExtraprimaPrincipal"] = dtExtraprimaConyuge;
        Session["dtExtraPrimaConyugeGuardarFinal"] = dtExtraprimaConyuge;

    }
    protected void grvExtraPrimaConyuge_RowCancelingEdit(object sender, GridViewCancelEditEventArgs e)
    {
        DataTable dtExtraprimaConyuge = (DataTable)Session["dtExtraprimaConyuge"];

        if (int.Parse(Session["dtExtraprimaConyugeRestaurar3"].ToString()) != 0)
        {
            Session["dtExtraprimaConyugeRestaurar3"] = 0;

            dtExtraprimaConyuge = (DataTable)Session["dtExtraprimaConyugeRestaurar"];
            grvExtraPrimaConyuge.DataSource = dtExtraprimaConyuge;
            grvExtraPrimaConyuge.DataBind();

        }

        grvExtraPrimaConyuge.EditIndex = -1;
        grvExtraPrimaConyuge.DataSource = dtExtraprimaConyuge;
        grvExtraPrimaConyuge.DataBind();
        Session["dtExtraprimaConyuge"] = dtExtraprimaConyuge;
        Session["dtExtraPrimaConyugeGuardarFinal"] = dtExtraprimaConyuge;
    }

    protected void grvExtraPrimaConyuge_RowEditing(object sender, GridViewEditEventArgs e)
    {
        DataTable dtExtraprimaConyuge = (DataTable)Session["dtExtraprimaConyuge"];


        if (int.Parse(Session["dtExtraprimaConyugeRestaurar3"].ToString()) != 0)
        {
            dtExtraprimaConyuge = (DataTable)Session["dtExtraprimaConyugeRestaurar"];
            grvExtraPrimaConyuge.DataSource = dtExtraprimaConyuge;
            grvExtraPrimaConyuge.DataBind();
        }

        grvExtraPrimaConyuge.EditIndex = e.NewEditIndex;
        grvExtraPrimaConyuge.DataSource = dtExtraprimaConyuge;
        grvExtraPrimaConyuge.DataBind();
        Session["dtExtraprimaConyuge"] = dtExtraprimaConyuge;
        Session["dtExtraPrimaConyugeGuardarFinal"] = dtExtraprimaConyuge;
    }

    protected void txtPlanPrincipal_TextChanged(object sender, EventArgs e)
    {
        DataTable dtExtraprimaPrincipalRestaurar = new DataTable();
        DataTable dtEliminarPrincipal = (DataTable)Session["dtEliminarPrincipal"];
        DataTable dtEncabezadoCertificado = (DataTable)Session["dtEncabezadoCertificado"];
        DataTable dtExtraprimaPrincipal = (DataTable)Session["dtExtraprimaPrincipal"];
        double totalExtraPrimaP = 0;
        double diferenciaValorAsegurado = 0;
        double totalExtraPrimaP3 = 0;
        txtDocumentoConyugue.Enabled = true;
        int cer_IdNuevo = 0;
        cer_IdNuevo = AdministrarCertificados.ConsultarIdCertificado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "", "");
        Session["cerId_ValorNuevo"] = cer_IdNuevo;

        int cer_IdAnterior = 0;
        DataTable dtCer_IdExtraPrima = AdministrarCertificados.ConsultarCertificadosAnteriores(int.Parse(Session["cerId_ValorNuevo"].ToString()));
        cer_IdAnterior = int.Parse(dtCer_IdExtraPrima.Rows[0]["cer_IdAnterior"].ToString());

        if (txtPlanPrincipal.Text != "")
        {
            DataTable dtCumuloValor = new DataTable();
            double valorAsegurado = 0;
            dtCumuloValor = AdministrarCertificados.spConsultarCumulo(int.Parse(dtEncabezadoCertificado.Rows[0]["com_Id"].ToString()));
            valorAsegurado = AdministrarCertificados.spConsultarValoresAsegurado(int.Parse(dtEncabezadoCertificado.Rows[0]["com_Id"].ToString()), int.Parse(txtCedulaPrincipal.Text));
            DataTable dtValorVigente = new DataTable();
            dtValorVigente = AdministrarCertificados.ConsultarEstadoNegocioPorCerId(cer_IdAnterior);
            if (dtValorVigente.Rows[0]["cer_EstadoNegocio"].ToString() == "VIGENTE")
            {
                valorAsegurado = valorAsegurado - double.Parse(Session["valorAseguradoPrincipalResta"].ToString());
            }
            if ((valorAsegurado + double.Parse(txtPlanPrincipal.Text)) <= double.Parse(dtCumuloValor.Rows[0]["cum_Nombre"].ToString()))
            {

                if (txtPlanPrincipal.Text != "")
                {
                    if ((string)Session["operacionCertificado"] == "modificar")
                    {
                        DataTable dtCertificadoFull = (DataTable)Session["dtCertificadoFull"];
                        DataTable permaneciaAsegurado = new DataTable();
                        int permaneciaAseguradoCertificado = 0;

                        permaneciaAsegurado = AdministrarCertificados.ConsultarFechaExpedicionCertificadoAnterior(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()));
                        permaneciaAseguradoCertificado = Funciones.FechaIngresoAsegurado(DateTime.Parse(permaneciaAsegurado.Rows[0]["cer_FechaExpedicion"].ToString()), DateTime.Parse(dtCertificadoFull.Rows[0]["ter_FechaNacimiento"].ToString()));

                        dtEliminarPrincipal = AdministrarCertificados.consultarAmparosPorPlanPermanencia(int.Parse(Session["plapol_Id"].ToString()), permaneciaAseguradoCertificado, int.Parse(txtPlanPrincipal.Text), int.Parse(Session["cer_id"].ToString()), 1);
                        //Cargar un dt con la informacion que posteriormente iria a la tabla extra prima
                        dtExtraprimaPrincipal = AdministrarCertificados.consultarAmparosPorPlanPermanencia(int.Parse(Session["plapol_Id"].ToString()), permaneciaAseguradoCertificado, int.Parse(txtPlanPrincipal.Text), int.Parse(Session["cer_id"].ToString()), 1);


                        DataTable dtConsultarValorAseguradoExtraPrima = new DataTable();
                        dtConsultarValorAseguradoExtraPrima = AdministrarCertificados.ConsultarValorAseguradoExtraPrima(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 1);

                        double valorAseguradoExtraPrima = 0;
                        double valorAseguradoDt = 0;
                        double TasaDt = 0;
                        double primaDt = 0;

                        //Recorrer el dt con el que se lleno la tabla extra prima
                        foreach (DataRow dt in dtExtraprimaPrincipal.Rows)
                        {
                            //recorrer el dt con los valores del certificado anterior 
                            foreach (DataRow dt2 in dtConsultarValorAseguradoExtraPrima.Rows)
                            {
                                if (dt["Amparo"].ToString() == dt2["ampcer_Nombre"].ToString())
                                {
                                    //asigna el valor asegurado del primer dt a esta variable 
                                    valorAseguradoDt = double.Parse(dt["Valor Asegurado"].ToString());
                                    //asignala tasa del primer dt a esta variable
                                    TasaDt = double.Parse(dt["Tasa"].ToString());
                                    //Asigna esta varible al valor asegurado del segundo dt
                                    valorAseguradoExtraPrima = double.Parse(dt2["ampcer_ValAsegurado"].ToString());
                                    //Resta el valor de la primera variable contra valorAseguradoExtraPrima y se la asigna a una variable
                                    diferenciaValorAsegurado = valorAseguradoDt - valorAseguradoExtraPrima;
                                    //Condicional en el que entra cuando el primer dt este pasando por la final de vida
                                    if (dt["Amparo"].ToString() == "VIDA")
                                    {
                                        Session["diferenciaValorAseguradoP"] = diferenciaValorAsegurado;
                                    }
                                    // asigna una variable a un campo del primer dt
                                    dt["Valor Asegurado"] = diferenciaValorAsegurado;
                                    primaDt = (TasaDt * diferenciaValorAsegurado) / 1000000;
                                    //asigna la vartiable de prima a un campo del dt
                                    dt["Prima"] = primaDt;
                                }

                            }

                            //Crea un dt nuevo el cual sera un clon de la tabla extra prima fila por fila 

                            dtExtraprimaPrincipalRestaurar = dtExtraprimaPrincipal.Clone();
                            foreach (DataRow row in dtExtraprimaPrincipal.Rows)
                            {
                                DataRow row2 = dtExtraprimaPrincipalRestaurar.NewRow();
                                row2.ItemArray = row.ItemArray;
                                dtExtraprimaPrincipalRestaurar.Rows.Add(row2);
                            }
                            // asigna este dt a la session 
                            Session["dtExtraprimaPrincipalRestaurar"] = dtExtraprimaPrincipalRestaurar;
                        }
                    }
                    else
                    {
                        int ocupacion = int.Parse(ddlOcupacionPrincipal.SelectedValue.ToString());
                        //#################################
                        dtEliminarPrincipal = AdministrarCertificados.consultarAmparosPorPlan(int.Parse(Session["plapol_Id"].ToString()), int.Parse(txtEdadPrincipal.Text), int.Parse(txtPlanPrincipal.Text), ocupacion);
                        dtExtraprimaPrincipal = AdministrarCertificados.consultarAmparosPorPlan(int.Parse(Session["plapol_Id"].ToString()), int.Parse(txtEdadPrincipal.Text), int.Parse(txtPlanPrincipal.Text));
                        dtExtraprimaPrincipalRestaurar = dtExtraprimaPrincipal.Clone();
                        foreach (DataRow row in dtExtraprimaPrincipal.Rows)
                        {
                            DataRow row2 = dtExtraprimaPrincipalRestaurar.NewRow();
                            row2.ItemArray = row.ItemArray;
                            dtExtraprimaPrincipalRestaurar.Rows.Add(row2);
                        }
                        // asigna este dt a la session 
                        Session["dtExtraprimaPrincipalRestaurar"] = dtExtraprimaPrincipalRestaurar;
                        //la prima que llega de dtEliminarPrincipal se resta con la nueva prima
                    }
                    grvAmparoPrincipal.DataSource = dtEliminarPrincipal;
                    grvAmparoPrincipal.DataBind();




                    double totales = 0;
                    foreach (GridViewRow row in grvAmparoPrincipal.Rows)
                    {
                        totales += Convert.ToDouble(row.Cells[4].Text);
                    }


                    grvAmparoPrincipal.DataSource = dtEliminarPrincipal;
                    grvAmparoPrincipal.DataBind();

                    // Cargar tabla de amparos para ingresar la extraprima
                    grvAmparoExtraPrima.DataSource = dtExtraprimaPrincipal;
                    grvAmparoExtraPrima.DataBind();

                    // crea dt el cual contiene la informacion del historial del cliente en todos los amparos y se lo asigna a la tabla de historial
                    DataSet dsConsultarHistirialPorcentajeExtraPrimado = new DataSet();
                    dsConsultarHistirialPorcentajeExtraPrimado = AdministrarCertificados.ConsultarHistirialPorcentajeExtraPrimado(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 1);

                    DataTable dtConsultarHistirialPorcentajeExtraPrimado = new DataTable();
                    foreach (DataTable dt in dsConsultarHistirialPorcentajeExtraPrimado.Tables)
                    {
                        dtConsultarHistirialPorcentajeExtraPrimado.Merge(dt);
                    }
                    grvConsultarHistirialPorcentajeExtraPrimado.DataSource = dtConsultarHistirialPorcentajeExtraPrimado;
                    grvConsultarHistirialPorcentajeExtraPrimado.DataBind();

                    //Consulta el historial del cliente pero general
                    DataTable dtConsultarHistorialExtraPrima = new DataTable();
                    dtConsultarHistorialExtraPrima = AdministrarCertificados.ConsultarHistorialExtraPrima(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 1);
                    grvHistorialExtraPrima.DataSource = dtConsultarHistorialExtraPrima;
                    grvHistorialExtraPrima.DataBind();


                    double consultarHistorialExtraPrima = 0;
                    double valorExtraPrima = 0;

                    //Condicional en el cual entra si el cliente ya tiene un historial damparos  para asignar valores
                    if (dtConsultarHistorialExtraPrima.Rows.Count > 0)
                    {
                        // Recorre el dt para consultar los valores de prima y extra prima
                        foreach (DataRow dtConsultarHistorialExtraPrimaForeach in dtConsultarHistorialExtraPrima.Rows)
                        {
                            consultarHistorialExtraPrima += double.Parse(dtConsultarHistorialExtraPrimaForeach["Prima"].ToString());
                            valorExtraPrima += double.Parse(dtConsultarHistorialExtraPrimaForeach["Extra Prima"].ToString());
                        }
                    }

                    //recorre tabla de extra prima para la suma de primas 
                    foreach (GridViewRow row in grvAmparoExtraPrima.Rows)
                    {
                        totalExtraPrimaP += Convert.ToDouble(row.Cells[4].Text);
                    }

                    // Asignar variables con valores a los campos de prima y extra prima
                    totalExtraPrimaP3 = totalExtraPrimaP;
                    totalExtraPrimaP3 = consultarHistorialExtraPrima + totalExtraPrimaP3;
                    txtPrimaPrincipalExtraprima.Text = totalExtraPrimaP3.ToString();
                    txtPrimaPrincipal.Text = totalExtraPrimaP3.ToString();
                    txtExtraPrimaPrincipal.Text = txtPrincipalExtraprima.Text;

                    int primaPrincipal = int.Parse(Math.Round(decimal.Parse(txtPrimaPrincipal.Text)).ToString());
                    txtPrimaPrincipal.Text = primaPrincipal.ToString();
                    int PrimaPrincipalExtraprima = int.Parse(Math.Round(decimal.Parse(txtPrimaPrincipalExtraprima.Text)).ToString());
                    txtPrimaPrincipalExtraprima.Text = PrimaPrincipalExtraprima.ToString();
                    int ExtraPrimaPrincipal = int.Parse(Math.Round(decimal.Parse(txtExtraPrimaPrincipal.Text)).ToString());
                    txtExtraPrimaPrincipal.Text = ExtraPrimaPrincipal.ToString();

                }
                else
                {
                    dtEliminarPrincipal.Clear();
                    grvAmparoPrincipal.DataSource = dtEliminarPrincipal;
                    grvAmparoPrincipal.DataBind();
                }
            }
            else
            {
                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL VALOR DEL PLAN SUPERA EL ACEPTADO POR LA COMPAÑÍA PARA SUS LOS PRODUCTOS" + "');", true);
            }
        }
        else
        {
            dtEliminarPrincipal.Clear();
            grvAmparoPrincipal.DataSource = dtEliminarPrincipal;
            grvAmparoPrincipal.DataBind();
        }
        sumarPrima();
        Session["dtExtraprimaPrincipal"] = dtExtraprimaPrincipal;
        Session["dtEliminarPrincipal"] = dtEliminarPrincipal;
        Session["TotalExtraPrimaP"] = totalExtraPrimaP;
        Session["dtExtraPrimaPrincipalGuardarFinal"] = dtExtraprimaPrincipal;
        //txtPrimaPrincipal.Enabled = true;
    }
    protected void txtPlanConyuge_TextChanged(object sender, EventArgs e)
    {
        DataTable dtEncabezadoCertificado = (DataTable)Session["dtEncabezadoCertificado"];
        DataTable dtExtraprimaConyuge = (DataTable)Session["dtExtraprimaConyuge"];
        DataTable dtEliminarConyuge = (DataTable)Session["dtEliminarConyuge"];
        DataTable dtExtraprimaConyugeRestaurar = new DataTable();
        double totalExtraPrimaC = 0;
        double diferenciaValorAsegurado = 0;
        double totalExtraPrimaC3 = 0;

        int cer_IdNuevo = 0;
        cer_IdNuevo = AdministrarCertificados.ConsultarIdCertificado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "", "");
        Session["cerId_ValorNuevo"] = cer_IdNuevo;

        int cer_IdAnterior = 0;
        DataTable dtCer_IdExtraPrima = AdministrarCertificados.ConsultarCertificadosAnteriores(int.Parse(Session["cerId_ValorNuevo"].ToString()));
        cer_IdAnterior = int.Parse(dtCer_IdExtraPrima.Rows[0]["cer_IdAnterior"].ToString());

        if (txtPlanConyuge.Text != "")
        {
            DataTable dtCumuloValor = new DataTable();
            double valorAsegurado = 0;
            dtCumuloValor = AdministrarCertificados.spConsultarCumulo(int.Parse(dtEncabezadoCertificado.Rows[0]["com_Id"].ToString()));
            valorAsegurado = AdministrarCertificados.spConsultarValoresAsegurado(int.Parse(dtEncabezadoCertificado.Rows[0]["com_Id"].ToString()), int.Parse(txtCedulaConyuge.Text));
           
            if ((valorAsegurado + double.Parse(txtPlanConyuge.Text)) <= double.Parse(dtCumuloValor.Rows[0]["cum_Nombre"].ToString()))
            {
                DataTable dtValorVigente = new DataTable();
                dtValorVigente = AdministrarCertificados.ConsultarEstadoNegocioPorCerId(cer_IdAnterior);
                if (dtValorVigente.Rows[0]["cer_EstadoNegocio"].ToString() == "VIGENTE")
                {
                    valorAsegurado = valorAsegurado - double.Parse(Session["valorAseguradoPrincipalRestaConyuge"].ToString());
                }
                if ((string)Session["operacionCertificado"] == "modificar")
                {
                    dtEliminarConyuge = AdministrarCertificados.consultarAmparosPorPlanPermanencia(int.Parse(Session["plapol_IdConyuge"].ToString()), int.Parse(txtEdadConyuge.Text), int.Parse(txtPlanConyuge.Text), int.Parse(Session["cer_id"].ToString()), 2);

                    //Cargar un dt con la informacion que posteriormente iria a la tabla extra prima
                    dtExtraprimaConyuge = AdministrarCertificados.consultarAmparosPorPlanPermanencia(int.Parse(Session["plapol_IdConyuge"].ToString()), int.Parse(txtEdadConyuge.Text), int.Parse(txtPlanConyuge.Text), int.Parse(Session["cer_id"].ToString()), 2);


                    DataTable dtConsultarValorAseguradoExtraPrima = new DataTable();
                    dtConsultarValorAseguradoExtraPrima = AdministrarCertificados.ConsultarValorAseguradoExtraPrima(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 2);

                    double valorAseguradoExtraPrima = 0;
                    double valorAseguradoDt = 0;
                    double TasaDt = 0;
                    double primaDt = 0;

                    //Recorrer el dt con el que se lleno la tabla extra prima
                    foreach (DataRow dt in dtExtraprimaConyuge.Rows)
                    {
                        //recorrer el dt con los valores del certificado anterior 
                        foreach (DataRow dt2 in dtConsultarValorAseguradoExtraPrima.Rows)
                        {
                            //condicional que pregunta cuando los nombres de los dos dt coinciden en el nombre
                            if (dt["Amparo"].ToString() == dt2["ampcer_Nombre"].ToString())
                            {
                                //asigna el valor asegurado del primer dt a esta variable 
                                valorAseguradoDt = double.Parse(dt["Valor Asegurado"].ToString());
                                //asignala tasa del primer dt a esta variable
                                TasaDt = double.Parse(dt["Tasa"].ToString());
                                //Asigna esta varible al valor asegurado del segundo dt
                                valorAseguradoExtraPrima = double.Parse(dt2["ampcer_ValAsegurado"].ToString());
                                //Resta el valor de la primera variable contra valorAseguradoExtraPrima y se la asigna a una variable
                                diferenciaValorAsegurado = valorAseguradoDt - valorAseguradoExtraPrima;
                                //Condicional en el que entra cuando el primer dt este pasando por la final de vida
                                if (dt["Amparo"].ToString() == "VIDA")
                                {
                                    // asigna un valor a una session
                                    Session["diferenciaValorAseguradoC"] = diferenciaValorAsegurado;
                                }
                                // asigna una variable a un campo del primer dt
                                dt["Valor Asegurado"] = diferenciaValorAsegurado;
                                //realiza una operacion para saber el valor de la prima
                                primaDt = (TasaDt * diferenciaValorAsegurado) / 1000000;
                                //asigna la vartiable de prima a un campo del dt
                                dt["Prima"] = primaDt;

                            }
                        }

                        //Crea un dt nuevo el cual sera un clon de la tabla extra prima fila por fila 
                        dtExtraprimaConyugeRestaurar = dtExtraprimaConyuge.Clone();
                        foreach (DataRow row in dtExtraprimaConyuge.Rows)
                        {
                            DataRow row2 = dtExtraprimaConyugeRestaurar.NewRow();
                            row2.ItemArray = row.ItemArray;
                            dtExtraprimaConyugeRestaurar.Rows.Add(row2);
                        }

                        // asigna este dt a la session 
                        Session["dtExtraprimaConyugeRestaurar"] = dtExtraprimaConyugeRestaurar;
                    }

                }
                else
                {
                    dtEliminarConyuge = AdministrarCertificados.consultarAmparosPorPlan(int.Parse(Session["plapol_IdConyuge"].ToString()), int.Parse(txtEdadConyuge.Text), int.Parse(txtPlanConyuge.Text));
                    dtExtraprimaConyuge = AdministrarCertificados.consultarAmparosPorPlan(int.Parse(Session["plapol_IdConyuge"].ToString()), int.Parse(txtEdadConyuge.Text), int.Parse(txtPlanConyuge.Text));
                    dtExtraprimaConyugeRestaurar = dtExtraprimaConyuge.Clone();
                    foreach (DataRow row in dtExtraprimaConyuge.Rows)
                    {
                        DataRow row2 = dtExtraprimaConyugeRestaurar.NewRow();
                        row2.ItemArray = row.ItemArray;
                        dtExtraprimaConyugeRestaurar.Rows.Add(row2);
                    }

                    // asigna este dt a la session 
                    Session["dtExtraprimaConyugeRestaurar"] = dtExtraprimaConyugeRestaurar;
                }

                grvAmparoConyuge.DataSource = dtEliminarConyuge;
                grvAmparoConyuge.DataBind();

                foreach (GridViewRow row in grvAmparoConyuge.Rows)
                {
                }
                double totales = 0;
                foreach (GridViewRow row in grvAmparoConyuge.Rows)
                {
                    totales += Convert.ToDouble(row.Cells[4].Text);
                }

                grvAmparoConyuge.DataSource = dtEliminarConyuge;
                grvAmparoConyuge.DataBind();
                // llena la tabla Extra Prima
                grvExtraPrimaConyuge.DataSource = dtExtraprimaConyuge;
                grvExtraPrimaConyuge.DataBind();


                // crea dt el cual contiene la informacion del historial del cliente en todos los amparos y se lo asigna a la tabla de historial

                DataSet dsConsultarHistirialPorcentajeExtraPrimadoConyuge = new DataSet();
                dsConsultarHistirialPorcentajeExtraPrimadoConyuge = AdministrarCertificados.ConsultarHistirialPorcentajeExtraPrimado(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 2);

                DataTable dtConsultarHistirialPorcentajeExtraPrimadoConyuge = new DataTable();
                foreach (DataTable dt in dsConsultarHistirialPorcentajeExtraPrimadoConyuge.Tables)
                {
                    dtConsultarHistirialPorcentajeExtraPrimadoConyuge.Merge(dt);
                }
                grvConsultarHistirialPorcentajeExtraPrimadoConyuge.DataSource = dtConsultarHistirialPorcentajeExtraPrimadoConyuge;
                grvConsultarHistirialPorcentajeExtraPrimadoConyuge.DataBind();


                //Consulta el historial del cliente pero general
                DataTable dtConsultarHistorialExtraPrimaConyuge = new DataTable();
                dtConsultarHistorialExtraPrimaConyuge = AdministrarCertificados.ConsultarHistorialExtraPrima(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 2);
                grvHistorialExtraPrimaConyuge.DataSource = dtConsultarHistorialExtraPrimaConyuge;
                grvHistorialExtraPrimaConyuge.DataBind();

                double consultarHistorialExtraPrimaConyuge = 0;
                double valorExtraPrimaConyuge = 0;

                //Condicional en el cual entra si el cliente ya tiene un historial damparos  para asignar valores
                if (dtConsultarHistorialExtraPrimaConyuge.Rows.Count > 0)
                {
                    // Recorre el dt para consultar los valores de prima y extra prima
                    foreach (DataRow dtConsultarHistorialExtraPrimaForeachConyuge in dtConsultarHistorialExtraPrimaConyuge.Rows)
                    {
                        consultarHistorialExtraPrimaConyuge += double.Parse(dtConsultarHistorialExtraPrimaForeachConyuge["Prima"].ToString());
                        valorExtraPrimaConyuge += double.Parse(dtConsultarHistorialExtraPrimaForeachConyuge["Extra Prima"].ToString());
                    }
                }

                //recorre tabla de extra prima para la suma de primas 
                foreach (GridViewRow row in grvExtraPrimaConyuge.Rows)
                {
                    totalExtraPrimaC += Convert.ToDouble(row.Cells[4].Text);
                }

                // Asignar variables con valores a los campos de prima y extra prima 
                totalExtraPrimaC3 = totalExtraPrimaC;
                totalExtraPrimaC3 = consultarHistorialExtraPrimaConyuge + totalExtraPrimaC3;
                txtPrimaPrincipalExtraprimaConyuge.Text = totalExtraPrimaC3.ToString();
                txtPrimaConyuge.Text = totalExtraPrimaC3.ToString();
                txtExtraPrimaConyuge.Text = txtPrincipalExtraprimaConyuge.Text;

                int PrimaConyuge = int.Parse(Math.Round(decimal.Parse(txtPrimaConyuge.Text)).ToString());
                txtPrimaConyuge.Text = PrimaConyuge.ToString();
                int PrimaPrincipalExtraprimaConyuge = int.Parse(Math.Round(decimal.Parse(txtPrimaPrincipalExtraprimaConyuge.Text)).ToString());
                txtPrimaPrincipalExtraprimaConyuge.Text = PrimaPrincipalExtraprimaConyuge.ToString();
                int ExtraPrimaConyuge = int.Parse(Math.Round(decimal.Parse(txtExtraPrimaConyuge.Text)).ToString());
                txtExtraPrimaConyuge.Text = ExtraPrimaConyuge.ToString();

            }
            else
            {
                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL VALOR DEL PLAN SUPERA EL ACEPTADO POR LA COMPAÑÍA PARA SUS LOS PRODUCTOS" + "');", true);
            }
        }
        else
        {
            dtEliminarConyuge.Clear();
            grvAmparoConyuge.DataSource = dtEliminarConyuge;
            grvAmparoConyuge.DataBind();
        }
        sumarPrima();
        Session["dtEliminarConyuge"] = dtEliminarConyuge;
        Session["dtExtraprimaConyuge"] = dtExtraprimaConyuge;
        Session["TotalExtraPrimaC"] = totalExtraPrimaC;
        Session["dtExtraPrimaConyugeGuardarFinal"] = dtExtraprimaConyuge;

        //Viviana
        //txtPrimaConyuge.Enabled = true;
    }

    protected void btnSiguienteCertificado_Click(object sender, EventArgs e)
    {

    }
    protected void btnAtrasPrincipal_Click(object sender, EventArgs e)
    {
        btnSiguienteCertificado.Enabled = false;
        ddlLocalidadCertificado.Enabled = true;
        ddlPoliza.Enabled = true;
        txtDeclaracionEG.Enabled = true;
        txtDeclaracionAsegurado.Enabled = true;
        ddlperiodoPagoCertificado.Enabled = true;
    }
    protected void btnSiguientePrincipal_Click(object sender, EventArgs e)
    {
        btnExtraPrima2.Visible = false;
        btnLimpiar.Visible = false;
        btnValidarConyuge.Visible = false;

        if (txtCedulaConyuge.Text != "")
        {
            btnExtraPrima2.Visible = true;
            btnLimpiar.Visible = true;
            btnValidarConyuge.Visible = true;

            btnLimpiar.Visible = true;
        }

    }
    protected void btnAtrasConyuge_Click(object sender, EventArgs e)
    {
        DataTable otrosAsegurados = (DataTable)Session["otrosAsegurados"];

        txtCedulaConyuge.Text = "";
        txtNombreConyuge.Text = "";
        txtApellidoConyuge.Text = "";
        txtEdadConyuge.Text = "";
        txtPrimaConyuge.Text = "";
        txtExtraPrimaConyuge.Text = "";


        ddlPlanConyuge.Items.Insert(0, new ListItem("", ""));
        ddlPlanConyuge.SelectedIndex = ddlPlanConyuge.Items.IndexOf(ddlPlanConyuge.Items.FindByText(" "));
        ddlPlanConyuge.Enabled = false;

        DataTable dtEliminarConyuge = (DataTable)Session["dtEliminarConyuge"];
        amparosConyuge.Visible = false;
        dtEliminarConyuge.Clear();
        grvAmparoConyuge.DataSource = dtEliminarConyuge;
        grvAmparoConyuge.DataBind();
        Session["dtEliminarConyuge"] = dtEliminarConyuge;

        DataTable dtBeneficiarioConyuge = (DataTable)Session["dtBeneficiarioConyuge"];
        beneficiariosConyuge.Visible = false;
        dtBeneficiarioConyuge.Clear();
        grvBeneficiarioConyuge.DataSource = dtBeneficiarioConyuge;
        grvBeneficiarioConyuge.DataBind();
        Session["dtBeneficiarioConyuge"] = dtBeneficiarioConyuge;

        otrosAsegurados.Clear();
        DataTable dtTemp = (DataTable)Session["dtTemp"];
        dtTemp.Clear();
        Session["dtTemp"] = dtTemp;

        grvOtrosAsegurados.DataSource = otrosAsegurados;
        grvOtrosAsegurados.DataBind();

        btnSiguientePrincipal.Enabled = false;
        ddlPlanConyuge.Enabled = true;

        if (AdministrarCertificados.certificadoPre.Producto == "1")
        {
            ddlConvenioPrincipal.Enabled = true;
            txtPlanPrincipal.Enabled = true;
        }

        if (AdministrarCertificados.certificadoPre.Producto == "99" ||
            AdministrarCertificados.certificadoPre.Producto == "98" || AdministrarCertificados.certificadoPre.Producto == "2")
        {
            ddlConvenioPrincipal.Enabled = true;
            ddlPlanPrincipal.Enabled = true;
        }
        if (AdministrarCertificados.certificadoPre.Producto == "3" || AdministrarCertificados.certificadoPre.Producto == "4"
                || AdministrarCertificados.certificadoPre.Producto == "9" || AdministrarCertificados.certificadoPre.Producto == "21")
        {
            ddlConvenioPrincipal.Enabled = true;
            ddlPlanPrincipal.Enabled = true;
            txtpesoPrincipal.Enabled = true;
            txtestaturaPrincipal.Enabled = true;
        }

        txtPrimaOtros.Text = "";
        sumarPrima();

        Session["otrosAsegurados"] = otrosAsegurados;
    }
    protected void btnSiguienteConyuge_Click(object sender, EventArgs e)
    {

    }
    protected void btnAtrasOtroAsegurado_Click(object sender, EventArgs e)
    {
        if (AdministrarCertificados.certificadoPre.Producto == "1")
        {
            if (txtCedulaConyuge.Text != "")
            {
                txtPlanConyuge.Enabled = true;
            }
        }

        if (AdministrarCertificados.certificadoPre.Producto == "99" ||
        AdministrarCertificados.certificadoPre.Producto == "98" || AdministrarCertificados.certificadoPre.Producto == "2")
        {
            if (txtCedulaConyuge.Text != "")
            {
                ddlPlanConyuge.Enabled = true;
            }
        }
        if (AdministrarCertificados.certificadoPre.Producto == "3" || AdministrarCertificados.certificadoPre.Producto == "4"
                || AdministrarCertificados.certificadoPre.Producto == "9" || AdministrarCertificados.certificadoPre.Producto == "21")
        {
            ddlPlanConyuge.Enabled = true;
            txtPeso.Enabled = true;
            txtEstatura.Enabled = true;
        }
    }
    protected void btnValidarCertificado_Click(object sender, EventArgs e)
    {
        if (ddlLocalidadCertificado.SelectedValue != "" && ddlperiodoPagoCertificado.SelectedValue != "" && txtDeclaracionAsegurado.Text
           != "" && txtDeclaracionEG.Text != "")
        {
            btnSiguienteCertificado.Enabled = true;
            ddlLocalidadCertificado.Enabled = false;
            ddlPoliza.Enabled = false;
            txtDeclaracionEG.Enabled = false;
            txtDeclaracionAsegurado.Enabled = false;
            ddlperiodoPagoCertificado.Enabled = false;
            btnSiguientePrincipal.Enabled = false;
        }
        else
        {
            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
        }
    }

    protected void btnValidarPrincipal_Click(object sender, EventArgs e)
    {

        DataTable dtBeneficiario = (DataTable)Session["dtBeneficiario"];

        int total = 0;
        foreach (DataRow row in dtBeneficiario.Rows)
        {
            total = total + int.Parse(row["Porcentaje"].ToString());
        }
        if (total == 100)
        {
            if (AdministrarCertificados.certificadoPre.Migracion != "3" && AdministrarCertificados.certificadoPre.Migracion != "2")
            {
                if (AdministrarCertificados.certificadoPre.Producto == "1")
                {

                    if (ddlConvenioPrincipal.SelectedValue != "" && txtPlanPrincipal.Text != "")
                    {
                        btnSiguientePrincipal.Enabled = true;
                        ddlConvenioPrincipal.Enabled = false;
                        txtPlanPrincipal.Enabled = false;
                    }
                    else
                    {
                        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                    }
                }

                if (AdministrarCertificados.certificadoPre.Producto == "99" || AdministrarCertificados.certificadoPre.Producto == "2")
                {
                    if (ddlConvenioPrincipal.SelectedValue != "" && ddlPlanPrincipal.SelectedValue != "")
                    {
                        btnSiguientePrincipal.Enabled = true;
                        ddlConvenioPrincipal.Enabled = false;
                        ddlPlanPrincipal.Enabled = false;
                    }
                    else
                    {
                        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                    }
                }

                if (AdministrarCertificados.certificadoPre.Producto == "3")
                {
                    if (ddlConvenioPrincipal.SelectedValue != "" && txtPlanPrincipal.Text != "" && txtpesoPrincipal.Text != ""
                        && txtestaturaPrincipal.Text != "")
                    {
                        double indiceMasaCorporal = 0;
                        indiceMasaCorporal = AdministrarCertificados.CalcularIndiceDeMasaCorporal(double.Parse(txtpesoPrincipal.Text.ToString()), double.Parse(txtestaturaPrincipal.Text.ToString()));
                        if (indiceMasaCorporal < 18 || indiceMasaCorporal > 31)
                        {
                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                        }
                        else
                        {
                            btnSiguientePrincipal.Enabled = true;
                            ddlConvenioPrincipal.Enabled = false;
                            txtPlanPrincipal.Enabled = false;
                            txtpesoPrincipal.Enabled = false;
                            txtestaturaPrincipal.Enabled = false;
                        }
                    }
                    else
                    {
                        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                    }
                }

                if (AdministrarCertificados.certificadoPre.Producto == "9" || AdministrarCertificados.certificadoPre.Producto == "98"
                    || AdministrarCertificados.certificadoPre.Producto == "4" || AdministrarCertificados.certificadoPre.Producto == "21")
                {
                    if (ddlConvenioPrincipal.SelectedValue != "" && ddlPlanPrincipal.SelectedValue != "" && txtpesoPrincipal.Text != ""
                        && txtestaturaPrincipal.Text != "")
                    {
                        double indiceMasaCorporal = 0;
                        indiceMasaCorporal = AdministrarCertificados.CalcularIndiceDeMasaCorporal(double.Parse(txtpesoPrincipal.Text.ToString()), double.Parse(txtestaturaPrincipal.Text.ToString()));
                        if (AdministrarCertificados.certificadoPre.Producto == "9")
                        {
                            if (indiceMasaCorporal < 18 || indiceMasaCorporal > 37)
                            {
                                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                            }
                            else
                            {
                                btnSiguientePrincipal.Enabled = true;
                                ddlConvenioPrincipal.Enabled = false;
                                ddlPlanPrincipal.Enabled = false;
                                txtpesoPrincipal.Enabled = false;
                                txtestaturaPrincipal.Enabled = false;
                            }
                        }
                        if (AdministrarCertificados.certificadoPre.Producto == "98")
                        {
                            if (indiceMasaCorporal < 18 || indiceMasaCorporal > 37)
                            {
                                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                            }
                            else
                            {
                                btnSiguientePrincipal.Enabled = true;
                                ddlConvenioPrincipal.Enabled = false;
                                ddlPlanPrincipal.Enabled = false;
                                txtpesoPrincipal.Enabled = false;
                                txtestaturaPrincipal.Enabled = false;
                            }
                        }
                        if (AdministrarCertificados.certificadoPre.Producto == "4")
                        {

                            if (indiceMasaCorporal < 20 || indiceMasaCorporal > 30)
                            {
                                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                            }
                            else
                            {
                                btnSiguientePrincipal.Enabled = true;
                                ddlConvenioPrincipal.Enabled = false;
                                ddlPlanPrincipal.Enabled = false;
                                txtpesoPrincipal.Enabled = false;
                                txtestaturaPrincipal.Enabled = false;
                            }

                        }
                        if (AdministrarCertificados.certificadoPre.Producto == "21")
                        {
                            if (indiceMasaCorporal < 18 || indiceMasaCorporal > 31)
                            {
                                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                            }
                            else
                            {
                                btnSiguientePrincipal.Enabled = true;
                                ddlConvenioPrincipal.Enabled = false;
                                ddlPlanPrincipal.Enabled = false;
                                txtpesoPrincipal.Enabled = false;
                                txtestaturaPrincipal.Enabled = false;
                            }
                        }
                    }
                    else
                    {
                        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                    }
                }
            }
            else
            {
                btnSiguientePrincipal.Enabled = true;
            }
        }
        else
        {
            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "LOS BENEFICIARIOS DEL ASEGURADO PRINCIPAL NO SUMAN EL 100%" + "');", true);
        }
    }

    protected void btnValidarConyuge_Click(object sender, EventArgs e)
    {
        int cer_IdNuevo = 0;
        cer_IdNuevo = AdministrarCertificados.ConsultarIdCertificado(int.Parse(Session["ter_Id"].ToString()), int.Parse(Session["pro_Id"].ToString()), "VIGENTE", "PRODUCCION NUEVA");

        DataTable dTcasespId = new DataTable();
        dTcasespId = AdministrarCertificados.ConsultarCasespIdNewCertificado(cer_IdNuevo);
        DataTable dtEliminarPrincipal = (DataTable)Session["dtEliminarPrincipal"];
        DataTable dtEliminarConyuge = (DataTable)Session["dtEliminarConyuge"];
        DataTable dtBeneficiarioConyuge = (DataTable)Session["dtBeneficiarioConyuge"];
        int totalBeneficiarioConyuge = 0;
        foreach (DataRow row in dtBeneficiarioConyuge.Rows)
        {
            if (row["Porcentaje"].ToString() != "")
                totalBeneficiarioConyuge = totalBeneficiarioConyuge + int.Parse(row["Porcentaje"].ToString());
        }

        if (totalBeneficiarioConyuge == 100)
        {

            if (int.Parse(dTcasespId.Rows[0]["casesp_Id"].ToString()) == 4 || int.Parse(dTcasespId.Rows[0]["casesp_Id"].ToString()) == 5 ||
                int.Parse(dTcasespId.Rows[0]["casesp_Id"].ToString()) == 6)
            {
                if (AdministrarCertificados.certificadoPre.Producto == "1")
                {

                    if (txtCedulaConyuge.Text != "")
                    {
                        if (txtPlanConyuge.Text != "")
                        {
                            btnSiguienteConyuge.Enabled = true;
                            txtPlanConyuge.Enabled = false;
                        }
                        else
                        {
                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                        }
                    }
                }
                if (AdministrarCertificados.certificadoPre.Producto == "99" || AdministrarCertificados.certificadoPre.Producto == "2")
                {
                    if (txtCedulaConyuge.Text != "")
                    {
                        if (ddlPlanConyuge.SelectedValue != "")
                        {
                            btnSiguienteConyuge.Enabled = true;
                            ddlPlanConyuge.Enabled = false;
                        }
                        else
                        {
                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                        }
                    }
                }
                if (AdministrarCertificados.certificadoPre.Producto == "3")
                {
                    if (txtCedulaConyuge.Text != "")
                    {
                        if (txtPlanConyuge.Text != "" && txtPeso.Text != "" && txtEstatura.Text != "")
                        {
                            double indiceMasaCorporal = 0;
                            indiceMasaCorporal = AdministrarCertificados.CalcularIndiceDeMasaCorporal(double.Parse(txtPeso.Text.ToString()), double.Parse(txtEstatura.Text.ToString()));
                            if (indiceMasaCorporal < 18 || indiceMasaCorporal > 31)
                            {
                                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                            }
                            else
                            {
                                btnSiguienteConyuge.Enabled = true;
                                txtPlanConyuge.Enabled = false;
                                txtPeso.Enabled = false;
                                txtEstatura.Enabled = false;
                            }
                        }
                        else
                        {
                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                        }
                    }
                }
                if (AdministrarCertificados.certificadoPre.Producto == "9" || AdministrarCertificados.certificadoPre.Producto == "98"
                    || AdministrarCertificados.certificadoPre.Producto == "4" || AdministrarCertificados.certificadoPre.Producto == "21")
                {
                    if (txtCedulaConyuge.Text != "")
                    {
                        if (ddlPlanConyuge.Text != "" && txtPeso.Text != "" && txtEstatura.Text != "")
                        {
                            double indiceMasaCorporal = 0;
                            indiceMasaCorporal = AdministrarCertificados.CalcularIndiceDeMasaCorporal(double.Parse(txtPeso.Text.ToString()), double.Parse(txtEstatura.Text.ToString()));
                            if (AdministrarCertificados.certificadoPre.Producto == "9")
                            {
                                if (indiceMasaCorporal < 18 || indiceMasaCorporal > 37)
                                {


                                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                }
                                else
                                {
                                    btnSiguienteConyuge.Enabled = true;
                                    ddlPlanConyuge.Enabled = false;
                                    txtPeso.Enabled = false;
                                    txtEstatura.Enabled = false;
                                }
                            }
                            if (AdministrarCertificados.certificadoPre.Producto == "98")
                            {
                                if (indiceMasaCorporal < 18 || indiceMasaCorporal > 37)
                                {


                                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                }
                                else
                                {
                                    btnSiguienteConyuge.Enabled = true;
                                    ddlPlanConyuge.Enabled = false;
                                    txtPeso.Enabled = false;
                                    txtEstatura.Enabled = false;
                                }
                            }
                            if (AdministrarCertificados.certificadoPre.Producto == "4")
                            {
                                if (indiceMasaCorporal < 20 || indiceMasaCorporal > 30)
                                {


                                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                }
                                else
                                {
                                    btnSiguienteConyuge.Enabled = true;
                                    ddlPlanConyuge.Enabled = false;
                                    txtPeso.Enabled = false;
                                    txtEstatura.Enabled = false;
                                }
                            }
                            if (AdministrarCertificados.certificadoPre.Producto == "21")
                            {
                                if (indiceMasaCorporal < 18 || indiceMasaCorporal > 31)
                                {


                                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                }
                                else
                                {
                                    btnSiguienteConyuge.Enabled = true;
                                    ddlPlanConyuge.Enabled = false;
                                    txtPeso.Enabled = false;
                                    txtEstatura.Enabled = false;
                                }
                            }
                        }
                        else
                        {
                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                        }
                    }
                }
            }

            else
            {
                if (AdministrarCertificados.certificadoPre.Producto == "1" || AdministrarCertificados.certificadoPre.Producto == "3")
                {
                    if (int.Parse(txtPlanPrincipal.Text) >= int.Parse(txtPlanConyuge.Text))
                    {

                        if (AdministrarCertificados.certificadoPre.Producto == "1")
                        {

                            if (txtCedulaConyuge.Text != "")
                            {
                                if (txtPlanConyuge.Text != "")
                                {
                                    btnSiguienteConyuge.Enabled = true;
                                    txtPlanConyuge.Enabled = false;
                                }
                                else
                                {
                                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                                }
                            }
                        }
                        if (AdministrarCertificados.certificadoPre.Producto == "99" || AdministrarCertificados.certificadoPre.Producto == "2")
                        {
                            if (txtCedulaConyuge.Text != "")
                            {
                                if (ddlPlanConyuge.SelectedValue != "")
                                {
                                    btnSiguienteConyuge.Enabled = true;
                                    ddlPlanConyuge.Enabled = false;
                                }
                                else
                                {
                                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                                }
                            }
                        }
                        if (AdministrarCertificados.certificadoPre.Producto == "3")
                        {
                            if (txtCedulaConyuge.Text != "")
                            {
                                if (txtPlanConyuge.Text != "" && txtPeso.Text != "" && txtEstatura.Text != "")
                                {
                                    double indiceMasaCorporal = 0;
                                    indiceMasaCorporal = AdministrarCertificados.CalcularIndiceDeMasaCorporal(double.Parse(txtPeso.Text.ToString()), double.Parse(txtEstatura.Text.ToString()));
                                    if (indiceMasaCorporal < 18 || indiceMasaCorporal > 31)
                                    {
                                        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                    }
                                    else
                                    {
                                        btnSiguienteConyuge.Enabled = true;
                                        txtPlanConyuge.Enabled = false;
                                        txtPeso.Enabled = false;
                                        txtEstatura.Enabled = false;
                                    }
                                }
                                else
                                {
                                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                                }
                            }
                        }
                        if (AdministrarCertificados.certificadoPre.Producto == "9" || AdministrarCertificados.certificadoPre.Producto == "98"
                            || AdministrarCertificados.certificadoPre.Producto == "4" || AdministrarCertificados.certificadoPre.Producto == "21")
                        {
                            if (txtCedulaConyuge.Text != "")
                            {
                                if (ddlPlanConyuge.Text != "" && txtPeso.Text != "" && txtEstatura.Text != "")
                                {
                                    double indiceMasaCorporal = 0;
                                    indiceMasaCorporal = AdministrarCertificados.CalcularIndiceDeMasaCorporal(double.Parse(txtPeso.Text.ToString()), double.Parse(txtEstatura.Text.ToString()));
                                    if (AdministrarCertificados.certificadoPre.Producto == "9")
                                    {
                                        if (indiceMasaCorporal < 18 || indiceMasaCorporal > 37)
                                        {


                                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                        }
                                        else
                                        {
                                            btnSiguienteConyuge.Enabled = true;
                                            ddlPlanConyuge.Enabled = false;
                                            txtPeso.Enabled = false;
                                            txtEstatura.Enabled = false;
                                        }
                                    }
                                    if (AdministrarCertificados.certificadoPre.Producto == "98")
                                    {
                                        if (indiceMasaCorporal < 18 || indiceMasaCorporal > 37)
                                        {


                                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                        }
                                        else
                                        {
                                            btnSiguienteConyuge.Enabled = true;
                                            ddlPlanConyuge.Enabled = false;
                                            txtPeso.Enabled = false;
                                            txtEstatura.Enabled = false;
                                        }
                                    }
                                    if (AdministrarCertificados.certificadoPre.Producto == "4")
                                    {
                                        if (indiceMasaCorporal < 20 || indiceMasaCorporal > 30)
                                        {


                                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                        }
                                        else
                                        {
                                            btnSiguienteConyuge.Enabled = true;
                                            ddlPlanConyuge.Enabled = false;
                                            txtPeso.Enabled = false;
                                            txtEstatura.Enabled = false;
                                        }
                                    }
                                    if (AdministrarCertificados.certificadoPre.Producto == "21")
                                    {
                                        if (indiceMasaCorporal < 18 || indiceMasaCorporal > 31)
                                        {


                                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                        }
                                        else
                                        {
                                            btnSiguienteConyuge.Enabled = true;
                                            ddlPlanConyuge.Enabled = false;
                                            txtPeso.Enabled = false;
                                            txtEstatura.Enabled = false;
                                        }
                                    }
                                }
                                else
                                {
                                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                                }
                            }
                        }
                    }

                    else
                    {
                        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL CONYUGE NO PUEDE TENER  UN VALOR ASEGURADO MAYOR AL DEL PRINCIPAL" + "');", true);
                    }
                }
                else
                {
                    if (int.Parse(ddlPlanPrincipal.SelectedItem.ToString()) >= int.Parse(ddlPlanConyuge.SelectedItem.ToString()))
                    {

                        if (AdministrarCertificados.certificadoPre.Producto == "1")
                        {

                            if (txtCedulaConyuge.Text != "")
                            {
                                if (txtPlanConyuge.Text != "")
                                {
                                    btnSiguienteConyuge.Enabled = true;
                                    txtPlanConyuge.Enabled = false;
                                }
                                else
                                {
                                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                                }
                            }
                        }
                        if (AdministrarCertificados.certificadoPre.Producto == "99" || AdministrarCertificados.certificadoPre.Producto == "2")
                        {
                            if (txtCedulaConyuge.Text != "")
                            {
                                if (ddlPlanConyuge.SelectedValue != "")
                                {
                                    btnSiguienteConyuge.Enabled = true;
                                    ddlPlanConyuge.Enabled = false;
                                }
                                else
                                {
                                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                                }
                            }
                        }
                        if (AdministrarCertificados.certificadoPre.Producto == "3")
                        {
                            if (txtCedulaConyuge.Text != "")
                            {
                                if (txtPlanConyuge.Text != "" && txtPeso.Text != "" && txtEstatura.Text != "")
                                {
                                    double indiceMasaCorporal = 0;
                                    indiceMasaCorporal = AdministrarCertificados.CalcularIndiceDeMasaCorporal(double.Parse(txtPeso.Text.ToString()), double.Parse(txtEstatura.Text.ToString()));
                                    if (indiceMasaCorporal < 18 || indiceMasaCorporal > 31)
                                    {
                                        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                    }
                                    else
                                    {
                                        btnSiguienteConyuge.Enabled = true;
                                        txtPlanConyuge.Enabled = false;
                                        txtPeso.Enabled = false;
                                        txtEstatura.Enabled = false;
                                    }
                                }
                                else
                                {
                                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                                }
                            }
                        }
                        if (AdministrarCertificados.certificadoPre.Producto == "9" || AdministrarCertificados.certificadoPre.Producto == "98"
                            || AdministrarCertificados.certificadoPre.Producto == "4" || AdministrarCertificados.certificadoPre.Producto == "21")
                        {
                            if (txtCedulaConyuge.Text != "")
                            {
                                if (ddlPlanConyuge.Text != "" && txtPeso.Text != "" && txtEstatura.Text != "")
                                {
                                    double indiceMasaCorporal = 0;
                                    indiceMasaCorporal = AdministrarCertificados.CalcularIndiceDeMasaCorporal(double.Parse(txtPeso.Text.ToString()), double.Parse(txtEstatura.Text.ToString()));
                                    if (AdministrarCertificados.certificadoPre.Producto == "9")
                                    {
                                        if (indiceMasaCorporal < 18 || indiceMasaCorporal > 37)
                                        {


                                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                        }
                                        else
                                        {
                                            btnSiguienteConyuge.Enabled = true;
                                            ddlPlanConyuge.Enabled = false;
                                            txtPeso.Enabled = false;
                                            txtEstatura.Enabled = false;
                                        }
                                    }
                                    if (AdministrarCertificados.certificadoPre.Producto == "98")
                                    {
                                        if (indiceMasaCorporal < 18 || indiceMasaCorporal > 37)
                                        {


                                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                        }
                                        else
                                        {
                                            btnSiguienteConyuge.Enabled = true;
                                            ddlPlanConyuge.Enabled = false;
                                            txtPeso.Enabled = false;
                                            txtEstatura.Enabled = false;
                                        }
                                    }
                                    if (AdministrarCertificados.certificadoPre.Producto == "4")
                                    {
                                        if (indiceMasaCorporal < 20 || indiceMasaCorporal > 30)
                                        {


                                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                        }
                                        else
                                        {
                                            btnSiguienteConyuge.Enabled = true;
                                            ddlPlanConyuge.Enabled = false;
                                            txtPeso.Enabled = false;
                                            txtEstatura.Enabled = false;
                                        }
                                    }
                                    if (AdministrarCertificados.certificadoPre.Producto == "21")
                                    {
                                        if (indiceMasaCorporal < 18 || indiceMasaCorporal > 31)
                                        {


                                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
                                        }
                                        else
                                        {
                                            btnSiguienteConyuge.Enabled = true;
                                            ddlPlanConyuge.Enabled = false;
                                            txtPeso.Enabled = false;
                                            txtEstatura.Enabled = false;
                                        }
                                    }
                                }
                                else
                                {
                                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                                }
                            }
                        }
                    }

                    else
                    {
                        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL CONYUGE NO PUEDE TENER  UN VALOR ASEGURADO MAYOR AL DEL PRINCIPAL" + "');", true);
                    }
                }
            }
        }
        else
        {
            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "LOS BENEFICIARIOS DEL ASEGURADO CONYUGE NO SUMAN EL 100%" + "');", true);
        }

    }



    //protected void btnValidarConyuge_Click(object sender, EventArgs e)
    //{
    //    DataTable dtEliminarPrincipal = (DataTable)Session["dtEliminarPrincipal"];
    //    DataTable dtEliminarConyuge = (DataTable)Session["dtEliminarConyuge"];
    //    DataTable dtBeneficiarioConyuge = (DataTable)Session["dtBeneficiarioConyuge"];
    //    int totalBeneficiarioConyuge = 0;
    //    foreach (DataRow row in dtBeneficiarioConyuge.Rows)
    //    {
    //        if (row["Porcentaje"].ToString() != "")
    //            totalBeneficiarioConyuge = totalBeneficiarioConyuge + int.Parse(row["Porcentaje"].ToString());
    //    }

    //    if (totalBeneficiarioConyuge == 100)
    //    {
    //        if (int.Parse(ddlPlanPrincipal.SelectedItem.ToString()) >= int.Parse(ddlPlanConyuge.SelectedItem.ToString()))
    //        {
    //            if (AdministrarCertificados.certificadoPre.Producto == "1")
    //            {

    //                if (txtCedulaConyuge.Text != "")
    //                {
    //                    if (txtPlanConyuge.Text != "")
    //                    {
    //                        btnSiguienteConyuge.Enabled = true;
    //                        txtPlanConyuge.Enabled = false;
    //                    }
    //                    else
    //                    {
    //                        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
    //                    }
    //                }
    //            }
    //            if (AdministrarCertificados.certificadoPre.Producto == "99" || AdministrarCertificados.certificadoPre.Producto == "2")
    //            {
    //                if (txtCedulaConyuge.Text != "")
    //                {
    //                    if (ddlPlanConyuge.SelectedValue != "")
    //                    {
    //                        btnSiguienteConyuge.Enabled = true;
    //                        ddlPlanConyuge.Enabled = false;
    //                    }
    //                    else
    //                    {
    //                        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
    //                    }
    //                }
    //            }
    //            if (AdministrarCertificados.certificadoPre.Producto == "3")
    //            {
    //                if (txtCedulaConyuge.Text != "")
    //                {
    //                    if (txtPlanConyuge.Text != "" && txtPeso.Text != "" && txtEstatura.Text != "")
    //                    {
    //                        double indiceMasaCorporal = 0;
    //                        indiceMasaCorporal = AdministrarCertificados.CalcularIndiceDeMasaCorporal(double.Parse(txtPeso.Text.ToString()), double.Parse(txtEstatura.Text.ToString()));
    //                        if (indiceMasaCorporal < 18 || indiceMasaCorporal > 31)
    //                        {
    //                            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
    //                        }
    //                        else
    //                        {
    //                            btnSiguienteConyuge.Enabled = true;
    //                            txtPlanConyuge.Enabled = false;
    //                            txtPeso.Enabled = false;
    //                            txtEstatura.Enabled = false;
    //                        }
    //                    }
    //                    else
    //                    {
    //                        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
    //                    }
    //                }
    //            }
    //            if (AdministrarCertificados.certificadoPre.Producto == "9" || AdministrarCertificados.certificadoPre.Producto == "98"
    //                || AdministrarCertificados.certificadoPre.Producto == "4" || AdministrarCertificados.certificadoPre.Producto == "21")
    //            {
    //                if (txtCedulaConyuge.Text != "")
    //                {
    //                    if (ddlPlanConyuge.Text != "" && txtPeso.Text != "" && txtEstatura.Text != "")
    //                    {
    //                        double indiceMasaCorporal = 0;
    //                        indiceMasaCorporal = AdministrarCertificados.CalcularIndiceDeMasaCorporal(double.Parse(txtPeso.Text.ToString()), double.Parse(txtEstatura.Text.ToString()));
    //                        if (AdministrarCertificados.certificadoPre.Producto == "9")
    //                        {
    //                            if (indiceMasaCorporal < 18 || indiceMasaCorporal > 37)
    //                            {


    //                                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
    //                            }
    //                            else
    //                            {
    //                                btnSiguienteConyuge.Enabled = true;
    //                                ddlPlanConyuge.Enabled = false;
    //                                txtPeso.Enabled = false;
    //                                txtEstatura.Enabled = false;
    //                            }
    //                        }
    //                        if (AdministrarCertificados.certificadoPre.Producto == "98")
    //                        {
    //                            if (indiceMasaCorporal < 18 || indiceMasaCorporal > 37)
    //                            {


    //                                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
    //                            }
    //                            else
    //                            {
    //                                btnSiguienteConyuge.Enabled = true;
    //                                ddlPlanConyuge.Enabled = false;
    //                                txtPeso.Enabled = false;
    //                                txtEstatura.Enabled = false;
    //                            }
    //                        }
    //                        if (AdministrarCertificados.certificadoPre.Producto == "4")
    //                        {
    //                            if (indiceMasaCorporal < 20 || indiceMasaCorporal > 30)
    //                            {


    //                                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
    //                            }
    //                            else
    //                            {
    //                                btnSiguienteConyuge.Enabled = true;
    //                                ddlPlanConyuge.Enabled = false;
    //                                txtPeso.Enabled = false;
    //                                txtEstatura.Enabled = false;
    //                            }
    //                        }
    //                        if (AdministrarCertificados.certificadoPre.Producto == "21")
    //                        {
    //                            if (indiceMasaCorporal < 18 || indiceMasaCorporal > 31)
    //                            {


    //                                ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL INDICE DE MASA CORPORAL DE ESTA PERSONA NO ES ASEGURABLE" + "');", true);
    //                            }
    //                            else
    //                            {
    //                                btnSiguienteConyuge.Enabled = true;
    //                                ddlPlanConyuge.Enabled = false;
    //                                txtPeso.Enabled = false;
    //                                txtEstatura.Enabled = false;
    //                            }
    //                        }
    //                    }
    //                    else
    //                    {
    //                        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
    //                    }
    //                }
    //            }
    //        }
    //        else
    //        {
    //            ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "EL CONYUGE NO PUEDE TENER MAS AMPAROS QUE EL PRINCIPAL" + "');", true);
    //        }
    //    }
    //    else
    //    {
    //        ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "LOS BENEFICIARIOS DEL ASEGURADO CONYUGE NO SUMAN EL 100%" + "');", true);
    //    }

    //}
    protected void btnValidarOtroAsegurado_Click(object sender, EventArgs e)
    {
        if ((string)Session["operacionCertificado"] != "modificar")
        {
            if (txtCedulaOtro.Text != "")
            {
                if (ddlPlanOtros.SelectedValue != "" && ddlParentesoOtro.SelectedValue != "")
                {
                    ddlPlanOtros.Enabled = false;
                    ddlParentesoOtro.Enabled = true;
                }
                else
                {
                    ClientScript.RegisterStartupScript(GetType(), "alert", "alert('" + "FALTAN CAMPOS POR LLENAR" + "');", true);
                }
            }
        }
    }
    protected void btnCambiosPreCargue_Click(object sender, EventArgs e)
    {
        if (txtAnexoConversion.Text != "")
            txtAnexoConversion.Enabled = true;

        if (txtHServicio1.Text != "")
            txtHServicio1.Enabled = true;

        if (txtHServicio2.Text != "")
            txtHServicio2.Enabled = true;

        if (txtHServicio3.Text != "")
            txtHServicio3.Enabled = true;

        if (txtAnexoConversion.Text != "" || txtHServicio1.Text != "" || txtHServicio2.Text != "" || txtHServicio3.Text != "")
            btnGuardarCambios.Enabled = true;

        ////////////////////////////////////////////////////////Validacion de campos pre cargue/////////////////////////////////

        if (btnGuardarCambios.Enabled == true)
            btnValidarCertificado.Enabled = false;


        if (txtHServicio1.Text == "")
            ReqtxtHServicio1.Enabled = false;

        if (txtHServicio2.Text == "")
            reqtxtHServicio2.Enabled = false;

        if (txtHServicio3.Text == "")
            reqtxtHServicio3.Enabled = false;

        if (txtAnexoConversion.Text == "")
            reqtxtAnexoConversion.Enabled = false;

        if (btnGuardarCambios.Enabled == false)
            btnValidarCertificado.Enabled = true;
    }
    protected void btnGuardarCambios_Click(object sender, EventArgs e)
    {
        txtAnexoConversion.Enabled = false;
        txtHServicio1.Enabled = false;
        txtHServicio2.Enabled = false;
        txtHServicio3.Enabled = false;
        btnGuardarCambios.Enabled = false;

        ActualizarCertificadoPreCargado();

    }

    protected int CanceladoPorFechaRetiro()
    {
        DataTable dtCertificadoFull = (DataTable)Session["dtCertificadoFull"];
        //DateTime fechaRecuperacion = AdministrarCertificados.CertificadoRecuperado(dtCertificadoFull, int.Parse(Session["pro_Id"].ToString()));        
        bool existeFechaRetiro = true;
        DateTime vigenciaFechaRetiro = new DateTime();
        try
        {
            vigenciaFechaRetiro = DateTime.Parse(dtCertificadoFull.Rows[0]["FechaCartaRetiro"].ToString());
        }
        catch { existeFechaRetiro = false; }

        int estado = 0;
        if (existeFechaRetiro == true)
        {
            if (DateTime.Parse(txtFechaExpedicionCertificado.Text) < vigenciaFechaRetiro)
            {
                // Está Cancelado
                estado = 1;
            }
        }
        return estado;
    }

    protected int CertificadoRecuperado()
    {
        DataTable dtCertificadoFull = (DataTable)Session["dtCertificadoFull"];
        bool existeFechaMaxRec = true;
        DateTime fechaMaximaRecuperacion = new DateTime();
        try
        {
            fechaMaximaRecuperacion = DateTime.Parse(dtCertificadoFull.Rows[0]["FechaMaximaRecuperacion"].ToString());
        }
        catch
        {
            existeFechaMaxRec = false;
        }
        int estado = 0;
        if (existeFechaMaxRec == true)
        {
            if (DateTime.Parse(txtFechaExpedicionCertificado.Text) < fechaMaximaRecuperacion)
            {
                // Certificado Recuperado
                estado = 1;
            }
        }
        return estado;
    }
    // GRACIAS A ESTE METODO SE PUEDE LLENAR EL DROPDOWNLIST QUE SE ENCUENTRA EN EL GRID DE BENEFICIARIOS PRINCIPAL 
    protected void grvBeneficiarioPrincipal_OnDataBound(object sender, EventArgs e)
    {

        //DropDownList ddlNewParentesco = ((DropDownList)grvBeneficiarioPrincipal.FindControl("txtNewParentesco"));

        DropDownList ddl = grvBeneficiarioPrincipal.FooterRow.FindControl("txtNewParentesco") as DropDownList;

        //DropDownList ddl = (DropDownList)e.Row.TemplateControl.FindControl("txtNewParentesco");


        // SE CONSULTAN EN ESTAS LINEAS DE CODIGO EL PRODUCTO QUE POSEE EL CERTIFICADO
        int cer_Id = int.Parse(Session["cer_id"].ToString());
        DataTable dtEncabezadoCertificado = new DataTable();
        dtEncabezadoCertificado = AdministrarCertificados.spConsultarEncabezadoCertificado(cer_Id);

        //SE CONSULTAN LOS PARENTESCOS QUE PERMITE TENER ESTE PRODUCTO
        DataTable dtconsultarParentescoBeneficiarioPrincipal = new DataTable();
        dtconsultarParentescoBeneficiarioPrincipal = AdministrarCertificados.consultarParentescoBeneficiario(int.Parse(dtEncabezadoCertificado.Rows[0]["pro_Id"].ToString()));

        // SE LLENA DROPDAWNLIST CON SU RESPECTIVA INFORMACIÓN
        ddl.DataSource = dtconsultarParentescoBeneficiarioPrincipal;
        ddl.DataValueField = dtconsultarParentescoBeneficiarioPrincipal.Columns["par_Id"].ToString();
        ddl.DataTextField = dtconsultarParentescoBeneficiarioPrincipal.Columns["par_Nombre"].ToString();
        ddl.DataBind();
        ddl.Items.Insert(0, new ListItem("ssss", "0"));
        ddl.Attributes.Add("onclick", "localStorage.setItem('accIndex', 0);");

    }

    protected void grvBeneficiarioConyuge_OnDataBound(object sender, EventArgs e)
    {
        try
        {
            //DropDownList ddlNewParentesco = ((DropDownList)grvBeneficiarioPrincipal.FindControl("txtNewParentesco"));

            DropDownList ddl = grvBeneficiarioConyuge.FooterRow.FindControl("ddlNewParentesco") as DropDownList;

            //DropDownList ddl = (DropDownList)e.Row.TemplateControl.FindControl("txtNewParentesco");


            // SE CONSULTAN EN ESTAS LINEAS DE CODIGO EL PRODUCTO QUE POSEE EL CERTIFICADO
            int cer_Id = int.Parse(Session["cer_id"].ToString());
            DataTable dtEncabezadoCertificado = new DataTable();
            dtEncabezadoCertificado = AdministrarCertificados.spConsultarEncabezadoCertificado(cer_Id);

            //SE CONSULTAN LOS PARENTESCOS QUE PERMITE TENER ESTE PRODUCTO
            DataTable dtconsultarParentescoBeneficiarioPrincipal = new DataTable();
            dtconsultarParentescoBeneficiarioPrincipal = AdministrarCertificados.consultarParentescoBeneficiario(int.Parse(dtEncabezadoCertificado.Rows[0]["pro_Id"].ToString()));

            // SE LLENA DROPDAWNLIST CON SU RESPECTIVA INFORMACIÓN
            ddl.DataSource = dtconsultarParentescoBeneficiarioPrincipal;
            ddl.DataValueField = dtconsultarParentescoBeneficiarioPrincipal.Columns["par_Id"].ToString();
            ddl.DataTextField = dtconsultarParentescoBeneficiarioPrincipal.Columns["par_Nombre"].ToString();
            ddl.DataBind();
            ddl.Items.Insert(0, new ListItem("ssss", "0"));
            ddl.Attributes.Add("onclick", "localStorage.setItem('accIndex', 0);");
        }
        catch { }
    }
    // este boton tiene la funcion de restaurar la tabla de extra prima conyuge cuando se observe algun error cometido
    protected void btnX_Click(object sender, EventArgs e)
    {
        double valorExtraPrimado = 0;
        double totalExtraPrimaP = 0;
        double totalP = 0;
        double totalP3 = 0;

        // Session que funciona como una bandera para realizar una operación posterior a esta 
        Session["dtExtraprimaPrincipalRestaurar3"] = 1;

        // En este dt se almacena la información incicial para la restauración
        DataTable dtExtraprimaPrincipalRestaurar2 = new DataTable();
        dtExtraprimaPrincipalRestaurar2 = (DataTable)Session["dtExtraprimaPrincipalRestaurar"];
        grvAmparoExtraPrima.DataSource = dtExtraprimaPrincipalRestaurar2;
        grvAmparoExtraPrima.DataBind();

        Session["dtExtraprimaPrincipalRestaurar2"] = dtExtraprimaPrincipalRestaurar2;
        Session["dtExtraPrimaPrincipalGuardarFinal"] = dtExtraprimaPrincipalRestaurar2;

        //Consultar el historial del cliente en los certificados anteriores
        DataTable dtConsultarHistorialExtraPrima = new DataTable();
        dtConsultarHistorialExtraPrima = AdministrarCertificados.ConsultarHistorialExtraPrima(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 1);
        grvHistorialExtraPrima.DataSource = dtConsultarHistorialExtraPrima;
        grvHistorialExtraPrima.DataBind();

        double consultarHistorialExtraPrima = 0;
        double valorExtraPrima = 0;

        // foreach para recorrer el dt con la informacion almacenada anteriormente
        //e ir sumando las primas que se encuentran dentro de ellas en una variable
        if (dtConsultarHistorialExtraPrima.Rows.Count > 0)
        {
            foreach (DataRow dtConsultarHistorialExtraPrimaForeach in dtConsultarHistorialExtraPrima.Rows)
            {
                consultarHistorialExtraPrima += double.Parse(dtConsultarHistorialExtraPrimaForeach["Prima"].ToString());
                valorExtraPrima += double.Parse(dtConsultarHistorialExtraPrimaForeach["Extra Prima"].ToString());
            }
        }

        //foreach que reccorre la tabla de extra primas con la diferencia para ir sumando las primas 
        foreach (DataRow dt in dtExtraprimaPrincipalRestaurar2.Rows)
        {
            valorExtraPrimado += double.Parse(dt[3].ToString());
        }

        //encontra el aumento por extra prima
        totalExtraPrimaP = double.Parse(Session["TotalExtraPrimaP"].ToString());
        if (valorExtraPrimado != 0)
        {
            totalP = valorExtraPrimado - totalExtraPrimaP;
        }

        // asignar valores
        totalP3 = totalP;
        totalP3 = valorExtraPrima + totalP3;
        txtPrincipalExtraprima.Text = totalP3.ToString();

        txtExtraPrimaPrincipal.Text = txtPrincipalExtraprima.Text;

        sumarPrima();
    }

    // este boton tiene la funcion de restaurar la tabla de extra prima conyuge cuando se observe algun error cometido
    protected void btnX2_Click(object sender, EventArgs e)
    {

        double totalExtraPrimaC = 0;
        double totalExtraPrimaC3 = 0;
        double valorExtraPrimado = 0;
        double totalC = 0;

        // Session que funciona como una bandera para realizar una operación posterior a esta 
        Session["dtExtraprimaConyugeRestaurar3"] = 1;

        // En este dt se almacena la información incicial para la restauración
        DataTable dtExtraprimaConyugeRestaurar2 = new DataTable();
        dtExtraprimaConyugeRestaurar2 = (DataTable)Session["dtExtraprimaConyugeRestaurar"];
        grvExtraPrimaConyuge.DataSource = dtExtraprimaConyugeRestaurar2;
        grvExtraPrimaConyuge.DataBind();

        Session["dtExtraprimaPrincipalRestaurar2"] = dtExtraprimaConyugeRestaurar2;
        Session["dtExtraPrimaConyugeGuardarFinal"] = dtExtraprimaConyugeRestaurar2;


        //Consultar el historial del cliente en los certificados anteriores
        DataTable dtConsultarHistorialExtraPrimaConyuge = new DataTable();
        dtConsultarHistorialExtraPrimaConyuge = AdministrarCertificados.ConsultarHistorialExtraPrima(int.Parse(Session["cer_IdAnteriorExtraPrima"].ToString()), 2);
        grvHistorialExtraPrimaConyuge.DataSource = dtConsultarHistorialExtraPrimaConyuge;
        grvHistorialExtraPrimaConyuge.DataBind();

        double consultarHistorialExtraPrimaConyuge = 0;
        double valorExtraPrimaConyuge = 0;

        // foreach para recorrer el dt con la informacion almacenada anteriormente
        //e ir sumando las primas que se encuentran dentro de ellas en una variable
        if (dtConsultarHistorialExtraPrimaConyuge.Rows.Count > 0)
        {
            foreach (DataRow dtConsultarHistorialExtraPrimaForeachConyuge in dtConsultarHistorialExtraPrimaConyuge.Rows)
            {
                consultarHistorialExtraPrimaConyuge += double.Parse(dtConsultarHistorialExtraPrimaForeachConyuge["Prima"].ToString());
                valorExtraPrimaConyuge += double.Parse(dtConsultarHistorialExtraPrimaForeachConyuge["Extra Prima"].ToString());
            }
        }

        //foreach que reccorre la tabla de extra primas con la diferencia para ir sumando las primas 
        foreach (DataRow dt in dtExtraprimaConyugeRestaurar2.Rows)
        {
            valorExtraPrimado += Convert.ToDouble(dt[3].ToString());
        }

        //encontra el aumento por extra prima
        totalExtraPrimaC = double.Parse(Session["TotalExtraPrimaC"].ToString());
        if (totalExtraPrimaC != 0)
        {
            totalC = valorExtraPrimado - totalExtraPrimaC;
        }

        // asignar valores
        totalExtraPrimaC3 = totalC;
        totalExtraPrimaC3 = valorExtraPrimaConyuge + totalC;
        txtPrincipalExtraprimaConyuge.Text = totalExtraPrimaC3.ToString();

        txtExtraPrimaConyuge.Text = txtPrincipalExtraprimaConyuge.Text;

    }
}